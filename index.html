<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installer Portal - Firebase System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
    <style>
        /* Mobile-first design */
        .mobile-first { font-size: 16px; }
        @media (max-width: 640px) {
            .mobile-first { font-size: 18px; }
            .job-card { padding: 16px; }
            .btn { padding: 16px 20px; font-size: 18px; min-height: 48px; }
            .job-title { font-size: 20px; }
            .job-info { font-size: 16px; }
            .header { padding: 12px 16px; }
            .main-content { padding: 16px; }
        }
        .job-card { transition: all 0.3s ease; }
        .job-card:active { transform: scale(0.98); }
        .camera-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            min-height: 48px;
            font-size: 16px;
        }
        .camera-btn:active { transform: scale(0.95); }
        /* Mobile button layout */
        .job-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .job-actions button {
            padding: 12px 8px;
            font-size: 14px;
            min-height: 44px;
        }
        @media (max-width: 640px) {
            .job-actions {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .job-actions button {
                font-size: 16px;
                padding: 14px 12px;
            }
            
            /* Mobile calendar styling */
            #weekView {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            #weekView > div {
                min-width: 80px !important;
            }
            
            /* Mobile search results */
            .search-result-card {
                padding: 16px !important;
            }
            
            /* Mobile availability calendar */
            #availabilityCalendar {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            #availabilityCalendar .grid-cols-7 {
                min-width: 600px;
            }
        }
        /* Modal z-index fixes */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
        }
        .modal-content {
            position: relative;
            z-index: 100000;
        }
    </style>
</head>
<body class="bg-gray-100 mobile-first">
    <div id="app" class="min-h-screen">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen bg-blue-600">
            <div class="text-center text-white">
                <div class="text-4xl mb-4">üîß</div>
                <div class="text-xl">Loading Installer Portal...</div>
                <div class="text-sm opacity-75 mt-2">Connecting to Firebase...</div>
            </div>
        </div>

        <!-- Main Portal (Hidden Initially) -->
        <div id="portal" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-50">
                <div class="max-w-4xl mx-auto px-4 py-3">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">üîß</div>
                            <div>
                                <h1 class="text-lg font-bold text-gray-900">Installer Portal</h1>
                                <div class="text-xs text-gray-600">Firebase Operations System</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="installerName" class="text-sm font-medium text-gray-700"></span>
                            <button onclick="logout()" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-4xl mx-auto px-4 py-6">
                <!-- Installer Info -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-blue-600 font-medium">Current Installer</div>
                            <div id="installerInfo" class="text-lg font-bold text-blue-900"></div>
                        </div>
                        <div class="text-right">
                            <button onclick="openAvailabilityModal()" class="px-3 py-2 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                üìÖ My Availability
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Weekly Navigation -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">üìÖ My Schedule</h2>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousWeek()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                ‚Üê Previous
                            </button>
                            <span id="weekRange" class="text-sm font-medium text-gray-600"></span>
                            <button onclick="nextWeek()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                Next ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- One-line Week View -->
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                        <div class="flex space-x-2 overflow-x-auto pb-2" id="weekView">
                            <!-- Week days will be populated here -->
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                        <div class="relative">
                            <input type="text" id="jobSearch" placeholder="üîç Search jobs by customer, address, or job ID..." 
                                   class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="searchJobs()" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                                üîç
                            </button>
                        </div>
                    </div>

                    <!-- Search Results (hidden by default) -->
                    <div id="searchResults" class="hidden mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Search Results</h3>
                        <div id="searchResultsList" class="space-y-3">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Job Completion Modal -->
    <div id="completionModal" class="modal-overlay hidden" style="z-index: 999999;">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6 modal-content" style="z-index: 1000000;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Complete Job</h3>
                    <button onclick="closeCompletionModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <form onsubmit="submitJobCompletion(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Completion Status</label>
                        <select id="completionStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select completion status...</option>
                            <option value="completed-ready-inspection-balance-collected">Completed - Ready For Inspection (Balance Collected)</option>
                            <option value="completed-ready-inspection-no-balance">Completed - Ready For Inspection (No Balance Collected)</option>
                            <option value="not-complete-multiday">Not Complete MultiDay</option>
                            <option value="not-collected-issues">Not Collected - Issues With Install</option>
                        </select>
                    </div>
                    <div id="balanceNoteSection" class="hidden mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Balance Note (Required)</label>
                        <textarea id="balanceNote" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                    <div id="issuesSection" class="hidden mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Issue Details</label>
                        <textarea id="issueDetails" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Describe the installation issues..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Work Notes (Optional)</label>
                        <textarea id="workNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Any additional notes about the work completed..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                        Submit Completion
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Photo Manager Modal -->
    <div id="photoModal" class="modal-overlay hidden" style="z-index: 999999;">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6 modal-content" style="z-index: 1000000;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Photo Manager</h3>
                    <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <div id="photoModalContent">
                    <!-- Photo manager content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="jobModal" class="modal-overlay hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6 modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Job Details</h3>
                    <button onclick="closeJobModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <div id="modalContent">
                    <!-- Job details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Availability Modal -->
    <div id="availabilityModal" class="modal-overlay hidden" style="z-index: 999999;">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full p-6 modal-content" style="z-index: 1000000;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">My Availability</h3>
                    <button onclick="closeAvailabilityModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <div id="availabilityCalendar">
                    <!-- Calendar will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <!-- Issue Report Modal -->
    <div id="issueModal" class="modal-overlay hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6 modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Report Issue</h3>
                    <button onclick="closeIssueModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <form onsubmit="submitIssue(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job</label>
                        <select id="issueJobId" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select Job...</option>
                        </select>
                    </div>
                    
                    <!-- Unit Selection -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit Type</label>
                            <select id="unitType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select...</option>
                                <option value="window">Window</option>
                                <option value="door">Door</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit Designation</label>
                            <input type="text" id="unitDesignation" placeholder="e.g., 1, 2, A, B" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <!-- Window/Door Specifics -->
                    <div id="windowDetails" class="hidden mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Window Type</label>
                                <select id="windowType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">Select...</option>
                                    <option value="double-hung">Double Hung</option>
                                    <option value="casement">Casement</option>
                                    <option value="slider">Slider</option>
                                    <option value="picture">Picture</option>
                                    <option value="bay">Bay</option>
                                    <option value="awning">Awning</option>
                                    <option value="hopper">Hopper</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Size (W x H)</label>
                                <input type="text" id="windowSize" placeholder="e.g., 36x48" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <div id="doorDetails" class="hidden mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Door Type</label>
                                <select id="doorType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">Select...</option>
                                    <option value="entry">Entry Door</option>
                                    <option value="patio">Patio Door</option>
                                    <option value="french">French Door</option>
                                    <option value="sliding">Sliding Door</option>
                                    <option value="storm">Storm Door</option>
                                    <option value="garage">Garage Door</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Size (W x H)</label>
                                <input type="text" id="doorSize" placeholder="e.g., 36x80" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defect Category</label>
                        <select id="defectCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select defect type...</option>
                            <option value="incorrect-measurement">Incorrect Measurement</option>
                            <option value="incorrect-window-type">Incorrect Window Type</option>
                            <option value="wrong-size">Wrong Size Ordered</option>
                            <option value="manufacturer-defect">Manufacturer Defect</option>
                            <option value="shipping-damage">Shipping Damage</option>
                            <option value="installation-error">Installation Error</option>
                            <option value="missing-hardware">Missing Hardware</option>
                            <option value="glass-defect">Glass Defect</option>
                            <option value="frame-damage">Frame Damage</option>
                            <option value="color-mismatch">Color Mismatch</option>
                            <option value="hardware-failure">Hardware Failure</option>
                            <option value="weather-seal">Weather Seal Issue</option>
                            <option value="other">Other (Specify)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="issueDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                                  placeholder="Describe the issue in detail..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                        <input type="file" id="issuePhotos" multiple accept="image/*" class="w-full">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" onclick="closeIssueModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            Submit Issue
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_ACTUAL_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase with error handling
        let auth, db, storage;
        
        // Force demo mode by not initializing Firebase
        console.log('Forcing demo mode - Firebase not configured');
        auth = null;
        db = null;
        storage = null;

        // State
        let currentWeekOffset = 0;
        let installerData = null;
        let jobs = [];
        let jobsUnsubscribe = null;
        let currentUser = null;
        let userRole = null; // 'installer' or 'admin'

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userType = document.getElementById('userType').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log(`Login attempt: ${userType} - ${email}`);
            
            // Demo mode - accept any credentials
            currentUser = {
                uid: userType === 'admin' ? 'admin-123' : 'demo-user-123',
                email: email,
                displayName: userType === 'admin' ? 'Admin User' : 'John Smith',
                role: userType
            };
            
            userRole = userType;
            
            if (userType === 'admin') {
                await adminLogin();
            } else {
                await installerLogin();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Installer Portal - Firebase System');
            console.log('DOM Content Loaded - starting initialization...');
            
            // Show login screen first
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Check if Firebase is available (for future use)
            if (!db || !auth) {
                console.log('Firebase not available, using demo mode');
                return;
            }
            
            console.log('Firebase is available, checking auth...');
            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    await loadInstallerData(user);
                    await loadJobs();
                    showPortal();
                } else {
                    // Show login screen
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            });
        });

        // Handle completion status change
        document.addEventListener('DOMContentLoaded', function() {
            const completionStatus = document.getElementById('completionStatus');
            if (completionStatus) {
                completionStatus.addEventListener('change', function() {
                    const balanceNoteSection = document.getElementById('balanceNoteSection');
                    const issuesSection = document.getElementById('issuesSection');
                    const balanceNote = document.getElementById('balanceNote');
                    const issueDetails = document.getElementById('issueDetails');
                    
                    // Reset sections
                    balanceNoteSection.classList.add('hidden');
                    issuesSection.classList.add('hidden');
                    balanceNote.required = false;
                    issueDetails.required = false;
                    
                    // Show relevant sections
                    if (this.value === 'completed-ready-inspection-no-balance') {
                        balanceNoteSection.classList.remove('hidden');
                        balanceNote.required = true;
                    } else if (this.value === 'not-collected-issues') {
                        issuesSection.classList.remove('hidden');
                        issueDetails.required = true;
                    }
                });
            }
        });

        // Handle unit type change for issue form
        document.addEventListener('DOMContentLoaded', function() {
            const unitTypeSelect = document.getElementById('unitType');
            if (unitTypeSelect) {
                unitTypeSelect.addEventListener('change', function() {
                    const unitType = this.value;
                    const windowDetails = document.getElementById('windowDetails');
                    const doorDetails = document.getElementById('doorDetails');
                    
                    if (unitType === 'window') {
                        windowDetails.classList.remove('hidden');
                        doorDetails.classList.add('hidden');
                    } else if (unitType === 'door') {
                        doorDetails.classList.remove('hidden');
                        windowDetails.classList.add('hidden');
                    } else {
                        windowDetails.classList.add('hidden');
                        doorDetails.classList.add('hidden');
                    }
                });
            }
        });

        // Admin login
        async function adminLogin() {
            console.log('=== STARTING ADMIN LOGIN ===');
            
            // Create admin data
            installerData = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                role: 'admin',
                crews: ['All Crews'],
                active: true
            };
            
            console.log('Admin data created:', installerData);
            
            // Load all installers and jobs for admin view
            await loadAllInstallers();
            await loadAllJobs();
            
            // Update UI for admin
            document.getElementById('installerName').textContent = installerData.name + ' (Admin)';
            document.getElementById('installerInfo').textContent = installerData.name + ' - Administrator';
            
            // Show admin dashboard
            renderAdminDashboard();
            
            console.log('=== ADMIN LOGIN COMPLETED ===');
            showPortal();
        }

        // Installer login (existing function)
        async function installerLogin() {
            console.log('=== STARTING INSTALLER LOGIN ===');
            
            // Create installer data
            installerData = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                crews: ['Crew A', 'Crew B'],
                active: true
            };
            
            console.log('Installer data created:', installerData);
            
            // Load installer availability
            await loadInstallerAvailability();
            
            // Create demo jobs
            jobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew B',
                    notes: 'Remove old door frame, install new entry door'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal'
                }
            ];
            
            console.log('Demo jobs created:', jobs);
            
            // Update UI
            document.getElementById('installerName').textContent = installerData.name;
            document.getElementById('installerInfo').textContent = installerData.name;
            
            // Show installer dashboard
            renderInstallerDashboard();
            
            console.log('=== INSTALLER LOGIN COMPLETED ===');
            showPortal();
        }

        // Admin dashboard functions
        let allInstallers = [];
        
        async function loadAllInstallers() {
            // Demo mode - create sample installers
            allInstallers = [
                {
                    uid: 'demo-user-123',
                    name: 'John Smith',
                    email: 'john@company.com',
                    crews: ['Crew A', 'Crew B'],
                    active: true,
                    status: 'available'
                },
                {
                    uid: 'installer-456',
                    name: 'Mike Johnson',
                    email: 'mike@company.com',
                    crews: ['Crew B'],
                    active: true,
                    status: 'on-job'
                },
                {
                    uid: 'installer-789',
                    name: 'Sarah Davis',
                    email: 'sarah@company.com',
                    crews: ['Crew A'],
                    active: true,
                    status: 'available'
                }
            ];
            console.log('All installers loaded:', allInstallers);
        }
        
        async function loadAllJobs() {
            // Demo mode - create sample jobs for all installers
            jobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    installerId: 'demo-user-123',
                    installerName: 'John Smith',
                    notes: 'Install new double-hung windows'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    status: 'in-progress',
                    crew: 'Crew B',
                    installerId: 'installer-456',
                    installerName: 'Mike Johnson',
                    notes: 'Remove old door frame, install new entry door'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    status: 'completed',
                    crew: 'Crew A',
                    installerId: 'installer-789',
                    installerName: 'Sarah Davis',
                    notes: 'Fix broken window seal'
                }
            ];
            console.log('All jobs loaded:', jobs);
        }
        
        function renderAdminDashboard() {
            const mainContent = document.querySelector('main');
            mainContent.innerHTML = `
                <!-- Admin Header -->
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üëë Admin Dashboard</h2>
                    <p class="text-gray-600">Manage installers, jobs, and system settings</p>
                </div>
                
                <!-- Admin Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-blue-500">
                        <h3 class="font-semibold text-gray-900 mb-2">üë• Installer Management</h3>
                        <p class="text-sm text-gray-600 mb-3">Add, edit, and manage installer accounts</p>
                        <button onclick="showInstallerManagement()" class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            Manage Installers
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-green-500">
                        <h3 class="font-semibold text-gray-900 mb-2">üìÖ Job Assignment</h3>
                        <p class="text-sm text-gray-600 mb-3">Assign jobs to installers and manage scheduling</p>
                        <button onclick="showJobAssignment()" class="px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                            Assign Jobs
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-purple-500">
                        <h3 class="font-semibold text-gray-900 mb-2">üîß System Settings</h3>
                        <p class="text-sm text-gray-600 mb-3">Configure Teamup sync and system preferences</p>
                        <button onclick="showSystemSettings()" class="px-3 py-2 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                            Settings
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="text-2xl font-bold text-blue-600">${allInstallers.length}</div>
                        <div class="text-sm text-gray-600">Total Installers</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="text-2xl font-bold text-green-600">${allInstallers.filter(i => i.status === 'available').length}</div>
                        <div class="text-sm text-gray-600">Available</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="text-2xl font-bold text-orange-600">${allInstallers.filter(i => i.status === 'on-job').length}</div>
                        <div class="text-sm text-gray-600">On Job</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="text-2xl font-bold text-purple-600">${jobs.filter(j => j.status === 'scheduled').length}</div>
                        <div class="text-sm text-gray-600">Scheduled Jobs</div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">üìä Recent Activity</h3>
                    <div class="space-y-2">
                        ${jobs.slice(0, 5).map(job => `
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <div>
                                    <span class="font-medium">${job.id}</span>
                                    <span class="text-sm text-gray-600 ml-2">${job.customer}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="px-2 py-1 rounded text-xs ${
                                        job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                        job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${job.status.replace('-', ' ').toUpperCase()}
                                    </span>
                                    <span class="text-gray-500 ml-2">${job.installerName}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderInstallerDashboard() {
            // Show the regular installer dashboard
            renderWeekView();
            updateWeekRange();
        }
        
        // Admin management functions (placeholders for now)
        function showInstallerManagement() {
            alert('Installer Management - Coming Soon!');
        }
        
        function showJobAssignment() {
            alert('Job Assignment - Coming Soon!');
        }
        
        function showSystemSettings() {
            alert('System Settings - Coming Soon!');
        }
        async function loadInstallerData(user) {
            try {
                // Get installer document
                const installerDoc = await db.collection('installers').doc(user.uid).get();
                
                if (installerDoc.exists) {
                    installerData = installerDoc.data();
                } else {
                    // Create demo installer
                    installerData = {
                        uid: user.uid,
                        name: user.displayName || 'John Smith',
                        email: user.email,
                        crews: ['Crew A', 'Crew B'],
                        active: true
                    };
                    
                    // Save to Firestore
                    await db.collection('installers').doc(user.uid).set(installerData);
                }

                // Update UI
                document.getElementById('installerName').textContent = installerData.name;
                document.getElementById('installerInfo').textContent = installerData.name;
                document.getElementById('crewInfo').textContent = installerData.crews.join(', ');
                
                console.log('Installer data loaded:', installerData);
            } catch (error) {
                console.error('Failed to load installer data:', error);
                showError('Failed to load installer data');
            }
        }

        // Load jobs from Firestore with real-time updates
        async function loadJobs() {
            try {
                // Unsubscribe previous listener
                if (jobsUnsubscribe) {
                    jobsUnsubscribe();
                }

                // Query jobs for this installer
                const jobsQuery = db.collection('jobs')
                    .where('installerId', '==', installerData.uid)
                    .where('scheduledDate', '>=', new Date(Date.now() - (14 * 24 * 60 * 60 * 1000)))
                    .where('scheduledDate', '<=', new Date(Date.now() + (14 * 24 * 60 * 60 * 1000)))
                    .orderBy('scheduledDate');

                // Real-time listener
                jobsUnsubscribe = jobsQuery.onSnapshot((snapshot) => {
                    jobs = [];
                    snapshot.forEach((doc) => {
                        jobs.push({ id: doc.id, ...doc.data() });
                    });
                    renderWeekView();
                    updateWeekRange();
                });

                console.log('Jobs listener established');
            } catch (error) {
                console.error('Failed to load jobs:', error);
                showError('Failed to load jobs');
            }
        }

        // Render one-line week view
        function renderWeekView() {
            const weekView = document.getElementById('weekView');
            const today = new Date();
            const weekStart = new Date(today.getTime() + (currentWeekOffset * 7 * 24 * 60 * 60 * 1000));
            
            // Get installer's blocked dates
            const installerId = installerData?.uid || 'demo-user-123';
            const blockedDates = installerAvailability[installerId] || [];
            
            let weekHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(weekStart.getTime() + (i * 24 * 60 * 60 * 1000));
                const dateStr = currentDate.toISOString().split('T')[0];
                const isToday = currentDate.toDateString() === today.toDateString();
                const isBlocked = blockedDates.includes(dateStr);
                
                // Count jobs for this date
                const dayJobs = jobs.filter(job => {
                    const jobDate = new Date(job.scheduledDate).toISOString().split('T')[0];
                    return jobDate === dateStr;
                });
                
                const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = currentDate.getDate();
                
                let bgColor = 'bg-white';
                let borderColor = 'border-gray-200';
                let statusColor = 'text-gray-600';
                let availabilityIcon = '';
                
                if (isToday) {
                    bgColor = 'bg-blue-50';
                    borderColor = 'border-blue-300';
                    statusColor = 'text-blue-700';
                }
                
                if (isBlocked) {
                    availabilityIcon = '<div class="text-xs text-red-600">üö´</div>';
                }
                
                weekHTML += `
                    <div class="flex-shrink-0 w-20 sm:w-24 p-2 ${bgColor} border ${borderColor} rounded-lg cursor-pointer hover:shadow-md transition-shadow"
                         onclick="showDayDetails('${dateStr}')">
                        <div class="text-center">
                            <div class="text-xs font-medium ${statusColor}">${dayName}</div>
                            <div class="text-lg font-bold text-gray-900">${dayNumber}</div>
                            ${availabilityIcon}
                            <div class="mt-1 space-y-1">
                                ${dayJobs.map(job => `
                                    <div onclick="event.stopPropagation(); showJobDetails('${job.id}')" 
                                         class="text-xs p-1 rounded cursor-pointer hover:bg-gray-200 ${
                                             job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                             job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                                             'bg-gray-100 text-gray-800'
                                         }">
                                        ${job.id}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            weekView.innerHTML = weekHTML;
        }

        // Show day details when clicking on a day
        function showDayDetails(dateStr) {
            const dayJobs = jobs.filter(job => {
                const jobDate = new Date(job.scheduledDate).toISOString().split('T')[0];
                return jobDate === dateStr;
            });
            
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            searchResults.classList.remove('hidden');
            
            const selectedDate = new Date(dateStr);
            const dateLabel = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            if (dayJobs.length === 0) {
                searchResultsList.innerHTML = `
                    <div class="bg-white rounded-lg p-4 text-center text-gray-500">
                        <h3 class="font-semibold text-gray-900 mb-2">${dateLabel}</h3>
                        <p>No jobs scheduled for this date</p>
                    </div>
                `;
            } else {
                searchResultsList.innerHTML = `
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-semibold text-gray-900 mb-3">${dateLabel}</h3>
                        <div class="space-y-2">
                            ${dayJobs.map(job => `
                                <div onclick="showJobDetails('${job.id}')" class="bg-gray-50 rounded-lg shadow-sm p-3 border-l-4 cursor-pointer hover:shadow-md ${
                                    job.status === 'scheduled' ? 'border-blue-500' :
                                    job.status === 'in-progress' ? 'border-green-500' :
                                    'border-gray-500'
                                }">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <span class="font-semibold text-gray-900">${job.id}</span>
                                            <span class="text-sm text-gray-600 ml-2">${job.customer}</span>
                                            <div class="text-xs text-gray-500">${job.address}</div>
                                        </div>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                            job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                            job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                                            'bg-gray-100 text-gray-800'
                                        }">
                                            ${job.status.replace('-', ' ').toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Search jobs
        function searchJobs() {
            const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            
            if (!searchTerm) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const filteredJobs = jobs.filter(job => 
                job.title.toLowerCase().includes(searchTerm) ||
                job.customer.toLowerCase().includes(searchTerm) ||
                job.address.toLowerCase().includes(searchTerm) ||
                job.id.toLowerCase().includes(searchTerm)
            );
            
            searchResults.classList.remove('hidden');
            
            if (filteredJobs.length === 0) {
                searchResultsList.innerHTML = `
                    <div class="bg-white rounded-lg p-4 text-center text-gray-500">
                        No jobs found for "${searchTerm}"
                    </div>
                `;
            } else {
                searchResultsList.innerHTML = filteredJobs.map(job => `
                    <div onclick="showJobDetails('${job.id}')" class="bg-white rounded-lg shadow-sm p-3 border-l-4 cursor-pointer hover:shadow-md ${
                        job.status === 'scheduled' ? 'border-blue-500' :
                        job.status === 'in-progress' ? 'border-green-500' :
                        'border-gray-500'
                    }">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-semibold text-gray-900">${job.id}</span>
                                <span class="text-sm text-gray-600 ml-2">${job.customer}</span>
                                <div class="text-xs text-gray-500">${job.address}</div>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${job.status.replace('-', ' ').toUpperCase()}
                            </span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Get directions to job
        function getDirections(address) {
            const encodedAddress = encodeURIComponent(address);
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`, '_blank');
        }

        // Update job status in Firestore
        async function updateJobStatus(jobId, newStatus) {
            try {
                // Update local demo data first
                const job = jobs.find(j => j.id === jobId);
                if (job) {
                    job.status = newStatus;
                    console.log(`Local job ${jobId} status updated to: ${newStatus}`);
                }
                
                // Try to update in Firestore if available
                if (db) {
                    const jobRef = db.collection('jobs').doc(jobId);
                    
                    await jobRef.update({
                        status: newStatus,
                        statusUpdatedAt: new Date(),
                        statusUpdatedBy: installerData.uid
                    });

                    console.log(`Firestore job ${jobId} status updated to: ${newStatus}`);
                }
            } catch (error) {
                console.error('Failed to update job status:', error);
                showError('Failed to update job status');
            }
        }

        // Camera capture for specific job (mobile-first)
        function capturePhotoForJob(jobId, type) {
            console.log('Capturing photo for job:', jobId, 'type:', type);
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            // Force camera on mobile devices
            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone')) {
                input.capture = 'environment'; // Use rear camera
                input.setAttribute('capture', 'environment');
            }
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log(`Captured ${type} photo for job ${jobId}:`, file.name);
                    await uploadPhotoToFirebase(file, type, jobId);
                }
            };
            
            input.click();
        }

        // Upload photo to Firebase Storage
        async function uploadPhotoToFirebase(file, type, jobId) {
            try {
                const fileName = `${jobId}/${type}_${Date.now()}_${file.name}`;
                
                console.log(`Uploading ${type} photo:`, {
                    fileName: fileName,
                    fileSize: file.size,
                    fileType: file.type
                });
                
                // Demo mode - simulate upload
                if (firebaseConfig.apiKey === "YOUR_ACTUAL_API_KEY") {
                    // Demo mode
                    alert(`${type} photo captured successfully for job ${jobId}!\nFile: ${file.name}\nSize: ${(file.size / 1024).toFixed(1)} KB\n\n(Demo mode - not actually uploaded)`);
                    return;
                }
                
                // Real Firebase upload
                const storageRef = storage.ref();
                const photoRef = storageRef.child(`job-photos/${fileName}`);
                
                // Upload file
                const snapshot = await photoRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                // Save photo metadata to Firestore
                const photoData = {
                    type: type,
                    fileName: fileName,
                    downloadURL: downloadURL,
                    fileSize: file.size,
                    capturedAt: new Date().toISOString(),
                    jobId: jobId,
                    installerId: installerData.uid,
                    installerName: installerData.name,
                    metadata: {
                        device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
                        location: 'job_site',
                        category: type === 'defect' ? 'issue' : 'documentation'
                    }
                };
                
                await db.collection('photos').add(photoData);
                
                console.log('Photo uploaded successfully:', photoData);
                alert(`${type} photo uploaded successfully for job ${jobId}!`);
                
            } catch (error) {
                console.error('Failed to upload photo:', error);
                showError('Failed to upload photo');
            }
        }

        // Get current job ID (context)
        function getCurrentJobId() {
            // In real app, this would come from current job context
            return jobs.length > 0 ? jobs[0].id : 'CURRENT_JOB';
        }

        // Issue form handlers
        document.getElementById('unitType').addEventListener('change', function() {
            const unitType = this.value;
            const windowDetails = document.getElementById('windowDetails');
            const doorDetails = document.getElementById('doorDetails');
            
            if (unitType === 'window') {
                windowDetails.classList.remove('hidden');
                doorDetails.classList.add('hidden');
            } else if (unitType === 'door') {
                doorDetails.classList.remove('hidden');
                windowDetails.classList.add('hidden');
            } else {
                windowDetails.classList.add('hidden');
                doorDetails.classList.add('hidden');
            }
        });

        // Report issue to Firestore
        async function submitIssue(event) {
            event.preventDefault();
            
            try {
                const issueData = {
                    jobId: document.getElementById('issueJobId').value,
                    unitType: document.getElementById('unitType').value,
                    unitDesignation: document.getElementById('unitDesignation').value,
                    windowType: document.getElementById('windowType').value,
                    doorType: document.getElementById('doorType').value,
                    size: document.getElementById('unitType').value === 'window' ? 
                           document.getElementById('windowSize').value : 
                           document.getElementById('doorSize').value,
                    defectCategory: document.getElementById('defectCategory').value,
                    description: document.getElementById('issueDescription').value,
                    reportedAt: new Date(),
                    installerId: installerData.uid,
                    installerName: installerData.name,
                    status: 'open',
                    photos: []
                };
                
                console.log('Submitting issue:', issueData);
                
                // Handle photo uploads
                const photoFiles = document.getElementById('issuePhotos').files;
                for (let i = 0; i < photoFiles.length; i++) {
                    const file = photoFiles[i];
                    const fileName = `issues/${issueData.jobId}_${Date.now()}_${file.name}`;
                    
                    if (storage) {
                        // Real Firebase upload
                        const storageRef = storage.ref();
                        const photoRef = storageRef.child(fileName);
                        
                        await photoRef.put(file);
                        const downloadURL = await photoRef.getDownloadURL();
                        issueData.photos.push({
                            fileName: fileName,
                            downloadURL: downloadURL,
                            fileSize: file.size
                        });
                    } else {
                        // Demo mode
                        issueData.photos.push({
                            fileName: file.name,
                            fileSize: file.size,
                            demo: true
                        });
                    }
                }
                
                // Save to Firestore
                if (db) {
                    await db.collection('issues').add(issueData);
                    console.log('Issue saved to Firestore');
                } else {
                    console.log('Issue saved locally (demo mode):', issueData);
                }
                
                alert('Issue reported successfully!');
                closeIssueModal();
                
            } catch (error) {
                console.error('Failed to submit issue:', error);
                alert('Failed to report issue. Please try again.');
            }
        }

        // Job Completion Functions
        let currentCompletionJobId = null;

        function completeJobWithStatus(jobId) {
            currentCompletionJobId = jobId;
            const modal = document.getElementById('completionModal');
            modal.classList.remove('hidden');
        }

        function submitJobCompletion(event) {
            event.preventDefault();
            
            const completionStatus = document.getElementById('completionStatus').value;
            const balanceNote = document.getElementById('balanceNote').value;
            const issueDetails = document.getElementById('issueDetails').value;
            const workNotes = document.getElementById('workNotes').value;
            
            if (!completionStatus) {
                alert('Please select a completion status.');
                return;
            }
            
            // Validate required fields
            if (completionStatus === 'completed-ready-inspection-no-balance' && !balanceNote) {
                alert('Note is required when balance was not collected.');
                return;
            }
            
            if (completionStatus === 'not-collected-issues' && !issueDetails) {
                alert('Issue details are required when reporting installation problems.');
                return;
            }
            
            // Require note for any status that's not "Completed - Ready For Inspection (Collected)"
            if (completionStatus !== 'completed-ready-inspection-balance' && !workNotes) {
                alert('Work notes are required for this completion status.');
                return;
            }
            
            // Update job status with completion details
            updateJobStatusWithCompletion(currentCompletionJobId, completionStatus, {
                balanceNote: balanceNote,
                issueDetails: issueDetails,
                workNotes: workNotes,
                completedAt: new Date().toISOString()
            });
            
            closeCompletionModal();
            
            // Reopen job details to show updated status
            setTimeout(() => {
                showJobDetails(currentCompletionJobId);
            }, 200);
            
            alert('Job completion submitted successfully!');
        }

        async function updateJobStatusWithCompletion(jobId, completionStatus, details) {
            try {
                const jobRef = db.collection('jobs').doc(jobId);
                
                await jobRef.update({
                    status: completionStatus,
                    statusUpdatedAt: new Date(),
                    statusUpdatedBy: installerData.uid,
                    completionDetails: details
                });

                console.log(`Job ${jobId} completed with status: ${completionStatus}`);
            } catch (error) {
                console.error('Failed to update job status:', error);
                showError('Failed to update job status');
            }
        }

        function closeCompletionModal() {
            document.getElementById('completionModal').classList.add('hidden');
            // Reset form
            document.getElementById('completionStatus').value = '';
            document.getElementById('balanceNote').value = '';
            document.getElementById('issueDetails').value = '';
            document.getElementById('workNotes').value = '';
            document.getElementById('balanceNoteSection').classList.add('hidden');
            document.getElementById('issuesSection').classList.add('hidden');
            currentCompletionJobId = null;
        }

        // Handle completion status change
        document.addEventListener('DOMContentLoaded', function() {
            const completionStatus = document.getElementById('completionStatus');
            if (completionStatus) {
                completionStatus.addEventListener('change', function() {
                    const balanceNoteSection = document.getElementById('balanceNoteSection');
                    const issuesSection = document.getElementById('issuesSection');
                    const balanceNote = document.getElementById('balanceNote');
                    const issueDetails = document.getElementById('issueDetails');
                    
                    // Reset sections
                    balanceNoteSection.classList.add('hidden');
                    issuesSection.classList.add('hidden');
                    balanceNote.required = false;
                    issueDetails.required = false;
                    
                    // Show relevant sections
                    if (this.value === 'completed-ready-inspection-no-balance') {
                        balanceNoteSection.classList.remove('hidden');
                        balanceNote.required = true;
                    } else if (this.value === 'not-collected-issues') {
                        issuesSection.classList.remove('hidden');
                        issueDetails.required = true;
                    }
                });
            }
        });

        // Availability Functions
        let installerAvailability = {}; // Store blocked dates per installer
        let currentAvailabilityMonth = new Date();

        function openAvailabilityModal() {
            const modal = document.getElementById('availabilityModal');
            renderAvailabilityCalendar();
            modal.classList.remove('hidden');
        }

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').classList.add('hidden');
        }

        function renderAvailabilityCalendar() {
            const calendarDiv = document.getElementById('availabilityCalendar');
            const year = currentAvailabilityMonth.getFullYear();
            const month = currentAvailabilityMonth.getMonth();
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get installer's blocked dates
            const installerId = installerData?.uid || 'demo-user-123';
            const blockedDates = installerAvailability[installerId] || [];
            
            let calendarHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center">
                        <button onclick="previousMonth()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            ‚Üê Previous
                        </button>
                        <h4 class="text-lg font-semibold text-gray-900">
                            ${firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h4>
                        <button onclick="nextMonth()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            Next ‚Üí
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Sun</div>
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Mon</div>
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Tue</div>
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Wed</div>
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Thu</div>
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Fri</div>
                    <div class="text-center text-xs font-medium text-gray-600 py-2">Sat</div>
                </div>
                
                <div class="grid grid-cols-7 gap-1">
            `;
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isBlocked = blockedDates.includes(dateStr);
                const isPast = new Date(year, month, day) < new Date().setHours(0, 0, 0, 0);
                
                let bgColor = 'bg-white hover:bg-gray-50';
                let textColor = 'text-gray-900';
                let cursor = 'cursor-pointer';
                
                if (isPast) {
                    bgColor = 'bg-gray-100';
                    textColor = 'text-gray-400';
                    cursor = 'cursor-not-allowed';
                } else if (isBlocked) {
                    bgColor = 'bg-red-100 hover:bg-red-200';
                    textColor = 'text-red-700';
                } else {
                    bgColor = 'bg-green-100 hover:bg-green-200';
                    textColor = 'text-green-700';
                }
                
                calendarHTML += `
                    <div onclick="${!isPast ? `toggleDateAvailability('${dateStr}')` : ''}" 
                         class="p-2 text-center border rounded ${bgColor} ${textColor} ${cursor} text-sm font-medium">
                        ${day}
                        ${isBlocked ? '<div class="text-xs">üö´</div>' : !isPast ? '<div class="text-xs">‚úì</div>' : ''}
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            
            // Add legend
            calendarHTML += `
                <div class="mt-4 flex justify-center space-x-4 text-xs">
                    <div class="flex items-center space-x-1">
                        <div class="w-4 h-4 bg-green-100 border rounded"></div>
                        <span>Available</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-4 h-4 bg-red-100 border rounded"></div>
                        <span>Blocked</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-4 h-4 bg-gray-100 border rounded"></div>
                        <span>Past</span>
                    </div>
                </div>
            `;
            
            calendarDiv.innerHTML = calendarHTML;
        }

        function previousMonth() {
            currentAvailabilityMonth.setMonth(currentAvailabilityMonth.getMonth() - 1);
            renderAvailabilityCalendar();
        }

        function nextMonth() {
            currentAvailabilityMonth.setMonth(currentAvailabilityMonth.getMonth() + 1);
            renderAvailabilityCalendar();
        }

        function toggleDateAvailability(dateStr) {
            const installerId = installerData?.uid || 'demo-user-123';
            
            if (!installerAvailability[installerId]) {
                installerAvailability[installerId] = [];
            }
            
            const blockedDates = installerAvailability[installerId];
            const index = blockedDates.indexOf(dateStr);
            
            if (index > -1) {
                // Unblock the date
                blockedDates.splice(index, 1);
            } else {
                // Block the date
                blockedDates.push(dateStr);
            }
            
            // Save to Firebase
            saveInstallerAvailability();
            
            // Refresh calendar
            renderAvailabilityCalendar();
        }

        async function saveInstallerAvailability() {
            try {
                const installerId = installerData?.uid || 'demo-user-123';
                
                if (db) {
                    // Save to Firebase
                    await db.collection('installerAvailability').doc(installerId).set({
                        blockedDates: installerAvailability[installerId] || [],
                        updatedAt: new Date(),
                        installerId: installerId
                    });
                    console.log('Availability saved to Firebase');
                } else {
                    // Demo mode - save to localStorage
                    localStorage.setItem(`availability_${installerId}`, JSON.stringify(installerAvailability[installerId] || []));
                    console.log('Availability saved to localStorage:', installerAvailability[installerId]);
                }
            } catch (error) {
                console.error('Failed to save availability:', error);
            }
        }

        async function loadInstallerAvailability() {
            try {
                // Don't try to load from Firebase in demo mode
                if (!db) {
                    const installerId = installerData?.uid || 'demo-user-123';
                    // Load from localStorage
                    const saved = localStorage.getItem(`availability_${installerId}`);
                    if (saved) {
                        installerAvailability[installerId] = JSON.parse(saved);
                        console.log('Availability loaded from localStorage:', installerAvailability[installerId]);
                    } else {
                        installerAvailability[installerId] = [];
                        console.log('Demo mode - no availability data found, using empty array');
                    }
                    return;
                }
                
                const installerId = installerData?.uid || 'demo-user-123';
                
                // Load from Firebase
                const doc = await db.collection('installerAvailability').doc(installerId).get();
                if (doc.exists) {
                    installerAvailability[installerId] = doc.data().blockedDates || [];
                    console.log('Availability loaded from Firebase:', installerAvailability[installerId]);
                } else {
                    installerAvailability[installerId] = [];
                    console.log('No availability data found, using empty array');
                }
            } catch (error) {
                console.error('Failed to load availability:', error);
                const installerId = installerData?.uid || 'demo-user-123';
                installerAvailability[installerId] = [];
            }
        }
        let currentPhotoJobId = null;
        let requiredStartPhotos = ['front_elevation', 'sign_photo'];
        let requiredInspectionPhotos = ['before', 'bucking', 'screws_hanging', 'tape_over_screws', 'final_window', 'window_label', 'fasteners_set'];
        let capturedPhotos = {};
        let jobUnits = {}; // Store window/door counts per job

        function getPhotoCount(jobId) {
            // In real app, this would query Firestore
            // For demo, return total captured photos
            return Object.keys(capturedPhotos).length;
        }

        function openPhotoManager(jobId, phase = 'inspection') {
            currentPhotoJobId = jobId;
            const modal = document.getElementById('photoModal');
            const modalContent = document.getElementById('photoModalContent');
            
            const job = jobs.find(j => j.id === jobId);
            
            // Initialize job units if not exists
            if (!jobUnits[jobId]) {
                jobUnits[jobId] = {
                    windows: 3, // Default - should come from Teamup sync data
                    doors: 1    // Default - should come from Teamup sync data
                };
            }
            
            const units = jobUnits[jobId];
            
            const photoLabels = {
                'front_elevation': 'üì∏ Front Elevation',
                'sign_photo': 'üìã Sign Picture',
                'before': 'üì∏ Before Picture',
                'bucking': 'üì∏ Bucking Picture',
                'screws_hanging': 'üì∏ Screws Hanging Out of Holes',
                'tape_over_screws': 'üì∏ Tape Over Screws (Optional)',
                'final_window': 'üì∏ Final Window/Door Picture',
                'window_label': 'üì∏ Window/Door Label Picture',
                'fasteners_set': 'üì∏ All Fasteners Set in Place'
            };
            
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">${job.title}</h4>
                        <p class="text-sm text-gray-600 mb-4">${phase === 'start' ? 'Required photos to start work:' : 'Inspection photos required:'}</p>
                        
                        ${phase === 'inspection' ? `
                            <div class="bg-blue-50 p-3 rounded-lg mb-4">
                                <p class="text-sm font-medium text-blue-900">Job Units:</p>
                                <p class="text-sm text-blue-700">Windows: ${units.windows} (Numbered 1-${units.windows})</p>
                                <p class="text-sm text-blue-700">Doors: ${units.doors} (Lettered A-${String.fromCharCode(65 + units.doors - 1)})</p>
                            </div>
                            
                            <!-- Mobile-friendly unit selector -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Unit:</label>
                                <select id="unitSelector" onchange="updateSelectedUnit()" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">Choose a window or door...</option>
                                    ${generateUnitOptions(units)}
                                </select>
                            </div>
                            
                            <div id="selectedUnitPhotos" class="space-y-3">
                                <p class="text-sm text-gray-500 text-center py-4">Select a unit to see required photos</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-3">
                        ${phase === 'start' ? `
                            <!-- Start photos - one set for entire job -->
                            ${requiredStartPhotos.map(photoType => {
                                const isCaptured = capturedPhotos[photoType];
                                return `
                                    <div class="flex items-center justify-between p-3 border rounded-lg ${isCaptured ? 'bg-green-50 border-green-500' : 'bg-gray-50 border-gray-300'}">
                                        <div class="flex items-center space-x-3">
                                            <span class="${isCaptured ? 'text-green-600' : 'text-gray-600'}">
                                                ${isCaptured ? '‚úÖ' : '‚≠ï'}
                                            </span>
                                            <span class="text-sm font-medium">${photoLabels[photoType]}</span>
                                        </div>
                                        <button onclick="capturePhoto('${photoType}')" class="px-3 py-1 ${isCaptured ? 'bg-gray-300 text-gray-600' : 'bg-blue-600 text-white'} text-sm rounded hover:${isCaptured ? 'bg-gray-400' : 'bg-blue-700'}">
                                            ${isCaptured ? 'Retake' : 'Capture'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        ` : ''}
                    </div>
                    
                    <div class="pt-4 border-t">
                        ${phase === 'start' ? `
                            <button onclick="completeStartPhotos()" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 ${getRequiredPhotosCount('start') < requiredStartPhotos.length ? 'opacity-50 cursor-not-allowed' : ''}" 
                                    ${getRequiredPhotosCount('start') < requiredStartPhotos.length ? 'disabled' : ''}>
                                ${getRequiredPhotosCount('start') < requiredStartPhotos.length ? 
                                    `Complete Start Photos (${getRequiredPhotosCount('start')}/${requiredStartPhotos.length})` : 
                                    '‚úÖ Start Work'}
                            </button>
                        ` : `
                            <button onclick="completeInspectionPhotos()" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 ${getRequiredPhotosCount('inspection') < getRequiredInspectionCount() ? 'opacity-50 cursor-not-allowed' : ''}" 
                                    ${getRequiredPhotosCount('inspection') < getRequiredInspectionCount() ? 'disabled' : ''}>
                                ${getRequiredPhotosCount('inspection') < getRequiredInspectionCount() ? 
                                    `Complete Inspection Photos (${getRequiredPhotosCount('inspection')}/${getRequiredInspectionCount()})` : 
                                    '‚úÖ Complete Inspection'}
                            </button>
                        `}
                        <button onclick="closePhotoModal()" class="w-full mt-2 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function generateUnitOptions(units) {
            let options = '';
            
            // Add windows (numbered)
            for (let i = 1; i <= units.windows; i++) {
                options += `<option value="window_${i}">ü™ü Window ${i}</option>`;
            }
            
            // Add doors (lettered)
            for (let i = 0; i < units.doors; i++) {
                const letter = String.fromCharCode(65 + i); // A, B, C...
                options += `<option value="door_${letter}">üö™ Door ${letter}</option>`;
            }
            
            return options;
        }

        function updateSelectedUnit() {
            const selector = document.getElementById('unitSelector');
            const photosDiv = document.getElementById('selectedUnitPhotos');
            
            if (!selector.value) {
                photosDiv.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Select a unit to see required photos</p>';
                return;
            }
            
            const [unitType, unitIdentifier] = selector.value.split('_');
            const unitLabel = unitType === 'window' ? `ü™ü Window ${unitIdentifier}` : `üö™ Door ${unitIdentifier}`;
            
            const photoLabels = {
                'before': 'üì∏ Before Picture',
                'bucking': 'üì∏ Bucking Picture',
                'screws_hanging': 'üì∏ Screws Hanging Out of Holes',
                'tape_over_screws': 'üì∏ Tape Over Screws (Optional)',
                'final_window': 'üì∏ Final Window/Door Picture',
                'window_label': 'üì∏ Window/Door Label Picture',
                'fasteners_set': 'üì∏ All Fasteners Set in Place'
            };
            
            photosDiv.innerHTML = `
                <div class="bg-gray-50 p-3 rounded-lg">
                    <h5 class="font-medium text-gray-900 mb-3">${unitLabel}</h5>
                    <div class="space-y-2">
                        ${requiredInspectionPhotos.map(photoType => {
                            const photoKey = `${unitType}_${unitIdentifier}_${photoType}`;
                            const isCaptured = capturedPhotos[photoKey];
                            const isOptional = photoType === 'tape_over_screws';
                            
                            return `
                                <div class="flex items-center justify-between p-3 border rounded-lg ${isCaptured ? 'bg-green-50 border-green-500' : isOptional ? 'bg-yellow-50 border-yellow-300' : 'bg-white border-gray-300'}">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" ${isCaptured ? 'checked' : ''} onchange="togglePhotoOverride('${photoKey}')" class="mr-2">
                                        <span class="${isCaptured ? 'text-green-600' : isOptional ? 'text-yellow-600' : 'text-gray-600'} text-sm">
                                            ${isCaptured ? '‚úÖ' : isOptional ? '‚≠ï' : '‚≠ï'}
                                        </span>
                                        <span class="text-sm font-medium">${photoLabels[photoType]}</span>
                                        ${isOptional ? '<span class="text-xs text-yellow-600">(Optional)</span>' : ''}
                                    </div>
                                    <button onclick="captureUnitPhoto('${unitType}', '${unitIdentifier}', '${photoType}')" class="px-3 py-1 ${isCaptured ? 'bg-gray-300 text-gray-600' : 'bg-blue-600 text-white'} text-sm rounded hover:${isCaptured ? 'bg-gray-400' : 'bg-blue-700'}">
                                        ${isCaptured ? 'Retake' : 'Capture'}
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getRequiredPhotosCount(phase) {
            const requiredPhotos = phase === 'start' ? requiredStartPhotos : requiredInspectionPhotos;
            return requiredPhotos.filter(photoType => capturedPhotos[photoType]).length;
        }

        function getRequiredInspectionCount() {
            // Count only non-optional inspection photos
            return requiredInspectionPhotos.filter(photoType => photoType !== 'tape_over_screws').length;
        }

        function completeStartPhotos() {
            if (getRequiredPhotosCount('start') < requiredStartPhotos.length) {
                alert('Please capture all required start photos before starting work.');
                return;
            }
            
            // Update job status to in-progress
            updateJobStatus(currentPhotoJobId, 'in-progress');
            closePhotoModal();
            
            // Update the job details modal to reflect new status
            setTimeout(() => {
                showJobDetails(currentPhotoJobId);
            }, 200);
            
            alert('All required start photos captured! Job status updated to In-Progress.');
        }

        function completeInspectionPhotos() {
            if (getRequiredPhotosCount('inspection') < getRequiredInspectionCount()) {
                alert('Please capture all required inspection photos.');
                return;
            }
            
            closePhotoModal();
            alert('Inspection photos completed successfully!');
        }

        function capturePhoto(photoType) {
            console.log('Capturing photo:', photoType);
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            // Force camera on mobile devices
            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone')) {
                input.capture = 'environment';
                input.setAttribute('capture', 'environment');
            }
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log(`Captured ${photoType} photo:`, file.name);
                    
                    // Mark as captured
                    capturedPhotos[photoType] = {
                        fileName: file.name,
                        fileSize: file.size,
                        capturedAt: new Date().toISOString()
                    };
                    
                    // Upload to Firebase
                    await uploadPhotoToFirebase(file, photoType, currentPhotoJobId);
                    
                    // Refresh photo manager
                    const phase = requiredStartPhotos.includes(photoType) ? 'start' : 'inspection';
                    openPhotoManager(currentPhotoJobId, phase);
                }
            };
            
            input.click();
        }

        function captureUnitPhoto(unitType, unitIdentifier, photoType) {
            const photoKey = `${unitType}_${unitIdentifier}_${photoType}`;
            console.log('Capturing unit photo:', photoKey);
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            // Force camera on mobile devices
            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone')) {
                input.capture = 'environment';
                input.setAttribute('capture', 'environment');
            }
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log(`Captured ${photoKey} photo:`, file.name);
                    
                    // Mark as captured
                    capturedPhotos[photoKey] = {
                        fileName: file.name,
                        fileSize: file.size,
                        capturedAt: new Date().toISOString(),
                        unitType: unitType,
                        unitIdentifier: unitIdentifier,
                        photoType: photoType
                    };
                    
                    // Upload to Firebase
                    await uploadPhotoToFirebase(file, photoKey, currentPhotoJobId);
                    
                    // Refresh photo manager
                    openPhotoManager(currentPhotoJobId, 'inspection');
                }
            };
            
            input.click();
        }

        function togglePhotoOverride(photoKey) {
            console.log('Toggling override for:', photoKey);
            if (capturedPhotos[photoKey]) {
                delete capturedPhotos[photoKey];
            } else {
                // Mark as overridden (not required)
                capturedPhotos[photoKey] = {
                    overridden: true,
                    capturedAt: new Date().toISOString()
                };
            }
            
            // Refresh photo manager
            openPhotoManager(currentPhotoJobId, 'inspection');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            // Don't reset capturedPhotos to keep progress
            // Don't clear currentPhotoJobId to maintain context
        }

        function startJobWithPhotos(jobId) {
            currentPhotoJobId = jobId;
            capturedPhotos = {};
            console.log('Starting job with photos for:', jobId);
            
            // Don't close job details - keep it open for workflow
            setTimeout(() => {
                openPhotoManager(jobId, 'start');
            }, 100);
        }

        function openCompletionModal(jobId) {
            currentCompletionJobId = jobId;
            console.log('Opening completion modal for job:', jobId);
            
            // Check if required photos are captured
            const requiredPhotosCount = getRequiredPhotosCount('inspection');
            const requiredInspectionCount = getRequiredInspectionCount();
            
            if (requiredPhotosCount < requiredInspectionCount) {
                alert(`Please capture all required inspection photos (${requiredPhotosCount}/${requiredInspectionCount}) before completing the job.`);
                return;
            }
            
            // Close job details first to prevent stacking issues
            closeJobModal();
            
            // Use setTimeout to ensure job details is fully closed
            setTimeout(() => {
                const modal = document.getElementById('completionModal');
                console.log('Completion modal element:', modal);
                console.log('Completion modal classes:', modal.className);
                modal.classList.remove('hidden');
                console.log('Completion modal should now be visible');
            }, 200);
        }
        function showPortal() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('portal').classList.remove('hidden');
        }

        function showJobDetails(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;
            
            console.log('showJobDetails called for job:', jobId, 'current status:', job.status);
            
            const modal = document.getElementById('jobModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <!-- Job Info -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">${job.title}</h4>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div><i class="fas fa-user mr-1"></i><strong>Customer:</strong> ${job.customer}</div>
                            <div><i class="fas fa-map-marker-alt mr-1"></i><strong>Address:</strong> ${job.address}</div>
                            <div><i class="fas fa-clock mr-1"></i><strong>Scheduled:</strong> ${new Date(job.scheduledDate).toLocaleString()}</div>
                            <div><i class="fas fa-users mr-1"></i><strong>Crew:</strong> ${job.crew}</div>
                            ${job.notes ? `<div><i class="fas fa-sticky-note mr-1"></i><strong>Notes:</strong> ${job.notes}</div>` : ''}
                        </div>
                    </div>

                    <!-- Status Actions -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status Actions</label>
                        <div class="flex space-x-2">
                            ${job.status === 'scheduled' ? `
                                <button onclick="startJobWithPhotos('${job.id}')" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                    üöÄ Start Job
                                </button>
                            ` : ''}
                            ${job.status === 'in-progress' ? `
                                <button onclick="openCompletionModal('${job.id}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                    ‚úÖ Complete Job
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="getDirections('${job.address}')" class="px-3 py-2 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                üó∫Ô∏è Directions
                            </button>
                            <button onclick="reportIssueForJob('${job.id}')" class="px-3 py-2 bg-orange-600 text-white text-sm rounded hover:bg-orange-700">
                                üö® Report Issue
                            </button>
                        </div>
                    </div>

                    <!-- Photo Management -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                        <button onclick="openPhotoManager('${job.id}')" class="w-full px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            üì∏ Manage Photos (${getPhotoCount(job.id)} taken)
                        </button>
                    </div>

                    <!-- Close -->
                    <div class="pt-4 border-t">
                        <button onclick="closeJobModal()" class="w-full px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeJobModal() {
            document.getElementById('jobModal').classList.add('hidden');
        }

        // Report issue for specific job
        function reportIssueForJob(jobId) {
            const modal = document.getElementById('issueModal');
            const jobIdSelect = document.getElementById('issueJobId');
            
            // Set the specific job
            jobIdSelect.innerHTML = `<option value="${jobId}">${jobs.find(j => j.id === jobId)?.title || jobId}</option>`;
            jobIdSelect.value = jobId;
            
            modal.classList.remove('hidden');
        }

        function closeIssueModal() {
            document.getElementById('issueModal').classList.add('hidden');
            // Reset form
            document.getElementById('issueJobId').value = '';
            document.getElementById('issueCategory').value = 'manufacturer';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issuePhotos').value = '';
        }

        function previousWeek() {
            currentWeekOffset--;
            renderWeekView();
            updateWeekRange();
        }

        function nextWeek() {
            currentWeekOffset++;
            renderWeekView();
            updateWeekRange();
        }

        function updateWeekRange() {
            const today = new Date();
            const weekStart = new Date(today.getTime() + (currentWeekOffset * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + (6 * 24 * 60 * 60 * 1000));
            
            document.getElementById('weekRange').textContent = 
                `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
        }

        function showError(message) {
            alert(`Error: ${message}`);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }
    </script>
</body>
</html>
