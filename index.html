<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installer Portal - Firebase System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
    <style>
        /* Mobile-first design */
        .mobile-first { font-size: 16px; }
        @media (max-width: 640px) {
            .mobile-first { font-size: 18px; }
            .job-card { padding: 16px; }
            .btn { padding: 16px 20px; font-size: 18px; min-height: 48px; }
            .job-title { font-size: 20px; }
            .job-info { font-size: 16px; }
            .header { padding: 12px 16px; }
            .main-content { padding: 16px; }
        }
        .job-card { transition: all 0.3s ease; }
        .job-card:active { transform: scale(0.98); }
        .camera-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            min-height: 48px;
            font-size: 16px;
        }
        .camera-btn:active { transform: scale(0.95); }
        /* Mobile button layout */
        .job-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .job-actions button {
            padding: 12px 8px;
            font-size: 14px;
            min-height: 44px;
        }
        @media (max-width: 640px) {
            .job-actions {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .job-actions button {
                font-size: 16px;
                padding: 14px 12px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 mobile-first">
    <div id="app" class="min-h-screen">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen bg-blue-600">
            <div class="text-center text-white">
                <div class="text-4xl mb-4">üîß</div>
                <div class="text-xl">Loading Installer Portal...</div>
                <div class="text-sm opacity-75 mt-2">Connecting to Firebase...</div>
            </div>
        </div>

        <!-- Main Portal (Hidden Initially) -->
        <div id="portal" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-50">
                <div class="max-w-4xl mx-auto px-4 py-3">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">üîß</div>
                            <div>
                                <h1 class="text-lg font-bold text-gray-900">Installer Portal</h1>
                                <div class="text-xs text-gray-600">Firebase Operations System</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="installerName" class="text-sm font-medium text-gray-700"></span>
                            <button onclick="logout()" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-4xl mx-auto px-4 py-6">
                <!-- Installer Info -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-blue-600 font-medium">Current Installer</div>
                            <div id="installerInfo" class="text-lg font-bold text-blue-900"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-blue-600 font-medium">Crew Assignment</div>
                            <div id="crewInfo" class="text-lg font-bold text-blue-900"></div>
                        </div>
                    </div>
                </div>

                <!-- Jobs Section -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900">üìÖ My Jobs</h2>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousWeek()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                ‚Üê
                            </button>
                            <span id="weekRange" class="text-sm font-medium text-gray-600"></span>
                            <button onclick="nextWeek()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Jobs List -->
                    <div id="jobsList" class="space-y-4">
                        <!-- Jobs will be populated here -->
                    </div>

                    <!-- No Jobs Message -->
                    <div id="noJobs" class="hidden bg-white rounded-lg p-8 text-center">
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-xl font-semibold text-gray-700 mb-2">No Jobs Scheduled</div>
                        <div class="text-gray-600">You have no jobs assigned for this period.</div>
                    </div>
                </div>

                <!-- Quick Actions - REMOVED (moved to job cards) -->
            </main>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="jobModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Job Details</h3>
                    <button onclick="closeJobModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <div id="modalContent">
                    <!-- Job details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Report Modal -->
    <div id="issueModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Report Issue</h3>
                    <button onclick="closeIssueModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <form onsubmit="submitIssue(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job</label>
                        <select id="issueJobId" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select Job...</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="issueCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="manufacturer">Manufacturer Defect</option>
                            <option value="installer">Installer Mistake</option>
                            <option value="material">Missing Material</option>
                            <option value="damage">Damage Discovered</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="issueDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                        <input type="file" id="issuePhotos" multiple accept="image/*" class="w-full">
                    </div>
                    <button type="submit" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700">
                        Submit Issue
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYFdyiz_T_0Tsqya_CSKS4wRlWOEckMGk",
            authDomain: "installer-portal-6000.firebaseapp.com",
            projectId: "installer-portal-6000",
            storageBucket: "installer-portal-6000.firebasestorage.app",
            messagingSenderId: "582559700006",
            appId: "1:582559700006:web:e3b795dcf17501e310c2e7",
            measurementId: "G-93D62ZGLEJ"
        };

        // Initialize Firebase with error handling
        let auth, db, storage;
        
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            // Set to null for demo mode
            auth = null;
            db = null;
            storage = null;
        }

        // State
        let currentWeekOffset = 0;
        let installerData = null;
        let jobs = [];
        let jobsUnsubscribe = null;
        
        // TeamUp Configuration
        let teamupConfig = {
            apiKey: null,
            calendarId: null,
            syncInterval: 5, // minutes
            lastSync: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Installer Portal - Firebase System');
            
            // Load saved settings first
            loadSavedSettings();
            
            // Check URL for routing
            const path = window.location.pathname;
            console.log('Current path:', path);
            
            if (path.includes('/admin')) {
                // Admin portal
                console.log('Loading admin portal...');
                loadAdminPortal();
            } else if (path.includes('/installer/')) {
                // Installer portal with unique ID
                const installerId = path.split('/installer/')[1];
                console.log('Loading installer portal for ID:', installerId);
                loadInstallerPortal(installerId);
            } else {
                // General landing page
                console.log('Loading landing page...');
                loadLandingPage();
            }
        });

        // Landing page function
        function loadLandingPage() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            // Show landing page
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div class="text-center">
                            <h1 class="text-4xl font-bold text-gray-900">üîß Installer Portal</h1>
                            <p class="mt-2 text-gray-600">Secure access for installers and administrators</p>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">üìã Installer Access</h3>
                                    <p class="text-sm text-gray-600">Use your unique portal link sent to your email</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">üëë Administrator Access</h3>
                                    <button onclick="window.location.href='/admin'" class="mt-2 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                        Admin Login
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Admin portal function
        function loadAdminPortal() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            // Show admin login screen
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                üëë Admin Portal
                            </h2>
                            <p class="mt-2 text-center text-sm text-gray-600">
                                Administrator access only
                            </p>
                            <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                                <p class="text-sm font-medium text-yellow-800">
                                    <strong>üîê Demo Credentials:</strong><br>
                                    Email: admin@company.com<br>
                                    Password: admin123
                                </p>
                            </div>
                        </div>
                        <form id="adminLoginForm" class="mt-8 space-y-6">
                            <div>
                                <label for="adminEmail" class="block text-sm font-medium text-gray-700">
                                    Admin Email
                                </label>
                                <input id="adminEmail" name="email" type="email" autocomplete="email" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter admin email" value="admin@company.com">
                            </div>

                            <div>
                                <label for="adminPassword" class="block text-sm font-medium text-gray-700">
                                    Admin Password
                                </label>
                                <input id="adminPassword" name="password" type="password" autocomplete="current-password" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter admin password" value="admin123">
                            </div>

                            <div>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    üîê Admin Sign In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup admin login form
            const adminLoginForm = document.getElementById('adminLoginForm');
            if (adminLoginForm) {
                console.log('Admin login form found, adding event listener...');
                adminLoginForm.addEventListener('submit', async function(e) {
                    console.log('Admin form submitted!');
                    e.preventDefault();
                    
                    const email = document.getElementById('adminEmail').value;
                    const password = document.getElementById('adminPassword').value;
                    
                    console.log(`Admin login attempt: ${email}`);
                    
                    // Demo admin login - accept any credentials for now
                    currentUser = {
                        uid: 'admin-123',
                        email: email,
                        displayName: 'Admin User',
                        role: 'admin'
                    };
                    
                    userRole = 'admin';
                    
                    console.log('Calling adminLogin function...');
                    try {
                        await adminLogin();
                        console.log('adminLogin completed successfully');
                    } catch (error) {
                        console.error('adminLogin failed:', error);
                        alert('Login failed: ' + error.message);
                    }
                });
            } else {
                console.error('Admin login form not found!');
            }
        }

        // Installer portal function
        function loadInstallerPortal(installerId) {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            // Show installer login screen
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                üîß Installer Portal
                            </h2>
                            <p class="mt-2 text-center text-sm text-gray-600">
                                Welcome Installer #${installerId}
                            </p>
                        </div>
                        <form id="installerLoginForm" class="mt-8 space-y-6">
                            <div>
                                <label for="installerEmail" class="block text-sm font-medium text-gray-700">
                                    Email
                                </label>
                                <input id="installerEmail" name="email" type="email" autocomplete="email" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter your email">
                            </div>

                            <div>
                                <label for="installerPassword" class="block text-sm font-medium text-gray-700">
                                    Password
                                </label>
                                <input id="installerPassword" name="password" type="password" autocomplete="current-password" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter your password">
                            </div>

                            <div>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    üîê Installer Sign In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup installer login form
            const installerLoginForm = document.getElementById('installerLoginForm');
            if (installerLoginForm) {
                installerLoginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('installerEmail').value;
                    const password = document.getElementById('installerPassword').value;
                    
                    console.log(`Installer login attempt: ${email} (ID: ${installerId})`);
                    
                    // Demo installer login
                    currentUser = {
                        uid: installerId,
                        email: email,
                        displayName: 'John Smith',
                        role: 'installer'
                    };
                    
                    userRole = 'installer';
                    await installerLogin();
                });
            }
        }

        // Admin login function
        async function adminLogin() {
            console.log('=== STARTING ADMIN LOGIN ===');
            
            // Create admin data
            installerData = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                role: 'admin',
                crews: ['All Crews'],
                active: true
            };
            
            console.log('Admin data created:', installerData);
            
            // Show admin dashboard - NO showPortal() call needed
            renderAdminDashboard();
            
            console.log('=== ADMIN LOGIN COMPLETED ===');
        }

        // Installer login function
        async function installerLogin() {
            console.log('=== STARTING INSTALLER LOGIN ===');
            
            // Create installer data
            installerData = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                crews: ['Crew A', 'Crew B'],
                active: true
            };
            
            console.log('Installer data created:', installerData);
            
            // Load installer availability
            await loadInstallerAvailability();
            
            // Create demo jobs
            jobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew B',
                    notes: 'Remove old door frame, install new entry door'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal'
                }
            ];
            
            console.log('Demo jobs created:', jobs);
            
            // Update UI
            document.getElementById('installerName').textContent = installerData.name;
            document.getElementById('installerInfo').textContent = installerData.name;
            
            // Show installer dashboard
            renderInstallerDashboard();
            
            console.log('=== INSTALLER LOGIN COMPLETED ===');
            showPortal();
        }

        // Show portal function
        function showPortal() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('portal').classList.remove('hidden');
        }

        // Render admin dashboard
        function renderAdminDashboard() {
            console.log('Rendering admin dashboard...');
            
            // The app element should exist because we just created it in loadAdminPortal
            const appElement = document.getElementById('app');
            console.log('App element found:', !!appElement);
            
            if (!appElement) {
                console.error('App element not found! Current DOM:', document.body.innerHTML);
                return;
            }
            
            console.log('Setting admin dashboard HTML...');
            appElement.innerHTML = `
                <!-- Admin Header -->
                <div class="min-h-screen bg-gray-100">
                    <header class="bg-white shadow-sm sticky top-0 z-50">
                        <div class="max-w-4xl mx-auto px-4 py-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">üëë</div>
                                    <div>
                                        <h1 class="text-lg font-bold text-gray-900">Admin Portal</h1>
                                        <div class="text-xs text-gray-600">Installer Management System</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm font-medium text-gray-700">${installerData.name} (Admin)</span>
                                    <button onclick="location.reload()" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-4xl mx-auto px-4 py-6">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">üëë Admin Dashboard</h2>
                            <p class="text-gray-600">Manage installers, jobs, and system settings</p>
                        </div>
                        
                        <!-- Admin Actions -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-blue-500">
                                <h3 class="font-semibold text-gray-900 mb-2">üë• Installer Management</h3>
                                <p class="text-sm text-gray-600 mb-3">Add, edit, and manage installer accounts</p>
                                <button onclick="showInstallerManagement()" class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                    Manage Installers
                                </button>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-purple-500">
                                <h3 class="font-semibold text-gray-900 mb-2">üîß System Settings</h3>
                                <p class="text-sm text-gray-600 mb-3">Configure Teamup sync and system preferences</p>
                                <button onclick="showSystemSettings()" class="px-3 py-2 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                    Settings
                                </button>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-orange-500">
                                <h3 class="font-semibold text-gray-900 mb-2">üë• New Installer Provisioning</h3>
                                <p class="text-sm text-gray-600 mb-3">Create accounts for installers found in TeamUp</p>
                                <button onclick="showNewInstallerProvisioning()" class="px-3 py-2 bg-orange-600 text-white text-sm rounded hover:bg-orange-700">
                                    Provision New Installers
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow-sm p-4">
                                <div class="text-2xl font-bold text-blue-600">3</div>
                                <div class="text-sm text-gray-600">Total Installers</div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm p-4">
                                <div class="text-2xl font-bold text-green-600">2</div>
                                <div class="text-sm text-gray-600">Available</div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm p-4">
                                <div class="text-2xl font-bold text-orange-600">1</div>
                                <div class="text-sm text-gray-600">On Job</div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm p-4">
                                <div class="text-2xl font-bold text-purple-600">3</div>
                                <div class="text-sm text-gray-600">Scheduled Jobs</div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="bg-white rounded-lg shadow-sm p-4">
                            <h3 class="font-semibold text-gray-900 mb-3">üìä Recent Activity</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <div>
                                        <span class="font-medium">JOB001</span>
                                        <span class="text-sm text-gray-600 ml-2">John Smith</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">SCHEDULED</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <div>
                                        <span class="font-medium">JOB002</span>
                                        <span class="text-sm text-gray-600 ml-2">Mary Johnson</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">SCHEDULED</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <div>
                                        <span class="font-medium">JOB003</span>
                                        <span class="text-sm text-gray-600 ml-2">Robert Davis</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">SCHEDULED</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            console.log('Admin dashboard rendered successfully!');
        }

        // Installer Management Functions
        let installers = [];
        let editingInstaller = null;

        // Show installer management interface
        function showInstallerManagement() {
            console.log('Loading installer management...');
            
            // Load demo installers
            loadDemoInstallers();
            
            // Replace main content with installer management
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üë• Installer Management</h2>
                            <div class="flex space-x-2">
                                <button onclick="showAddInstallerForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    ‚ûï Add New Installer
                                </button>
                                <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    ‚Üê Back to Dashboard
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                            <div class="flex flex-col md:flex-row gap-4">
                                <input type="text" id="installerSearch" placeholder="Search installers..." 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       onkeyup="filterInstallers()">
                                <select id="installerStatusFilter" onchange="filterInstallers()" 
                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Installers Table -->
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crews</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="installersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Installers will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Render installers table
                renderInstallersTable();
            }
        }

        // Load demo installers
        function loadDemoInstallers() {
            if (db) {
                // Load from Firebase (not real-time - just once)
                console.log('üì• Loading installers from Firebase...');
                db.collection('installers').get().then((snapshot) => {
                    installers = [];
                    snapshot.forEach((doc) => {
                        installers.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('‚úÖ Installers loaded from Firebase:', installers.length);
                    renderInstallersTable();
                }).catch((error) => {
                    console.error('‚ùå Error loading installers:', error);
                    // Fallback to demo data
                    loadDemoInstallersFallback();
                });
            } else {
                // Fallback to demo data
                loadDemoInstallersFallback();
            }
        }

        // Fallback demo installers
        function loadDemoInstallersFallback() {
            installers = [
                {
                    id: 'installer-001',
                    name: 'John Smith',
                    email: 'john.smith@company.com',
                    phone: '(555) 123-4567',
                    crews: ['Crew A', 'Crew B'],
                    status: 'active',
                    createdAt: new Date('2024-01-15'),
                    notes: 'Senior installer, specializes in windows'
                },
                {
                    id: 'installer-002', 
                    name: 'Mike Johnson',
                    email: 'mike.johnson@company.com',
                    phone: '(555) 234-5678',
                    crews: ['Crew C'],
                    status: 'active',
                    createdAt: new Date('2024-02-20'),
                    notes: 'New hire, training in progress'
                },
                {
                    id: 'installer-003',
                    name: 'Sarah Davis',
                    email: 'sarah.davis@company.com', 
                    phone: '(555) 345-6789',
                    crews: ['Crew A'],
                    status: 'inactive',
                    createdAt: new Date('2024-01-10'),
                    notes: 'On medical leave'
                }
            ];
        }

        // Render installers table
        function renderInstallersTable() {
            const tbody = document.getElementById('installersTableBody');
            if (!tbody) return;
            
            const searchTerm = document.getElementById('installerSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('installerStatusFilter')?.value || '';
            
            let filteredInstallers = installers.filter(installer => {
                const matchesSearch = installer.name.toLowerCase().includes(searchTerm) || 
                                   installer.email.toLowerCase().includes(searchTerm) ||
                                   installer.phone.includes(searchTerm);
                const matchesStatus = !statusFilter || installer.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            tbody.innerHTML = filteredInstallers.map(installer => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${installer.name}</div>
                        <div class="text-xs text-gray-500">ID: ${installer.id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${installer.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${installer.phone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex flex-wrap gap-1">
                            ${installer.crews.map(crew => `
                                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${crew}</span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded ${installer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${installer.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editInstaller('${installer.id}')" class="text-blue-600 hover:text-blue-900">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="viewInstallerDetails('${installer.id}')" class="text-green-600 hover:text-green-900">
                                üëÅÔ∏è View
                            </button>
                            <button onclick="deleteInstaller('${installer.id}')" class="text-red-600 hover:text-red-900">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Filter installers
        function filterInstallers() {
            renderInstallersTable();
        }

        // Show add installer form
        function showAddInstallerForm() {
            editingInstaller = null;
            showInstallerForm();
        }

        // Edit installer
        function editInstaller(installerId) {
            editingInstaller = installers.find(i => i.id === installerId);
            showInstallerForm();
        }

        // Show installer form
        function showInstallerForm() {
            const mainElement = document.querySelector('main');
            if (!mainElement) return;
            
            const installer = editingInstaller || {
                name: '',
                email: '',
                phone: '',
                crews: [],
                status: 'active',
                notes: ''
            };
            
            mainElement.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">
                            ${editingInstaller ? '‚úèÔ∏è Edit Installer' : '‚ûï Add New Installer'}
                        </h2>
                        <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ‚Üê Back to Installers
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <form id="installerForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Full Name *</label>
                                    <input type="text" id="installerName" required 
                                           value="${installer.name}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email *</label>
                                    <input type="email" id="installerEmail" required 
                                           value="${installer.email}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Phone *</label>
                                    <input type="tel" id="installerPhone" required 
                                           value="${installer.phone}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="installerStatus" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="active" ${installer.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${installer.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Crew Assignments</label>
                                <div class="mt-2 space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="newCrewInput" placeholder="Enter crew name..." 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <button type="button" onclick="addCrew()" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            Add Crew
                                        </button>
                                    </div>
                                    <div id="crewsList" class="flex flex-wrap gap-2">
                                        ${installer.crews.map((crew, index) => `
                                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm flex items-center">
                                                ${crew}
                                                <button type="button" onclick="removeCrew(${index})" class="ml-2 text-blue-600 hover:text-blue-800">√ó</button>
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Notes</label>
                                <textarea id="installerNotes" rows="3" 
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${installer.notes}</textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="showInstallerManagement()" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    ${editingInstaller ? 'Update Installer' : 'Create Installer'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup form submission
            const form = document.getElementById('installerForm');
            if (form) {
                form.addEventListener('submit', saveInstaller);
            }
        }

        // Add crew to list
        function addCrew() {
            const input = document.getElementById('newCrewInput');
            const crewName = input?.value.trim();
            
            if (crewName) {
                const crewsList = document.getElementById('crewsList');
                const currentCrews = Array.from(crewsList.querySelectorAll('span')).map(span => span.textContent.trim().replace('√ó', ''));
                
                if (!currentCrews.includes(crewName)) {
                    const crewSpan = document.createElement('span');
                    crewSpan.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm flex items-center';
                    crewSpan.innerHTML = `
                        ${crewName}
                        <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">√ó</button>
                    `;
                    crewsList.appendChild(crewSpan);
                    input.value = '';
                }
            }
        }

        // Remove crew from list
        function removeCrew(index) {
            const crewsList = document.getElementById('crewsList');
            const crewSpans = crewsList.querySelectorAll('span');
            if (crewSpans[index]) {
                crewSpans[index].remove();
            }
        }

        // Save installer
        async function saveInstaller() {
            const formData = {
                name: document.getElementById('installerName').value,
                email: document.getElementById('installerEmail').value,
                phone: document.getElementById('installerPhone').value,
                crews: Array.from(document.getElementById('installerCrews').selectedOptions).map(option => option.value),
                status: document.getElementById('installerStatus').value,
                notes: document.getElementById('installerNotes').value
            };
            
            if (editingInstaller) {
                // Update existing installer
                if (db) {
                    await db.collection('installers').doc(editingInstaller.id).update(formData);
                    console.log('‚úÖ Installer updated in Firebase');
                } else {
                    const index = installers.findIndex(i => i.id === editingInstaller.id);
                    if (index !== -1) {
                        installers[index] = { ...installers[index], ...formData };
                    }
                }
            } else {
                // Create new installer
                if (db) {
                    const docRef = await db.collection('installers').add({
                        ...formData,
                        createdAt: new Date()
                    });
                    console.log('‚úÖ New installer created in Firebase with ID:', docRef.id);
                } else {
                    const newInstaller = {
                        id: 'installer-' + Date.now(),
                        ...formData,
                        createdAt: new Date()
                    };
                    installers.push(newInstaller);
                    
                    // Show provisioning details for new installer
                    showProvisioningDetails(newInstaller);
                    return;
                }
            }
            
            showInstallerManagement();
        }

        // Show provisioning details
        function showProvisioningDetails(installer) {
            const tempPassword = generateTempPassword();
            const portalUrl = `${window.location.origin}/installer/${installer.id}`;
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h2 class="text-2xl font-bold text-green-800 mb-4">‚úÖ Installer Created Successfully!</h2>
                            <p class="text-green-700 mb-6">Share these access details with the installer:</p>
                            
                            <div class="bg-white rounded-lg p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Installer Name</label>
                                    <div class="text-lg font-semibold">${installer.name}</div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email</label>
                                    <div class="text-lg">${installer.email}</div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Temporary Password</label>
                                    <div class="flex items-center space-x-2">
                                        <div class="text-lg font-mono bg-gray-100 px-3 py-2 rounded">${tempPassword}</div>
                                        <button onclick="copyToClipboard('${tempPassword}')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Unique Portal URL</label>
                                    <div class="flex items-center space-x-2">
                                        <div class="text-sm font-mono bg-gray-100 px-3 py-2 rounded break-all">${portalUrl}</div>
                                        <button onclick="copyToClipboard('${portalUrl}')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="showInstallerManagement()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Back to Installers
                                </button>
                                <button onclick="showAddInstallerForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Add Another Installer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Generate temporary password
        function generateTempPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // View installer details
        function viewInstallerDetails(installerId) {
            const installer = installers.find(i => i.id === installerId);
            if (!installer) return;
            
            const portalUrl = `${window.location.origin}/installer/${installer.id}`;
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üëÅÔ∏è Installer Details</h2>
                            <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Installers
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Name</label>
                                            <div class="text-lg">${installer.name}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Email</label>
                                            <div class="text-lg">${installer.email}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                                            <div class="text-lg">${installer.phone}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <span class="px-2 py-1 text-xs rounded ${installer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${installer.status.toUpperCase()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Access Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Installer ID</label>
                                            <div class="text-lg font-mono">${installer.id}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Portal URL</label>
                                            <div class="flex items-center space-x-2">
                                                <div class="text-sm font-mono bg-gray-100 px-3 py-2 rounded break-all">${portalUrl}</div>
                                                <button onclick="copyToClipboard('${portalUrl}')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                                    üìã Copy
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Crew Assignments</label>
                                            <div class="flex flex-wrap gap-2">
                                                ${installer.crews.map(crew => `
                                                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${crew}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${installer.notes ? `
                                <div class="mt-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Notes</h3>
                                    <div class="bg-gray-50 p-3 rounded">${installer.notes}</div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="editInstaller('${installer.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    ‚úèÔ∏è Edit Installer
                                </button>
                                <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    Back to Installers
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Delete installer
        function deleteInstaller(installerId) {
            if (confirm('Are you sure you want to delete this installer? This action cannot be undone.')) {
                installers = installers.filter(i => i.id !== installerId);
                renderInstallersTable();
            }
        }

        // Job Assignment Functions
        let adminJobs = [];
        let editingJob = null;

        // Show job assignment interface
        function showJobAssignment() {
            console.log('Loading job assignment...');
            
            // Load demo jobs
            loadDemoJobs();
            
            // Replace main content with job assignment
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üìÖ Job Assignment</h2>
                            <div class="flex space-x-2">
                                <button onclick="manualSyncTeamUp()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    üîÑ Sync from TeamUp
                                </button>
                                <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    ‚Üê Back to Dashboard
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                            <div class="flex flex-col md:flex-row gap-4">
                                <input type="text" id="jobSearch" placeholder="Search jobs by customer or address..." 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       onkeyup="filterJobs()">
                                <select id="jobStatusFilter" onchange="filterJobs()" 
                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Status</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="jobInstallerFilter" onchange="filterJobs()" 
                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Installers</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Jobs Table -->
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Installer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Jobs will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Populate installer filter
                populateInstallerFilter();
                
                // Render jobs table
                renderJobsTable();
            }
        }

        // TeamUp Integration Functions
        function syncWithTeamUp() {
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                console.log('‚ö†Ô∏è TeamUp not configured - skipping sync');
                return Promise.resolve();
            }
            
            console.log('üîÑ Syncing with TeamUp...');
            
            // Calculate date range - current week + next 3 weeks
            const now = new Date();
            const currentWeekStart = getWeekStart(now);
            const threeWeeksEnd = new Date(currentWeekStart.getTime() + (28 * 24 * 60 * 60 * 1000)); // 4 weeks total
            
            // Format dates for TeamUp API
            const startDateStr = currentWeekStart.toISOString().split('T')[0];
            const endDateStr = threeWeeksEnd.toISOString().split('T')[0];
            
            console.log(`üìÖ Syncing events from ${startDateStr} to ${endDateStr} (current week + 3 weeks)`);
            
            // TeamUp API call with optimized date range
            const apiUrl = `https://api.teamup.com/${teamupConfig.calendarId}/events?startDate=${startDateStr}&endDate=${endDateStr}`;
            
            return fetch(apiUrl, {
                headers: {
                    'Teamup-Token': teamupConfig.apiKey
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ TeamUp data received:', data.events?.length || 0, 'events');
                processTeamUpEvents(data.events || []);
                teamupConfig.lastSync = new Date();
                
                // Update TeamUp events count
                const eventsCount = data.events?.length || 0;
                const teamUpEventsElement = document.getElementById('totalTeamUpEvents');
                if (teamUpEventsElement) {
                    teamUpEventsElement.textContent = eventsCount;
                }
            })
            .catch(error => {
                console.error('‚ùå TeamUp sync failed:', error);
                throw error;
            });
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function processTeamUpEvents(events) {
            // Convert TeamUp events to job format
            const teamUpJobs = events.map(event => ({
                id: event.id,
                title: event.title,
                customer: extractCustomerFromTitle(event.title),
                phone: event.location?.phone || '',
                email: event.location?.notes || '',
                address: event.location?.address || '',
                scheduledDate: new Date(event.start_dt),
                assignedInstaller: event.who?.[0]?.name || null,
                status: mapTeamUpStatus(event.status),
                notes: event.notes || '',
                estimatedDuration: formatDuration(event.end_dt - event.start_dt),
                priority: mapTeamUpPriority(event.title),
                source: 'teamup'
            }));
            
            // Save to Firebase
            if (db) {
                teamUpJobs.forEach(job => {
                    db.collection('jobs').doc(job.id).set(job, { merge: true });
                });
                console.log('‚úÖ Saved', teamUpJobs.length, 'TeamUp jobs to Firebase');
            }
        }

        function extractCustomerFromTitle(title) {
            // Extract customer name from title (customize based on your format)
            const match = title.match(/^([^-\n]+)/);
            return match ? match[1].trim() : title;
        }

        function mapTeamUpStatus(teamUpStatus) {
            const statusMap = {
                'confirmed': 'scheduled',
                'tentative': 'scheduled',
                'canceled': 'cancelled',
                'completed': 'completed'
            };
            return statusMap[teamUpStatus] || 'scheduled';
        }

        function mapTeamUpPriority(title) {
            if (title.toLowerCase().includes('urgent') || title.toLowerCase().includes('priority')) {
                return 'high';
            }
            return 'normal';
        }

        function formatDuration(milliseconds) {
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function startTeamUpSync() {
            if (teamupConfig.apiKey && teamupConfig.calendarId) {
                // Initial sync
                syncWithTeamUp();
                
                // Set up recurring sync
                setInterval(() => {
                    syncWithTeamUp();
                }, teamupConfig.syncInterval * 60 * 1000);
                
                console.log(`üîÑ TeamUp sync started - every ${teamupConfig.syncInterval} minutes`);
            }
        }

        // Load jobs from Firebase (not TeamUp)
        function loadDemoJobs() {
            if (db) {
                // Load from Firebase (not real-time - just once)
                console.log('üì• Loading jobs from Firebase...');
                db.collection('jobs').get().then((snapshot) => {
                    adminJobs = [];
                    snapshot.forEach((doc) => {
                        adminJobs.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('‚úÖ Jobs loaded from Firebase:', adminJobs.length);
                    renderJobsTable();
                }).catch((error) => {
                    console.error('‚ùå Error loading jobs:', error);
                    // Fallback to demo data
                    loadDemoJobsFallback();
                });
            } else {
                // Fallback to demo data
                loadDemoJobsFallback();
            }
        }

        // Fallback demo jobs
        function loadDemoJobsFallback() {
            adminJobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    phone: '(555) 123-4567',
                    email: 'john.smith@email.com',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    assignedInstaller: 'installer-001',
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows, remove old frames',
                    estimatedDuration: '4 hours',
                    priority: 'normal'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    phone: '(555) 234-5678',
                    email: 'mary.johnson@email.com',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    assignedInstaller: 'installer-002',
                    status: 'scheduled',
                    crew: 'Crew C',
                    notes: 'Remove old door frame, install new entry door with hardware',
                    estimatedDuration: '3 hours',
                    priority: 'high'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    phone: '(555) 345-6789',
                    email: 'robert.davis@email.com',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    assignedInstaller: 'installer-001',
                    status: 'completed',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal, replace weatherstripping',
                    estimatedDuration: '2 hours',
                    priority: 'low'
                },
                {
                    id: 'JOB004',
                    title: 'Full Window Replacement - Kitchen',
                    customer: 'Sarah Wilson',
                    phone: '(555) 456-7890',
                    email: 'sarah.wilson@email.com',
                    address: '321 Elm Street, Springfield',
                    scheduledDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    assignedInstaller: null,
                    status: 'unassigned',
                    crew: null,
                    notes: 'Replace all kitchen windows with new energy-efficient models',
                    estimatedDuration: '6 hours',
                    priority: 'high'
                }
            ];
        }

        // Populate installer filter dropdown
        function populateInstallerFilter() {
            const filter = document.getElementById('jobInstallerFilter');
            if (!filter) return;
            
            // Add active installers to filter
            const activeInstallers = installers.filter(i => i.status === 'active');
            
            filter.innerHTML = `
                <option value="">All Installers</option>
                ${activeInstallers.map(installer => `
                    <option value="${installer.id}">${installer.name}</option>
                `).join('')}
            `;
        }

        // Render jobs table
        function renderJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            if (!tbody) return;
            
            const searchTerm = document.getElementById('jobSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('jobStatusFilter')?.value || '';
            const installerFilter = document.getElementById('jobInstallerFilter')?.value || '';
            
            let filteredJobs = adminJobs.filter(job => {
                const matchesSearch = job.customer.toLowerCase().includes(searchTerm) || 
                                   job.address.toLowerCase().includes(searchTerm) ||
                                   job.title.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || job.status === statusFilter;
                const matchesInstaller = !installerFilter || job.assignedInstaller === installerFilter;
                return matchesSearch && matchesStatus && matchesInstaller;
            });
            
            // Sort by scheduled date
            filteredJobs.sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));
            
            tbody.innerHTML = filteredJobs.map(job => {
                const installer = installers.find(i => i.id === job.assignedInstaller);
                const installerName = installer ? installer.name : 'Unassigned';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${job.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${job.customer}</div>
                            <div class="text-xs text-gray-500">${job.phone}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${job.address}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${formatDate(job.scheduledDate)}</div>
                            <div class="text-xs text-gray-500">${formatTime(job.scheduledDate)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${installerName}</div>
                            ${job.crew ? `<div class="text-xs text-gray-500">${job.crew}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded ${getStatusClass(job.status)}">
                                ${job.status.replace('_', ' ').toUpperCase()}
                            </span>
                            ${job.priority === 'high' ? '<div class="text-xs text-red-600 mt-1">‚ö†Ô∏è High Priority</div>' : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewJobDetails('${job.id}')" class="text-blue-600 hover:text-blue-900">
                                    üëÅÔ∏è View
                                </button>
                                ${job.status === 'unassigned' ? `
                                    <button onclick="assignJob('${job.id}')" class="text-purple-600 hover:text-purple-900">
                                        üë• Assign
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status styling class
        function getStatusClass(status) {
            switch(status) {
                case 'scheduled': return 'bg-blue-100 text-blue-800';
                case 'in_progress': return 'bg-yellow-100 text-yellow-800';
                case 'completed': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                case 'unassigned': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Format date
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Format time
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Filter jobs
        function filterJobs() {
            renderJobsTable();
        }

        // Show add job form
        function showAddJobForm() {
            editingJob = null;
            showJobForm();
        }

        // Edit job
        function editJob(jobId) {
            editingJob = adminJobs.find(j => j.id === jobId);
            showJobForm();
        }

        // Show job form
        function showJobForm() {
            const mainElement = document.querySelector('main');
            if (!mainElement) return;
            
            const job = editingJob || {
                title: '',
                customer: '',
                phone: '',
                email: '',
                address: '',
                scheduledDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                assignedInstaller: '',
                crew: '',
                status: 'scheduled',
                notes: '',
                estimatedDuration: '',
                priority: 'normal'
            };
            
            // Format date for input
            const dateForInput = new Date(job.scheduledDate).toISOString().slice(0, 16);
            
            mainElement.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">
                            ${editingJob ? '‚úèÔ∏è Edit Job' : '‚ûï Create New Job'}
                        </h2>
                        <button onclick="showJobAssignment()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ‚Üê Back to Jobs
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <form id="jobForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Job Title *</label>
                                    <input type="text" id="jobTitle" required 
                                           value="${job.title}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Customer Name *</label>
                                    <input type="text" id="jobCustomer" required 
                                           value="${job.customer}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Customer Phone *</label>
                                    <input type="tel" id="jobPhone" required 
                                           value="${job.phone}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Customer Email</label>
                                    <input type="email" id="jobEmail" 
                                           value="${job.email}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Service Address *</label>
                                    <input type="text" id="jobAddress" required 
                                           value="${job.address}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Scheduled Date & Time *</label>
                                    <input type="datetime-local" id="jobScheduledDate" required 
                                           value="${dateForInput}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Assign Installer</label>
                                    <select id="jobAssignedInstaller" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Installer</option>
                                        ${installers.filter(i => i.status === 'active').map(installer => `
                                            <option value="${installer.id}" ${job.assignedInstaller === installer.id ? 'selected' : ''}>
                                                ${installer.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Priority</label>
                                    <select id="jobPriority" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="low" ${job.priority === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="normal" ${job.priority === 'normal' ? 'selected' : ''}>Normal</option>
                                        <option value="high" ${job.priority === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Estimated Duration</label>
                                    <input type="text" id="jobEstimatedDuration" 
                                           value="${job.estimatedDuration}"
                                           placeholder="e.g., 4 hours"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="jobStatus" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="unassigned" ${job.status === 'unassigned' ? 'selected' : ''}>Unassigned</option>
                                        <option value="scheduled" ${job.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                        <option value="in_progress" ${job.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${job.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${job.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Job Notes</label>
                                <textarea id="jobNotes" rows="4" 
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${job.notes}</textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="showJobAssignment()" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    ${editingJob ? 'Update Job' : 'Create Job'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup form submission
            const form = document.getElementById('jobForm');
            if (form) {
                form.addEventListener('submit', saveJob);
            }
        }

        // Save job
        async function saveJob(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('jobTitle').value,
                customer: document.getElementById('jobCustomer').value,
                phone: document.getElementById('jobPhone').value,
                email: document.getElementById('jobEmail').value,
                address: document.getElementById('jobAddress').value,
                scheduledDate: new Date(document.getElementById('jobScheduledDate').value),
                assignedInstaller: document.getElementById('jobAssignedInstaller').value,
                priority: document.getElementById('jobPriority').value,
                estimatedDuration: document.getElementById('jobEstimatedDuration').value,
                status: document.getElementById('jobStatus').value,
                notes: document.getElementById('jobNotes').value
            };
            
            // Set crew based on installer
            if (formData.assignedInstaller) {
                const installer = installers.find(i => i.id === formData.assignedInstaller);
                formData.crew = installer ? installer.crews[0] : null;
            }
            
            if (editingJob) {
                // Update existing job
                if (db) {
                    await db.collection('jobs').doc(editingJob.id).update(formData);
                    console.log('‚úÖ Job updated in Firebase');
                } else {
                    const index = adminJobs.findIndex(j => j.id === editingJob.id);
                    if (index !== -1) {
                        adminJobs[index] = { ...adminJobs[index], ...formData };
                    }
                }
            } else {
                // Create new job
                if (db) {
                    const docRef = await db.collection('jobs').add({
                        ...formData,
                        createdAt: new Date()
                    });
                    console.log('‚úÖ New job created in Firebase with ID:', docRef.id);
                } else {
                    const newJob = {
                        id: 'JOB' + Date.now(),
                        ...formData
                    };
                    adminJobs.push(newJob);
                }
            }
            
            showJobAssignment();
        }

        // Assign job
        function assignJob(jobId) {
            const job = adminJobs.find(j => j.id === jobId);
            if (!job) return;
            
            editingJob = job;
            showJobForm();
        }

        // View job details
        function viewJobDetails(jobId) {
            const job = adminJobs.find(j => j.id === jobId);
            if (!job) return;
            
            const installer = installers.find(i => i.id === job.assignedInstaller);
            const installerName = installer ? installer.name : 'Unassigned';
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üëÅÔ∏è Job Details</h2>
                            <button onclick="showJobAssignment()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Jobs
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Job Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Job ID</label>
                                            <div class="text-lg font-mono">${job.id}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Title</label>
                                            <div class="text-lg">${job.title}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <span class="px-2 py-1 text-xs rounded ${getStatusClass(job.status)}">
                                                ${job.status.replace('_', ' ').toUpperCase()}
                                            </span>
                                            ${job.priority === 'high' ? '<div class="text-sm text-red-600 mt-1">‚ö†Ô∏è High Priority</div>' : ''}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Scheduled Date</label>
                                            <div class="text-lg">${formatDate(job.scheduledDate)} at ${formatTime(job.scheduledDate)}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Estimated Duration</label>
                                            <div class="text-lg">${job.estimatedDuration || 'Not specified'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Customer Name</label>
                                            <div class="text-lg">${job.customer}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                                            <div class="text-lg">${job.phone}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Email</label>
                                            <div class="text-lg">${job.email || 'Not provided'}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Service Address</label>
                                            <div class="text-lg">${job.address}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Assignment</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Assigned Installer</label>
                                            <div class="text-lg">${installerName}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Crew</label>
                                            <div class="text-lg">${job.crew || 'Not assigned'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${job.notes ? `
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Notes</h3>
                                        <div class="bg-gray-50 p-3 rounded">${job.notes}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="showJobAssignment()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    Back to Jobs
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Delete job
        async function deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                if (db) {
                    await db.collection('jobs').doc(jobId).delete();
                    console.log('‚úÖ Job deleted from Firebase');
                } else {
                    adminJobs = adminJobs.filter(j => j.id !== jobId);
                    renderJobsTable();
                }
            }
        }

        // System Settings Functions
        function showSystemSettings() {
            console.log('Loading system settings...');
            
            // Replace main content with system settings
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üîß System Settings</h2>
                            <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Dashboard
                            </button>
                        </div>
                        
                        <!-- TeamUp Configuration -->
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üîÑ TeamUp Integration</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">TeamUp API Key</label>
                                    <input type="password" id="teamupApiKey" 
                                           value="${teamupConfig.apiKey || ''}"
                                           placeholder="Enter your TeamUp API key"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Get this from your TeamUp account settings</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Calendar ID</label>
                                    <input type="text" id="teamupCalendarId" 
                                           value="${teamupConfig.calendarId || ''}"
                                           placeholder="Enter TeamUp calendar ID"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Found in TeamUp calendar URL</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Sync Interval (minutes)</label>
                                    <select id="teamupSyncInterval" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                        <option value="1" ${teamupConfig.syncInterval === 1 ? 'selected' : ''}>1 minute</option>
                                        <option value="5" ${teamupConfig.syncInterval === 5 ? 'selected' : ''}>5 minutes</option>
                                        <option value="10" ${teamupConfig.syncInterval === 10 ? 'selected' : ''}>10 minutes</option>
                                        <option value="15" ${teamupConfig.syncInterval === 15 ? 'selected' : ''}>15 minutes</option>
                                        <option value="30" ${teamupConfig.syncInterval === 30 ? 'selected' : ''}>30 minutes</option>
                                        <option value="60" ${teamupConfig.syncInterval === 60 ? 'selected' : ''}>1 hour</option>
                                        <option value="120" ${teamupConfig.syncInterval === 120 ? 'selected' : ''}>2 hours</option>
                                        <option value="240" ${teamupConfig.syncInterval === 240 ? 'selected' : ''}>4 hours</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-end">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Last Sync</label>
                                        <div class="mt-1 text-sm text-gray-600">
                                            ${teamupConfig.lastSync ? teamupConfig.lastSync.toLocaleString() : 'Never synced'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="testTeamUpConnection()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    üîç Test Connection
                                </button>
                                <button onclick="saveSystemSettings()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                    üíæ Save Settings
                                </button>
                                <button onclick="manualSyncTeamUp()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    üîÑ Sync Now
                                </button>
                            </div>
                        </div>
                        
                        <!-- Sync Status -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Sync Status</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="totalTeamUpEvents">-</div>
                                    <div class="text-sm text-gray-600">TeamUp Events</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600" id="firebaseJobsCount">-</div>
                                    <div class="text-sm text-gray-600">Firebase Jobs</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="syncStatus">Not Configured</div>
                                    <div class="text-sm text-gray-600">Sync Status</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load current sync status
                updateSyncStatus();
            }
        }

        function testTeamUpConnection() {
            const apiKey = document.getElementById('teamupApiKey').value;
            const calendarId = document.getElementById('teamupCalendarId').value;
            
            if (!apiKey || !calendarId) {
                alert('Please enter both API Key and Calendar ID');
                return;
            }
            
            console.log('üîç Testing TeamUp connection...');
            
            fetch(`https://api.teamup.com/${calendarId}/events`, {
                headers: {
                    'Teamup-Token': apiKey
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                const eventCount = data.events?.length || 0;
                alert(`‚úÖ Connection successful! Found ${eventCount} events in TeamUp calendar.`);
                document.getElementById('totalTeamUpEvents').textContent = eventCount;
            })
            .catch(error => {
                console.error('‚ùå TeamUp connection test failed:', error);
                alert(`‚ùå Connection failed: ${error.message}`);
            });
        }

        function saveSystemSettings() {
            const apiKey = document.getElementById('teamupApiKey').value;
            const calendarId = document.getElementById('teamupCalendarId').value;
            const syncInterval = parseInt(document.getElementById('teamupSyncInterval').value);
            
            // Update config
            teamupConfig = {
                apiKey: apiKey,
                calendarId: calendarId,
                syncInterval: syncInterval,
                lastSync: teamupConfig.lastSync
            };
            
            // Save to localStorage for persistence
            localStorage.setItem('teamupConfig', JSON.stringify(teamupConfig));
            
            console.log('‚úÖ System settings saved:', teamupConfig);
            
            // Restart sync with new settings
            if (apiKey && calendarId) {
                startTeamUpSync();
                document.getElementById('syncStatus').textContent = 'Active';
            }
            
            alert('‚úÖ Settings saved successfully!');
        }

        function manualSyncTeamUp() {
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                alert('Please configure TeamUp settings first');
                return;
            }
            
            console.log('üîÑ Manual TeamUp sync triggered...');
            
            // Show loading state
            const syncButton = event.target;
            const originalText = syncButton.innerHTML;
            syncButton.innerHTML = 'üîÑ Syncing...';
            syncButton.disabled = true;
            
            syncWithTeamUp().then(() => {
                // Update status after sync completes
                updateSyncStatus();
                syncButton.innerHTML = '‚úÖ Sync Complete';
                setTimeout(() => {
                    syncButton.innerHTML = originalText;
                    syncButton.disabled = false;
                }, 2000);
            }).catch(error => {
                console.error('‚ùå Sync failed:', error);
                alert(`Sync failed: ${error.message}`);
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
            });
        }

        function updateSyncStatus() {
            // Update Firebase jobs count
            if (db) {
                db.collection('jobs').get().then(snapshot => {
                    document.getElementById('firebaseJobsCount').textContent = snapshot.size;
                });
            }
            
            // Update sync status
            if (teamupConfig.apiKey && teamupConfig.calendarId) {
                document.getElementById('syncStatus').textContent = 
                    teamupConfig.lastSync ? 'Active' : 'Ready';
            } else {
                document.getElementById('syncStatus').textContent = 'Not Configured';
            }
        }

        // Load saved settings on startup
        function loadSavedSettings() {
            const saved = localStorage.getItem('teamupConfig');
            if (saved) {
                try {
                    teamupConfig = JSON.parse(saved);
                    console.log('‚úÖ Loaded saved TeamUp config:', teamupConfig);
                } catch (error) {
                    console.error('‚ùå Failed to load saved settings:', error);
                }
            }
        }

        // New Installer Provisioning Functions
        function showNewInstallerProvisioning() {
            console.log('Loading new installer provisioning...');
            
            // Replace main content with provisioning interface
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üë• New Installer Provisioning</h2>
                            <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Dashboard
                            </button>
                        </div>
                        
                        <!-- Installers Needing Accounts -->
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üîç Installers Found in TeamUp</h3>
                            <p class="text-sm text-gray-600 mb-4">Installers found in TeamUp who need accounts created</p>
                            
                            <!-- Debug Controls -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">üîß Debug Controls</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">API Endpoint Test</label>
                                        <select id="debugEndpoint" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="/calendars">/calendars (Standard)</option>
                                            <option value="/subcalendars">/subcalendars (Alternative)</option>
                                            <option value="/events">/events (Event-based)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Debug Mode</label>
                                        <select id="debugMode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="normal">Normal</option>
                                            <option value="verbose">Verbose</option>
                                            <option value="minimal">Minimal</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex space-x-3 mt-3">
                                    <button onclick="testTeamUpEndpoints()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                        üß™ Test Endpoints
                                    </button>
                                    <button onclick="loadTeamUpInstallers()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        üîÑ Load Installers
                                    </button>
                                </div>
                            </div>
                            
                            <div id="teamUpInstallersList" class="space-y-4">
                                <!-- TeamUp installers will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Provisioning Actions -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üöÄ Bulk Provisioning</h3>
                            <div class="flex space-x-3 mb-4">
                                <button onclick="provisionSelectedInstallers()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    ‚úÖ Create Selected Accounts
                                </button>
                                <button onclick="selectAllInstallers()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    ‚òëÔ∏è Select All
                                </button>
                                <button onclick="deselectAllInstallers()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                    ‚¨ú Deselect All
                                </button>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">üìã Provisioning Summary</h4>
                                <div id="provisioningSummary" class="text-sm text-blue-700">
                                    Select installers to create accounts for
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Auto-load installers after UI is ready
            setTimeout(() => {
                loadTeamUpInstallers();
            }, 100);
        }

        function loadTeamUpInstallers() {
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                document.getElementById('teamUpInstallersList').innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <p class="text-yellow-800">‚ö†Ô∏è TeamUp not configured. Please configure TeamUp settings first.</p>
                    </div>
                `;
                return;
            }
            
            // Get debug settings
            const debugEndpoint = document.getElementById('debugEndpoint')?.value || '/calendars';
            const debugMode = document.getElementById('debugMode')?.value || 'normal';
            
            console.log('üîç Loading installers from TeamUp calendars...');
            console.log('üîë API Key:', teamupConfig.apiKey ? 'Present' : 'Missing');
            console.log('üìÖ Calendar ID:', teamupConfig.calendarId);
            console.log('üîß Debug Endpoint:', debugEndpoint);
            console.log('üîß Debug Mode:', debugMode);
            
            // Try different API endpoints
            const calendarsApiUrl = `https://api.teamup.com/${teamupConfig.calendarId}${debugEndpoint}`;
            console.log('üåê API URL:', calendarsApiUrl);
            
            fetch(calendarsApiUrl, {
                headers: {
                    'Teamup-Token': teamupConfig.apiKey
                }
            })
            .then(response => {
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('üìä Full response:', data);
                
                let installers = [];
                
                if (debugEndpoint === '/events') {
                    // Extract installers from events
                    const events = data.events || [];
                    const installersMap = new Map();
                    
                    events.forEach((event, index) => {
                        if (debugMode === 'verbose') {
                            console.log(`üìã Event ${index}:`, event);
                        }
                        
                        if (event.who && event.who.length > 0) {
                            const installerName = event.who[0].name;
                            if (installerName && !installersMap.has(installerName)) {
                                installersMap.set(installerName, {
                                    name: installerName,
                                    calendarId: event.calendar_id || 'unknown',
                                    active: true,
                                    color: '#3B82F6',
                                    phone: event.location?.phone || '',
                                    email: event.location?.notes || ''
                                });
                            }
                        }
                    });
                    
                    installers = Array.from(installersMap.values());
                    console.log(`üë• Found ${installers.length} installers from events`);
                    
                } else {
                    // Extract from calendars/subcalendars
                    const calendars = data.calendars || data.subcalendars || [];
                    
                    calendars.forEach((calendar, index) => {
                        if (debugMode === 'verbose') {
                            console.log(`üìã Calendar ${index}:`, calendar);
                        }
                        
                        const installerName = calendar.name;
                        if (installerName) {
                            installers.push({
                                name: installerName,
                                calendarId: calendar.id,
                                active: calendar.active !== false,
                                color: calendar.color || '#3B82F6',
                                phone: '',
                                email: ''
                            });
                        }
                    });
                    
                    console.log(`üë• Found ${installers.length} installers from calendars`);
                }
                
                console.log('üë• Final installers list:', installers);
                
                // Get existing installers from Firebase to check who's already provisioned
                if (db) {
                    db.collection('installers').get().then(snapshot => {
                        const existingInstallers = new Set();
                        snapshot.forEach(doc => {
                            existingInstallers.add(doc.data().name);
                        });
                        
                        console.log(`üìã ${existingInstallers.size} installers already provisioned:`, Array.from(existingInstallers));
                        
                        // Mark which installers need provisioning
                        const installersList = installers.map(installer => ({
                            ...installer,
                            needsProvisioning: !existingInstallers.has(installer.name)
                        }));
                        
                        console.log('üéØ Final installers list:', installersList);
                        displayTeamUpInstallers(installersList);
                    });
                } else {
                    // Fallback - just show all installers
                    console.log('‚ö†Ô∏è No Firebase DB - showing all installers');
                    displayTeamUpInstallers(installers);
                }
            })
            .catch(error => {
                console.error('‚ùå Failed to load TeamUp data:', error);
                console.error('‚ùå Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                
                document.getElementById('teamUpInstallersList').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <p class="text-red-800">‚ùå Failed to load TeamUp data: ${error.message}</p>
                        <p class="text-red-600 text-sm mt-2">Check console for detailed error information</p>
                        <p class="text-red-600 text-sm mt-2">Try different endpoint from debug controls above</p>
                    </div>
                `;
            });
        }

        function testTeamUpEndpoints() {
            const endpoints = ['/calendars', '/subcalendars', '/events'];
            const debugMode = document.getElementById('debugMode')?.value || 'normal';
            
            console.log('üß™ Testing all TeamUp endpoints...');
            
            endpoints.forEach(endpoint => {
                const apiUrl = `https://api.teamup.com/${teamupConfig.calendarId}${endpoint}`;
                console.log(`üß™ Testing ${apiUrl}...`);
                
                fetch(apiUrl, {
                    headers: {
                        'Teamup-Token': teamupConfig.apiKey
                    }
                })
                .then(response => {
                    console.log(`‚úÖ ${endpoint}: Status ${response.status}`);
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .then(data => {
                    console.log(`‚úÖ ${endpoint}: Success - ${JSON.stringify(data).substring(0, 100)}...`);
                })
                .catch(error => {
                    console.log(`‚ùå ${endpoint}: ${error.message}`);
                });
            });
        }

        function displayTeamUpInstallers(installers) {
            const listElement = document.getElementById('teamUpInstallersList');
            if (!listElement) return;
            
            if (installers.length === 0) {
                listElement.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-gray-600">No installers found in TeamUp calendars.</p>
                    </div>
                `;
                return;
            }
            
            listElement.innerHTML = installers.map((installer, index) => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 ${installer.needsProvisioning ? 'border-l-4 border-orange-500' : 'border-l-4 border-green-500'}">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" id="installer-${index}" value="${installer.name}" 
                               class="mt-1 h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                               ${!installer.needsProvisioning ? 'disabled' : ''}>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${installer.name}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${installer.needsProvisioning ? 'Needs account created' : 'Already provisioned'}
                                        ${installer.calendarId ? `‚Ä¢ Calendar ID: ${installer.calendarId}` : ''}
                                    </p>
                                </div>
                                <div class="text-right">
                                    ${installer.needsProvisioning ? 
                                        `<span class="px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded">‚ö†Ô∏è Needs Account</span>` :
                                        `<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">‚úÖ Provisioned</span>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            updateProvisioningSummary();
        }

        function selectAllInstallers() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = true);
            updateProvisioningSummary();
        }

        function deselectAllInstallers() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateProvisioningSummary();
        }

        function updateProvisioningSummary() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]:checked');
            const selectedCount = checkboxes.length;
            const summaryElement = document.getElementById('provisioningSummary');
            
            if (selectedCount === 0) {
                summaryElement.innerHTML = 'Select installers to create accounts for';
            } else {
                summaryElement.innerHTML = `
                    <strong>${selectedCount}</strong> installer(s) selected for account creation
                `;
            }
        }

        function provisionSelectedInstallers() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one installer to provision.');
                return;
            }
            
            const selectedInstallers = Array.from(checkboxes).map(cb => cb.value);
            
            console.log('üöÄ Provisioning installers:', selectedInstallers);
            
            // Create installer accounts for selected installers
            selectedInstallers.forEach(installerName => {
                const installerData = {
                    name: installerName,
                    email: `${installerName.toLowerCase().replace(/\s+/g, '.')}@company.com`,
                    phone: '(555) 000-0000',
                    crews: ['Default Crew'],
                    status: 'active',
                    notes: `Auto-provisioned from TeamUp calendar on ${new Date().toLocaleDateString()}`,
                    createdAt: new Date()
                };
                
                // Save to Firebase
                if (db) {
                    db.collection('installers').add(installerData)
                    .then(docRef => {
                        console.log(`‚úÖ Created account for ${installerName} with ID: ${docRef.id}`);
                    })
                    .catch(error => {
                        console.error(`‚ùå Failed to create account for ${installerName}:`, error);
                    });
                }
            });
            
            alert(`‚úÖ Provisioning complete! Accounts created for ${selectedInstallers.length} installer(s).`);
            
            // Refresh list to show updated provisioning status
            loadTeamUpInstallers();
        }

        // Render installer dashboard
        function renderInstallerDashboard() {
            // Show the regular installer dashboard
            renderInstallerJobs();
            updateWeekRange();
        }

        // Demo login (replace with real auth)
        async function demoLogin() {
            // Use demo mode when Firebase config is not set
            console.log('Using demo mode - Firebase config not set');
            
            const demoUser = {
                uid: 'demo-user-123',
                email: 'john@company.com',
                displayName: 'John Smith'
            };
            
            // Create demo data without Firebase
            installerData = {
                uid: demoUser.uid,
                name: demoUser.displayName || 'John Smith',
                email: demoUser.email,
                crews: ['Crew A', 'Crew B'],
                active: true
            };
            
            // Create demo jobs (realistic data)
            jobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    status: 'in-progress',
                    crew: 'Crew B',
                    notes: 'Remove old door frame, install new entry door'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    status: 'completed',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal'
                }
            ];
            
            // Update UI
            document.getElementById('installerName').textContent = installerData.name;
            document.getElementById('installerInfo').textContent = installerData.name;
            document.getElementById('crewInfo').textContent = installerData.crews.join(', ');
            
            renderInstallerJobs();
            updateWeekRange();
            showPortal();
        }

        // Load installer data from Firestore
        async function loadInstallerData(user) {
            try {
                // Get installer document
                const installerDoc = await db.collection('installers').doc(user.uid).get();
                
                if (installerDoc.exists) {
                    installerData = installerDoc.data();
                } else {
                    // Create demo installer
                    installerData = {
                        uid: user.uid,
                        name: user.displayName || 'John Smith',
                        email: user.email,
                        crews: ['Crew A', 'Crew B'],
                        active: true
                    };
                    
                    // Save to Firestore
                    await db.collection('installers').doc(user.uid).set(installerData);
                }

                // Update UI
                document.getElementById('installerName').textContent = installerData.name;
                document.getElementById('installerInfo').textContent = installerData.name;
                document.getElementById('crewInfo').textContent = installerData.crews.join(', ');
                
                console.log('Installer data loaded:', installerData);
            } catch (error) {
                console.error('Failed to load installer data:', error);
                showError('Failed to load installer data');
            }
        }

        // Load jobs from Firestore with real-time updates
        async function loadJobs() {
            try {
                // Unsubscribe previous listener
                if (jobsUnsubscribe) {
                    jobsUnsubscribe();
                }

                // Query jobs for this installer
                const jobsQuery = db.collection('jobs')
                    .where('installerId', '==', installerData.uid)
                    .where('scheduledDate', '>=', new Date(Date.now() - (14 * 24 * 60 * 60 * 1000)))
                    .where('scheduledDate', '<=', new Date(Date.now() + (14 * 24 * 60 * 60 * 1000)))
                    .orderBy('scheduledDate');

                // Real-time listener
                jobsUnsubscribe = jobsQuery.onSnapshot((snapshot) => {
                    jobs = [];
                    snapshot.forEach((doc) => {
                        jobs.push({ id: doc.id, ...doc.data() });
                    });
                    renderJobs();
                    updateWeekRange();
                });

                console.log('Jobs listener established');
            } catch (error) {
                console.error('Failed to load jobs:', error);
                showError('Failed to load jobs');
            }
        }

        // Render jobs
        function renderInstallerJobs() {
            const jobsList = document.getElementById('jobsList');
            const noJobs = document.getElementById('noJobs');

            if (jobs.length === 0) {
                jobsList.classList.add('hidden');
                noJobs.classList.remove('hidden');
                return;
            }

            jobsList.classList.remove('hidden');
            noJobs.classList.add('hidden');

            jobsList.innerHTML = jobs.map(job => `
                <div class="job-card bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md" onclick="showJobDetails('${job.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 text-lg">${job.title}</h3>
                            <div class="text-sm text-gray-600 mt-1">
                                <div><i class="fas fa-user mr-1"></i>${job.customer}</div>
                                <div><i class="fas fa-map-marker-alt mr-1"></i>${job.address}</div>
                                <div><i class="fas fa-clock mr-1"></i>${new Date(job.scheduledDate).toLocaleString()}</div>
                            </div>
                        </div>
                        <span class="px-3 py-1 text-xs font-medium rounded-full ${
                            job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                            job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${job.status.replace('-', ' ').toUpperCase()}
                        </span>
                    </div>
                    ${job.notes ? `<div class="text-sm text-gray-500 mt-2"><i class="fas fa-sticky-note mr-1"></i>${job.notes}</div>` : ''}
                    <div class="job-actions">
                        ${job.status === 'scheduled' ? `
                            <button onclick="event.stopPropagation(); updateJobStatus('${job.id}', 'in-progress')" class="bg-green-600 text-white rounded-lg hover:bg-green-700">
                                üöÄ Start Work
                            </button>
                        ` : ''}
                        ${job.status === 'in-progress' ? `
                            <button onclick="event.stopPropagation(); updateJobStatus('${job.id}', 'completed')" class="bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                ‚úÖ Complete
                            </button>
                        ` : ''}
                        <button onclick="event.stopPropagation(); showJobDetails('${job.id}')" class="bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            üìã Details
                        </button>
                        <button onclick="event.stopPropagation(); capturePhotoForJob('${job.id}', 'before')" class="bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üì∏ Before
                        </button>
                        <button onclick="event.stopPropagation(); capturePhotoForJob('${job.id}', 'after')" class="bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üì∏ After
                        </button>
                        <button onclick="event.stopPropagation(); capturePhotoForJob('${job.id}', 'defect')" class="bg-red-600 text-white rounded-lg hover:bg-red-700">
                            ‚ö†Ô∏è Defect
                        </button>
                        <button onclick="event.stopPropagation(); reportIssueForJob('${job.id}')" class="bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            üö® Issue
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update job status in Firestore
        async function updateJobStatus(jobId, newStatus) {
            try {
                const jobRef = db.collection('jobs').doc(jobId);
                
                await jobRef.update({
                    status: newStatus,
                    statusUpdatedAt: new Date(),
                    statusUpdatedBy: installerData.uid
                });

                console.log(`Job ${jobId} status updated to: ${newStatus}`);
            } catch (error) {
                console.error('Failed to update job status:', error);
                showError('Failed to update job status');
            }
        }

        // Camera capture for specific job (mobile-first)
        function capturePhotoForJob(jobId, type) {
            console.log('Capturing photo for job:', jobId, 'type:', type);
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            // Force camera on mobile devices
            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone')) {
                input.capture = 'environment'; // Use rear camera
                input.setAttribute('capture', 'environment');
            }
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log(`Captured ${type} photo for job ${jobId}:`, file.name);
                    await uploadPhotoToFirebase(file, type, jobId);
                }
            };
            
            input.click();
        }

        // Upload photo to Firebase Storage
        async function uploadPhotoToFirebase(file, type, jobId) {
            try {
                const fileName = `${jobId}/${type}_${Date.now()}_${file.name}`;
                
                console.log(`Uploading ${type} photo:`, {
                    fileName: fileName,
                    fileSize: file.size,
                    fileType: file.type
                });
                
                // Demo mode - simulate upload
                if (firebaseConfig.apiKey === "YOUR_ACTUAL_API_KEY") {
                    // Demo mode
                    alert(`${type} photo captured successfully for job ${jobId}!\nFile: ${file.name}\nSize: ${(file.size / 1024).toFixed(1)} KB\n\n(Demo mode - not actually uploaded)`);
                    return;
                }
                
                // Real Firebase upload
                const storageRef = storage.ref();
                const photoRef = storageRef.child(`job-photos/${fileName}`);
                
                // Upload file
                const snapshot = await photoRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                // Save photo metadata to Firestore
                const photoData = {
                    type: type,
                    fileName: fileName,
                    downloadURL: downloadURL,
                    fileSize: file.size,
                    capturedAt: new Date().toISOString(),
                    jobId: jobId,
                    installerId: installerData.uid,
                    installerName: installerData.name,
                    metadata: {
                        device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
                        location: 'job_site',
                        category: type === 'defect' ? 'issue' : 'documentation'
                    }
                };
                
                await db.collection('photos').add(photoData);
                
                console.log('Photo uploaded successfully:', photoData);
                alert(`${type} photo uploaded successfully for job ${jobId}!`);
                
            } catch (error) {
                console.error('Failed to upload photo:', error);
                showError('Failed to upload photo');
            }
        }

        // Get current job ID (context)
        function getCurrentJobId() {
            // In real app, this would come from current job context
            return jobs.length > 0 ? jobs[0].id : 'CURRENT_JOB';
        }

        // Report issue to Firestore
        async function submitIssue(event) {
            event.preventDefault();
            
            try {
                const issueData = {
                    jobId: document.getElementById('issueJobId').value,
                    category: document.getElementById('issueCategory').value,
                    description: document.getElementById('issueDescription').value,
                    reportedAt: new Date(),
                    installerId: installerData.uid,
                    installerName: installerData.name,
                    status: 'open',
                    photos: []
                };
                
                // Handle photo uploads
                const photoFiles = document.getElementById('issuePhotos').files;
                for (let i = 0; i < photoFiles.length; i++) {
                    const file = photoFiles[i];
                    const fileName = `issues/${issueData.jobId}_${Date.now()}_${file.name}`;
                    
                    const storageRef = storage.ref();
                    const photoRef = storageRef.child(fileName);
                    
                    await photoRef.put(file);
                    const downloadURL = await photoRef.getDownloadURL();
                    
                    issueData.photos.push({
                        fileName: fileName,
                        downloadURL: downloadURL,
                        fileSize: file.size
                    });
                }
                
                // Save issue to Firestore
                await db.collection('issues').add(issueData);
                
                console.log('Issue reported:', issueData);
                alert('Issue reported successfully');
                closeIssueModal();
                
            } catch (error) {
                console.error('Failed to submit issue:', error);
                showError('Failed to submit issue');
            }
        }

        // UI Functions
        function showPortal() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('portal').classList.remove('hidden');
        }

        function showJobDetails(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            const modal = document.getElementById('jobModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Title</label>
                        <div class="mt-1 text-gray-900">${job.title}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Customer</label>
                        <div class="mt-1 text-gray-900">${job.customer}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address</label>
                        <div class="mt-1 text-gray-900">${job.address}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Scheduled</label>
                        <div class="mt-1 text-gray-900">${new Date(job.scheduledDate).toLocaleString()}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status</label>
                        <div class="mt-1">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${
                                job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${job.status.replace('-', ' ').toUpperCase()}
                            </span>
                        </div>
                    </div>
                    ${job.notes ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                        <div class="mt-1 text-gray-900">${job.notes}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeJobModal() {
            document.getElementById('jobModal').classList.add('hidden');
        }

        // Report issue for specific job
        function reportIssueForJob(jobId) {
            const modal = document.getElementById('issueModal');
            const jobIdSelect = document.getElementById('issueJobId');
            
            // Set the specific job
            jobIdSelect.innerHTML = `<option value="${jobId}">${jobs.find(j => j.id === jobId)?.title || jobId}</option>`;
            jobIdSelect.value = jobId;
            
            modal.classList.remove('hidden');
        }

        function closeIssueModal() {
            document.getElementById('issueModal').classList.add('hidden');
            // Reset form
            document.getElementById('issueJobId').value = '';
            document.getElementById('issueCategory').value = 'manufacturer';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issuePhotos').value = '';
        }

        function previousWeek() {
            currentWeekOffset--;
            loadJobs();
        }

        function nextWeek() {
            currentWeekOffset++;
            loadJobs();
        }

        function updateWeekRange() {
            const today = new Date();
            const weekStart = new Date(today.getTime() + (currentWeekOffset * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + (6 * 24 * 60 * 60 * 1000));
            
            document.getElementById('weekRange').textContent = 
                `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
        }

        function showError(message) {
            alert(`Error: ${message}`);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }
    </script>
</body>
</html>
