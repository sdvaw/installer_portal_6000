<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installer Portal - v2025.01.18.2030</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>
    <!-- EmailJS for direct SMTP email sending -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Twilio SDK for SMS sending -->
    <script src="https://media.twiliocdn.com/sdk/js/twilio/2.0.0/twilio.min.js"></script>
    <style>
        /* Mobile-first design */
        .mobile-first { font-size: 16px; }
        @media (max-width: 640px) {
            .mobile-first { font-size: 18px; }
            .job-card { padding: 16px; }
            .btn { padding: 16px 20px; font-size: 18px; min-height: 48px; }
            .job-title { font-size: 20px; }
            .job-info { font-size: 16px; }
            .header { padding: 12px 16px; }
            .main-content { padding: 16px; }
        }
        .job-card { transition: all 0.3s ease; }
        .job-card:active { transform: scale(0.98); }
        .camera-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            min-height: 48px;
            font-size: 16px;
        }
        .camera-btn:active { transform: scale(0.95); }
        /* Mobile button layout */
        .job-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .job-actions button {
            padding: 12px 8px;
            font-size: 14px;
            min-height: 44px;
        }
        @media (max-width: 640px) {
            .job-actions {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .job-actions button {
                font-size: 16px;
                padding: 14px 12px;
            }
        }
        
        /* Retro Terminal Database Styles */
        body {
            background: #000000;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 255, 0, 0.03),
                    rgba(0, 255, 0, 0.03) 1px,
                    transparent 1px,
                    transparent 2px
                );
            min-height: 100vh;
            font-family: 'Courier New', 'Monaco', 'Consolas', monospace;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        .terminal-panel {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            border-radius: 0;
            box-shadow: 
                0 0 10px rgba(0, 255, 0, 0.5),
                inset 0 0 10px rgba(0, 255, 0, 0.1);
            position: relative;
        }

        .terminal-panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 0, 0.03) 2px,
                    rgba(0, 255, 0, 0.03) 4px
                );
            pointer-events: none;
        }

        .terminal-card {
            background: #0d0d0d;
            border: 1px solid #00ff00;
            border-radius: 0;
            padding: 20px;
            box-shadow: 
                0 0 5px rgba(0, 255, 0, 0.3),
                inset 0 0 5px rgba(0, 255, 0, 0.05);
            transition: all 0.2s ease;
            position: relative;
            min-height: 300px;
        }

        .terminal-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 255, 0, 0.02) 1px,
                    rgba(0, 255, 0, 0.02) 2px
                );
            pointer-events: none;
        }

        .terminal-card:hover {
            border-color: #00ff00;
            box-shadow: 
                0 0 15px rgba(0, 255, 0, 0.5),
                inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .terminal-button {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .terminal-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .terminal-button:hover::before {
            left: 100%;
        }

        .terminal-button:hover {
            background: #00ff00;
            color: #000000;
            box-shadow: 0 0 10px #00ff00;
        }

        .terminal-button:active {
            transform: scale(0.98);
        }

        .terminal-input {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            transition: all 0.2s ease;
        }

        .terminal-input::placeholder {
            color: rgba(0, 255, 0, 0.5);
        }

        .terminal-input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .terminal-header {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            border-bottom: none;
            position: relative;
        }

        .terminal-header::after {
            content: "DATABASE SYSTEM v1.0";
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 10px;
            color: rgba(0, 255, 0, 0.7);
            font-family: 'Courier New', monospace;
        }

        .text-terminal {
            color: #00ff00;
            text-shadow: 0 0 3px #00ff00;
            font-family: 'Courier New', monospace;
        }

        .text-terminal-muted {
            color: rgba(0, 255, 0, 0.7);
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.5);
        }

        .terminal-stat {
            background: #0d0d0d;
            border: 1px solid #00ff00;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .terminal-stat::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(0, 255, 0, 0.02) 1px,
                    rgba(0, 255, 0, 0.02) 2px
                );
            pointer-events: none;
        }

        .terminal-stat:hover {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .terminal-modal {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .terminal-modal-overlay {
            background: rgba(0, 0, 0, 0.8);
        }

        /* Cursor blink effect */
        @keyframes cursor-blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .cursor::after {
            content: "_";
            animation: cursor-blink 1s infinite;
            color: #00ff00;
        }

        /* Scan line effect */
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to bottom, transparent, rgba(0, 255, 0, 0.3), transparent);
            animation: scanline 8s linear infinite;
            pointer-events: none;
        }

        /* Flicker effect */
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.95; }
        }

        .flicker {
            animation: flicker 0.15s infinite;
        }

        /* Override default styles */
        .text-white {
            color: #00ff00;
            text-shadow: 0 0 3px #00ff00;
        }

        .text-gray-900 {
            color: #00ff00;
            text-shadow: 0 0 3px #00ff00;
        }

        .text-gray-600 {
            color: rgba(0, 255, 0, 0.8);
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.5);
        }

        .text-gray-500 {
            color: rgba(0, 255, 0, 0.6);
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.3);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
            border: 1px solid #00ff00;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border: 1px solid #00ff00;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }

        /* Select styling */
        select {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        select option {
            background: #0a0a0a;
            color: #00ff00;
        }

        /* Table styling */
        table {
            border: 1px solid #00ff00;
        }

        th, td {
            border: 1px solid rgba(0, 255, 0, 0.3);
            padding: 8px 12px;
        }

        th {
            background: rgba(0, 255, 0, 0.1);
            text-transform: uppercase;
            font-size: 12px;
        }
    </style>
</head>
<body class="mobile-first">
    <div id="app" class="min-h-screen">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen terminal-modal-overlay">
            <div class="terminal-panel p-8 max-w-md mx-4">
                <div class="scanline"></div>
                <div class="text-center">
                    <div class="text-4xl mb-4 flicker">üîß</div>
                    <div class="text-xl text-terminal font-bold cursor">LOADING INSTALLER DATABASE...</div>
                    <div class="text-sm text-terminal-muted mt-2">CONNECTING TO MAINFRAME...</div>
                    <div class="text-xs text-terminal-muted mt-4">[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%</div>
                </div>
            </div>
        </div>

        <!-- Main Portal (Hidden Initially) -->
        <div id="portal" class="hidden">
            <!-- Header -->
            <header class="terminal-header sticky top-0 z-50">
                <div class="scanline"></div>
                <div class="max-w-4xl mx-auto px-4 py-3">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="text-2xl mr-3">üîß</div>
                            <div>
                                <h1 class="text-lg font-bold text-terminal">INSTALLER_PORTAL.EXE</h1>
                                <div class="text-xs text-terminal-muted">FIREBASE_OPERATIONS_SYSTEM</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="installerName" class="text-sm font-medium text-terminal"></span>
                            <button onclick="logout()" class="text-terminal hover:text-white transition-colors">
                                [LOGOUT]
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-4xl mx-auto px-4 py-6">
                <!-- Installer Info -->
                <div class="terminal-card p-4 mb-6">
                    <div class="scanline"></div>
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-terminal font-medium">> CURRENT_INSTALLER:</div>
                            <div id="installerInfo" class="text-lg font-bold text-terminal"></div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-terminal font-medium">> CREW_ASSIGNMENT:</div>
                            <div id="crewInfo" class="text-lg font-bold text-terminal"></div>
                        </div>
                    </div>
                </div>

                <!-- Jobs Section -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-terminal">> JOB_DATABASE_QUERY</h2>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousWeek()" class="terminal-button px-3 py-2">
                                [<<]
                            </button>
                            <span id="weekRange" class="text-sm font-medium text-terminal"></span>
                            <button onclick="nextWeek()" class="terminal-button px-3 py-2">
                                [>>]
                            </button>
                        </div>
                    </div>

                    <!-- Jobs List -->
                    <div id="jobsList" class="space-y-4">
                        <!-- Jobs will be populated here -->
                    </div>

                    <!-- No Jobs Message -->
                    <div id="noJobs" class="hidden terminal-card p-8 text-center">
                        <div class="scanline"></div>
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-xl font-semibold text-terminal mb-2">> NO_JOBS_SCHEDULED</div>
                        <div class="text-terminal-muted">QUERY_RETURNED_EMPTY_SET</div>
                    </div>
                </div>

                <!-- Quick Actions - REMOVED (moved to job cards) -->
            </main>
        </div>
    </div>

    <!-- Installer Login Modal (Hidden Initially) -->
    <div id="installerLoginModal" class="fixed inset-0 terminal-modal-overlay z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="terminal-modal max-w-md w-full p-6">
                <div class="scanline"></div>
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîß</div>
                    <h2 class="text-xl font-bold text-terminal mb-2">INSTALLER_LOGIN.EXE</h2>
                    <p class="text-terminal-muted text-sm">ACCESS_YOUR_PORTAL</p>
                </div>
                
                <div id="installerLoginForm">
                    <div class="space-y-4">
                        <div>
                            <label class="text-terminal-muted text-sm">INSTALLER_NAME:</label>
                            <div id="installerNameDisplay" class="text-terminal font-bold"></div>
                        </div>
                        <div>
                            <label class="text-terminal-muted text-sm">EMAIL:</label>
                            <div id="installerEmailDisplay" class="text-terminal"></div>
                        </div>
                        <div>
                            <label class="text-terminal-muted text-sm">PASSWORD:</label>
                            <input type="password" id="installerPasswordInput" 
                                   class="terminal-input w-full" 
                                   placeholder="ENTER_PASSWORD">
                        </div>
                        <div class="border border-green-600 rounded p-3 bg-black/50">
                            <p class="text-terminal-muted text-xs mb-2">LOGIN_TOKEN:</p>
                            <p id="loginTokenDisplay" class="text-terminal text-xs break-all"></p>
                        </div>
                        <button onclick="authenticateInstaller()" class="w-full terminal-button">
                            [ACCESS_PORTAL]
                        </button>
                        <button onclick="cancelInstallerLogin()" class="w-full terminal-button">
                            [CANCEL]
                        </button>
                    </div>
                </div>
                
                <div id="installerLoginError" class="hidden">
                    <div class="border border-red-600 rounded p-4 bg-red-900/20">
                        <p class="text-red-400 text-center">‚ùå INVALID_LOGIN_TOKEN</p>
                        <p class="text-red-400 text-sm text-center mt-2">Please contact your administrator</p>
                    </div>
                    <button onclick="cancelInstallerLogin()" class="w-full terminal-button mt-4">
                        [CLOSE]
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="jobModal" class="fixed inset-0 terminal-modal-overlay z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="terminal-modal max-w-md w-full p-6">
                <div class="scanline"></div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-terminal">> JOB_DETAILS.EXE</h3>
                    <button onclick="closeJobModal()" class="text-terminal hover:text-white text-2xl font-bold transition-colors">
                        [X]
                    </button>
                </div>
                <div id="modalContent">
                    <!-- Job details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Report Modal -->
    <div id="issueModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Report Issue</h3>
                    <button onclick="closeIssueModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        √ó
                    </button>
                </div>
                <form onsubmit="submitIssue(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job</label>
                        <select id="issueJobId" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Select Job...</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="issueCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="manufacturer">Manufacturer Defect</option>
                            <option value="installer">Installer Mistake</option>
                            <option value="material">Missing Material</option>
                            <option value="damage">Damage Discovered</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="issueDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                        <input type="file" id="issuePhotos" multiple accept="image/*" class="w-full">
                    </div>
                    <button type="submit" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700">
                        Submit Issue
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYFdyiz_T_0Tsqya_CSKS4wRlWOEckMGk",
            authDomain: "installer-portal-6000.firebaseapp.com",
            projectId: "installer-portal-6000",
            storageBucket: "installer-portal-6000.firebasestorage.app",
            messagingSenderId: "582559700006",
            appId: "1:582559700006:web:e3b795dcf17501e310c2e7",
            measurementId: "G-93D62ZGLEJ"
        };

        // Initialize Firebase with error handling
        let auth, db, storage;
        
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            // Set to null for demo mode
            auth = null;
            db = null;
            storage = null;
        }

        // State
        let currentWeekOffset = 0;
        let installerData = null;
        let jobs = [];
        let jobsUnsubscribe = null;
        
        // TeamUp Configuration
        let teamupConfig = {
            apiKey: null,
            calendarId: null,
            syncInterval: 5, // minutes
            lastSync: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Installer Portal - Firebase System');
            
            // Check for installer login token FIRST
            checkInstallerLoginToken();
            
            // Load saved settings first
            loadSavedSettings();
            
            // Check URL for routing
            const path = window.location.pathname;
            console.log('üîç Current path:', path);
            console.log('üîç Full URL:', window.location.href);
            
            if (path.includes('/admin')) {
                // Admin portal
                console.log('Loading admin portal...');
                loadAdminPortal();
            } else if (path.includes('/installer-login')) {
                // Installer login page
                console.log('Loading installer login page...');
                // Don't load anything - let the token check handle it
            } else if (path.includes('/installer/')) {
                // Installer portal with unique ID
                const installerId = path.split('/installer/')[1];
                console.log('Loading installer portal for ID:', installerId);
                loadInstallerPortal(installerId);
            } else {
                // General landing page
                console.log('Loading landing page...');
                loadLandingPage();
            }
        });

        // Landing page function
        function loadLandingPage() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            // Show landing page
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div class="text-center">
                            <h1 class="text-4xl font-bold text-gray-900">üîß Installer Portal</h1>
                            <p class="mt-2 text-gray-600">Secure access for installers and administrators</p>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">üìã Installer Access</h3>
                                    <p class="text-sm text-gray-600">Use your unique portal link sent to your email</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">üëë Administrator Access</h3>
                                    <button onclick="window.location.href='/admin'" class="mt-2 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                        Admin Login
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Admin portal function
        function loadAdminPortal() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            // Show admin login screen
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                üëë Admin Portal
                            </h2>
                            <p class="mt-2 text-center text-sm text-gray-600">
                                Administrator access only
                            </p>
                            <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                                <p class="text-sm font-medium text-yellow-800">
                                    <strong>üîê Demo Credentials:</strong><br>
                                    Email: admin@company.com<br>
                                    Password: admin123
                                </p>
                            </div>
                        </div>
                        <form id="adminLoginForm" class="mt-8 space-y-6">
                            <div>
                                <label for="adminEmail" class="block text-sm font-medium text-gray-700">
                                    Admin Email
                                </label>
                                <input id="adminEmail" name="email" type="email" autocomplete="email" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter admin email" value="admin@company.com">
                            </div>

                            <div>
                                <label for="adminPassword" class="block text-sm font-medium text-gray-700">
                                    Admin Password
                                </label>
                                <input id="adminPassword" name="password" type="password" autocomplete="current-password" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter admin password" value="admin123">
                            </div>

                            <div>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    üîê Admin Sign In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup admin login form
            const adminLoginForm = document.getElementById('adminLoginForm');
            if (adminLoginForm) {
                console.log('Admin login form found, adding event listener...');
                adminLoginForm.addEventListener('submit', async function(e) {
                    console.log('Admin form submitted!');
                    e.preventDefault();
                    
                    const email = document.getElementById('adminEmail').value;
                    const password = document.getElementById('adminPassword').value;
                    
                    console.log(`Admin login attempt: ${email}`);
                    
                    // Demo admin login - accept any credentials for now
                    currentUser = {
                        uid: 'admin-123',
                        email: email,
                        displayName: 'Admin User',
                        role: 'admin'
                    };
                    
                    userRole = 'admin';
                    
                    console.log('Calling adminLogin function...');
                    try {
                        await adminLogin();
                        console.log('adminLogin completed successfully');
                    } catch (error) {
                        console.error('adminLogin failed:', error);
                        alert('Login failed: ' + error.message);
                    }
                });
            } else {
                console.error('Admin login form not found!');
            }
        }

        // Installer portal function
        function loadInstallerPortal(installerId) {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            // Show installer login screen
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                üîß Installer Portal
                            </h2>
                            <p class="mt-2 text-center text-sm text-gray-600">
                                Welcome Installer #${installerId}
                            </p>
                        </div>
                        <form id="installerLoginForm" class="mt-8 space-y-6">
                            <div>
                                <label for="installerEmail" class="block text-sm font-medium text-gray-700">
                                    Email
                                </label>
                                <input id="installerEmail" name="email" type="email" autocomplete="email" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter your email">
                            </div>

                            <div>
                                <label for="installerPassword" class="block text-sm font-medium text-gray-700">
                                    Password
                                </label>
                                <input id="installerPassword" name="password" type="password" autocomplete="current-password" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter your password">
                            </div>

                            <div>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    üîê Installer Sign In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup installer login form
            const installerLoginForm = document.getElementById('installerLoginForm');
            if (installerLoginForm) {
                installerLoginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('installerEmail').value;
                    const password = document.getElementById('installerPassword').value;
                    
                    console.log(`Installer login attempt: ${email} (ID: ${installerId})`);
                    
                    // Demo installer login
                    currentUser = {
                        uid: installerId,
                        email: email,
                        displayName: 'John Smith',
                        role: 'installer'
                    };
                    
                    userRole = 'installer';
                    await installerLogin();
                });
            }
        }

        // Admin login function
        async function adminLogin() {
            console.log('=== STARTING ADMIN LOGIN ===');
            
            // Create admin data
            installerData = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                role: 'admin',
                crews: ['All Crews'],
                active: true
            };
            
            console.log('Admin data created:', installerData);
            
            // Show admin dashboard - NO showPortal() call needed
            renderAdminDashboard();
            
            console.log('=== ADMIN LOGIN COMPLETED ===');
        }

        // Installer login function
        async function installerLogin() {
            console.log('=== STARTING INSTALLER LOGIN ===');
            
            // Create installer data
            installerData = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                crews: ['Crew A', 'Crew B'],
                active: true
            };
            
            console.log('Installer data created:', installerData);
            
            // Load installer availability
            await loadInstallerAvailability();
            
            // Create demo jobs
            jobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew B',
                    notes: 'Remove old door frame, install new entry door'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal'
                }
            ];
            
            console.log('Demo jobs created:', jobs);
            
            // Update UI
            document.getElementById('installerName').textContent = installerData.name;
            document.getElementById('installerInfo').textContent = installerData.name;
            
            // Show installer dashboard
            renderInstallerDashboard();
            
            console.log('=== INSTALLER LOGIN COMPLETED ===');
            showPortal();
        }

        // Show portal function
        function showPortal() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('portal').classList.remove('hidden');
        }

        // Render admin dashboard
        function renderAdminDashboard() {
            console.log('Rendering admin dashboard...');
            
            // The app element should exist because we just created it in loadAdminPortal
            const appElement = document.getElementById('app');
            console.log('App element found:', !!appElement);
            
            if (!appElement) {
                console.error('App element not found! Current DOM:', document.body.innerHTML);
                return;
            }
            
            console.log('Setting admin dashboard HTML...');
            appElement.innerHTML = `
                <!-- Admin Header -->
                <div class="min-h-screen">
                    <header class="terminal-header sticky top-0 z-50">
                        <div class="scanline"></div>
                        <div class="max-w-4xl mx-auto px-4 py-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="text-2xl mr-3">üëë</div>
                                    <div>
                                        <h1 class="text-lg font-bold text-terminal">ADMIN_CONSOLE.EXE</h1>
                                        <div class="text-xs text-terminal-muted">INSTALLER_MANAGEMENT_SYSTEM</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm font-medium text-terminal">${installerData.name} (ADMIN)</span>
                                    <button onclick="location.reload()" class="text-terminal hover:text-white transition-colors">
                                        [LOGOUT]
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-4xl mx-auto px-4 py-6">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-terminal">> ADMIN_DASHBOARD_MAIN</h2>
                            <p class="text-terminal-muted">SYSTEM_CONTROL_INTERFACE</p>
                        </div>
                        
                        <!-- Admin Actions -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="terminal-card p-4 border-l-4 border-green-500">
                                <div class="scanline"></div>
                                <h3 class="font-semibold text-terminal mb-2">> INSTALLER_MANAGEMENT</h3>
                                <p class="text-sm text-terminal-muted mb-3">ADD_EDIT_MANAGE_ACCOUNTS</p>
                                <button onclick="showInstallerManagement()" class="terminal-button">
                                    [MANAGE_INSTALLERS]
                                </button>
                            </div>
                            
                            <div class="terminal-card p-4 border-l-4 border-cyan-500">
                                <div class="scanline"></div>
                                <h3 class="font-semibold text-terminal mb-2">> SYSTEM_SETTINGS</h3>
                                <p class="text-sm text-terminal-muted mb-3">CONFIGURE_TEAMUP_SYNC</p>
                                <button onclick="showSystemSettings()" class="terminal-button">
                                    [SETTINGS]
                                </button>
                            </div>
                            
                            <div class="terminal-card p-4 border-l-4 border-yellow-500">
                                <div class="scanline"></div>
                                <h3 class="font-semibold text-terminal mb-2">> CALENDAR_VIEW</h3>
                                <p class="text-sm text-terminal-muted mb-3">VIEW_ALL_SCHEDULES</p>
                                <button onclick="showAdminCalendarView()" class="terminal-button">
                                    [CALENDARS]
                                </button>
                            </div>
                            
                            <div class="terminal-card p-4 border-l-4 border-orange-500">
                                <div class="scanline"></div>
                                <h3 class="font-semibold text-terminal mb-2">> PROVISIONING</h3>
                                <p class="text-sm text-terminal-muted mb-3">CREATE_NEW_ACCOUNTS</p>
                                <button onclick="showNewInstallerProvisioning()" class="terminal-button">
                                    [PROVISION]
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="dashboardStats">
                            <div class="terminal-stat">
                                <div class="scanline"></div>
                                <div class="text-2xl font-bold text-terminal" id="totalInstallersCount">LOADING...</div>
                                <div class="text-sm text-terminal-muted">TOTAL_INSTALLERS</div>
                            </div>
                            <div class="terminal-stat">
                                <div class="scanline"></div>
                                <div class="text-2xl font-bold text-terminal" id="activeInstallersCount">LOADING...</div>
                                <div class="text-sm text-terminal-muted">ACTIVE_INSTALLERS</div>
                            </div>
                            <div class="terminal-stat">
                                <div class="scanline"></div>
                                <div class="text-2xl font-bold text-terminal" id="pendingProvisionCount">LOADING...</div>
                                <div class="text-sm text-terminal-muted">NEED_PROVISIONING</div>
                            </div>
                            <div class="terminal-stat">
                                <div class="scanline"></div>
                                <div class="text-2xl font-bold text-terminal" id="lastSyncStatus">LOADING...</div>
                                <div class="text-sm text-terminal-muted">LAST_SYNC_STATUS</div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="terminal-card p-4">
                            <div class="scanline"></div>
                            <h3 class="font-semibold text-terminal mb-3">> RECENT_ACTIVITY_LOG</h3>
                            <div class="space-y-2" id="recentActivity">
                                <div class="text-sm text-terminal-muted">LOADING_ACTIVITY_DATA...</div>
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            // Load real dashboard stats
            loadDashboardStats();
            
            console.log('Admin dashboard rendered successfully!');
        }

        // Load real dashboard statistics
        async function loadDashboardStats() {
            console.log('üìä Loading dashboard stats...');
            
            try {
                let installersList = [];
                
                // Load installers from Firebase
                if (db) {
                    const installersSnapshot = await db.collection('installers').get();
                    installersSnapshot.forEach(doc => {
                        installersList.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const totalInstallers = installersList.length;
                    const activeInstallers = installersList.filter(i => i.status === 'active').length;
                    
                    // Update installer counts
                    document.getElementById('totalInstallersCount').textContent = totalInstallers;
                    document.getElementById('activeInstallersCount').textContent = activeInstallers;
                    
                    console.log(`üìä Installers: ${totalInstallers} total, ${activeInstallers} active`);
                }
                
                // Check for new installers needing provisioning
                if (teamupConfig.apiKey && teamupConfig.calendarId) {
                    try {
                        const response = await fetch(`https://api.teamup.com/${teamupConfig.calendarId}/subcalendars`, {
                            headers: { 'Teamup-Token': teamupConfig.apiKey }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const teamUpInstallers = data.subcalendars || [];
                            
                            // Get existing installer names
                            const existingInstallers = new Set();
                            installersList.forEach(installer => {
                                if (installer.name) existingInstallers.add(installer.name);
                            });
                            
                            // Find installers needing provisioning
                            const pendingProvision = teamUpInstallers.filter(installer => 
                                installer.name && !existingInstallers.has(installer.name)
                            );
                            
                            document.getElementById('pendingProvisionCount').textContent = pendingProvision.length;
                            console.log(`üìä Pending provision: ${pendingProvision.length} installers`);
                        }
                    } catch (error) {
                        console.error('‚ùå Failed to check provisioning status:', error);
                        document.getElementById('pendingProvisionCount').textContent = 'Error';
                    }
                } else {
                    document.getElementById('pendingProvisionCount').textContent = 'Not Configured';
                }
                
                // Update sync status
                const lastSync = localStorage.getItem('teamupLastSync');
                if (lastSync) {
                    const syncDate = new Date(lastSync);
                    const now = new Date();
                    const hoursAgo = Math.floor((now - syncDate) / (1000 * 60 * 60));
                    
                    if (hoursAgo < 1) {
                        document.getElementById('lastSyncStatus').textContent = 'Just Now';
                        document.getElementById('lastSyncStatus').className = 'text-2xl font-bold text-green-600';
                    } else if (hoursAgo < 24) {
                        document.getElementById('lastSyncStatus').textContent = `${hoursAgo}h ago`;
                        document.getElementById('lastSyncStatus').className = 'text-2xl font-bold text-blue-600';
                    } else {
                        document.getElementById('lastSyncStatus').textContent = `${Math.floor(hoursAgo / 24)}d ago`;
                        document.getElementById('lastSyncStatus').className = 'text-2xl font-bold text-orange-600';
                    }
                } else {
                    document.getElementById('lastSyncStatus').textContent = 'Never';
                    document.getElementById('lastSyncStatus').className = 'text-2xl font-bold text-red-600';
                }
                
                // Load recent activity (jobs)
                if (db) {
                    const jobsSnapshot = await db.collection('jobs').orderBy('createdAt', 'desc').limit(5).get();
                    const recentJobs = [];
                    jobsSnapshot.forEach(doc => {
                        recentJobs.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const activityHtml = recentJobs.length > 0 ? recentJobs.map(job => `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <div>
                                <span class="font-medium">${job.title}</span>
                                <span class="text-sm text-gray-600 ml-2">${job.customer}</span>
                            </div>
                            <div class="text-sm">
                                <span class="px-2 py-1 rounded text-xs ${job.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${job.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('') : '<div class="text-sm text-gray-500">No recent activity</div>';
                    
                    document.getElementById('recentActivity').innerHTML = activityHtml;
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load dashboard stats:', error);
                document.getElementById('totalInstallersCount').textContent = 'Error';
                document.getElementById('activeInstallersCount').textContent = 'Error';
                document.getElementById('pendingProvisionCount').textContent = 'Error';
                document.getElementById('lastSyncStatus').textContent = 'Error';
            }
        }

        // Show admin calendar view
        async function showAdminCalendarView() {
            console.log('Loading admin calendar view...');
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <!-- Calendar View Header -->
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">üìÖ Admin Calendar View</h2>
                            <p class="text-gray-600">View all installer schedules and TeamUp calendars</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="refreshAdminCalendar()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                üîÑ Refresh
                            </button>
                            <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Dashboard
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Controls -->
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">View Mode</label>
                                <select id="calendarViewMode" onchange="renderAdminCalendar()" 
                                        class="mt-1 px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="all">All Calendars</option>
                                    <option value="subcalendars">Sub-Calendars Only</option>
                                    <option value="events">Events Only</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date Range</label>
                                <select id="dateRange" onchange="renderAdminCalendar()" 
                                        class="mt-1 px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar Content -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- TeamUp Calendars -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìÖ TeamUp Calendars</h3>
                            <div id="adminCalendarsList" class="space-y-3">
                                <div class="text-sm text-gray-500">Loading calendars...</div>
                            </div>
                        </div>
                        
                        <!-- Recent Events -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìã Recent Events</h3>
                            <div id="adminEventsList" class="space-y-3">
                                <div class="text-sm text-gray-500">Loading events...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load calendar data
                await loadAdminCalendarData();
            }
        }

        // Load admin calendar data
        async function loadAdminCalendarData() {
            console.log('üìÖ Loading admin calendar data...');
            
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                document.getElementById('adminCalendarsList').innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">‚ö†Ô∏è TeamUp not configured. Please configure TeamUp settings first.</p>
                    </div>
                `;
                return;
            }
            
            const viewMode = document.getElementById('calendarViewMode')?.value || 'all';
            const dateRange = document.getElementById('dateRange')?.value || 'week';
            
            try {
                // Load calendars/subcalendars
                if (viewMode === 'all' || viewMode === 'subcalendars') {
                    const calendarsResponse = await fetch(`https://api.teamup.com/${teamupConfig.calendarId}/subcalendars`, {
                        headers: { 'Teamup-Token': teamupConfig.apiKey }
                    });
                    
                    if (calendarsResponse.ok) {
                        const calendarsData = await calendarsResponse.json();
                        const calendars = calendarsData.subcalendars || [];
                        
                        const calendarsHtml = calendars.map(calendar => `
                            <div class="border border-gray-200 rounded-lg p-4 ${calendar.active ? 'bg-green-50' : 'bg-gray-50'}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${calendar.name}</h4>
                                        <p class="text-sm text-gray-600">ID: ${calendar.id}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs rounded ${calendar.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${calendar.active ? 'ACTIVE' : 'INACTIVE'}
                                        </span>
                                        <div class="w-4 h-4 rounded" style="background-color: ${calendar.color || '#3B82F6'}"></div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600">
                                    ${calendar.notes || 'No description available'}
                                </div>
                            </div>
                        `).join('');
                        
                        document.getElementById('adminCalendarsList').innerHTML = calendarsHtml;
                        console.log(`üìÖ Loaded ${calendars.length} calendars`);
                    }
                }
                
                // Load events
                if (viewMode === 'all' || viewMode === 'events') {
                    const dateRangeParams = getDateRangeParams(dateRange);
                    const eventsResponse = await fetch(`https://api.teamup.com/${teamupConfig.calendarId}/events${dateRangeParams}`, {
                        headers: { 'Teamup-Token': teamupConfig.apiKey }
                    });
                    
                    if (eventsResponse.ok) {
                        const eventsData = await eventsResponse.json();
                        const events = eventsData.events || [];
                        
                        const eventsHtml = events.slice(0, 10).map(event => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900">${event.title}</h4>
                                        <p class="text-sm text-gray-600">${new Date(event.start_dt).toLocaleDateString()}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded ${getEventStatusColor(event.status)}">
                                        ${event.status?.toUpperCase() || 'SCHEDULED'}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <p><strong>Who:</strong> ${event.who?.map(w => w.name).join(', ') || 'Unassigned'}</p>
                                    <p><strong>Where:</strong> ${event.location?.name || 'No location'}</p>
                                    ${event.notes ? `<p><strong>Notes:</strong> ${event.notes}</p>` : ''}
                                </div>
                            </div>
                        `).join('');
                        
                        document.getElementById('adminEventsList').innerHTML = eventsHtml;
                        console.log(`üìÖ Loaded ${events.length} events`);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load calendar data:', error);
                document.getElementById('adminCalendarsList').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800">‚ùå Failed to load calendar data: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Get date range parameters for TeamUp API
        function getDateRangeParams(range) {
            const now = new Date();
            const startDate = new Date(now);
            const endDate = new Date(now);
            
            switch (range) {
                case 'week':
                    startDate.setDate(now.getDate() - now.getDay()); // Start of week
                    endDate.setDate(startDate.getDate() + 6); // End of week
                    break;
                case 'month':
                    startDate.setDate(1); // Start of month
                    endDate.setMonth(now.getMonth() + 1, 0); // Start of next month
                    break;
                case 'quarter':
                    const currentMonth = now.getMonth();
                    const quarterStart = Math.floor(currentMonth / 3) * 3;
                    startDate.setMonth(quarterStart, 1); // Start of quarter
                    endDate.setMonth(quarterStart + 3, 0); // Start of next quarter
                    break;
            }
            
            return `?start_dt=${startDate.toISOString().split('T')[0]}&end_dt=${endDate.toISOString().split('T')[0]}`;
        }

        // Get event status color
        function getEventStatusColor(status) {
            switch (status) {
                case 'completed': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                case 'in_progress': return 'bg-blue-100 text-blue-800';
                default: return 'bg-yellow-100 text-yellow-800';
            }
        }

        // Refresh admin calendar
        async function refreshAdminCalendar() {
            console.log('üîÑ Refreshing admin calendar...');
            await loadAdminCalendarData();
        }
        let installers = [];
        let editingInstaller = null;

        // Show installer management interface
        function showInstallerManagement() {
            console.log('Loading installer management...');
            
            // Load demo installers
            loadDemoInstallers();
            
            // Replace main content with installer management
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <!-- Installer Management Header -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <button onclick="renderAdminDashboard()" class="terminal-button">
                                [BACK_TO_DASHBOARD]
                            </button>
                            <div>
                                <h2 class="text-2xl font-bold text-terminal">> INSTALLER_MANAGEMENT</h2>
                                <p class="text-terminal-muted">MANAGE_INSTALLER_ACCOUNTS</p>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="showAddInstallerForm()" class="terminal-button">
                                [ADD_INSTALLER]
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="terminal-card p-4 mb-6">
                        <div class="scanline"></div>
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <input type="text" id="installerSearch" placeholder="SEARCH_INSTALLERS..." 
                                   class="flex-1 terminal-input"
                                   onkeyup="renderInstallerCards()">
                            <select id="installerStatusFilter" onchange="renderInstallerCards()" 
                                    class="terminal-input">
                                <option value="">ALL_STATUS</option>
                                <option value="active">ACTIVE</option>
                                <option value="inactive">INACTIVE</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Simple Installer List -->
                    <div class="terminal-card p-6 mb-6">
                        <div class="scanline"></div>
                        <h3 class="text-xl font-bold text-terminal mb-4">> INSTALLER_LIST</h3>
                        
                        <div id="simpleInstallerList" class="space-y-4">
                            <!-- Installers will be listed here -->
                        </div>
                    </div>
                `;
                
                // Render installer cards
                renderInstallerCards();
            }
        }

        // Load demo installers
        function loadDemoInstallers() {
            if (db) {
                // Load from Firebase (not real-time - just once)
                console.log('üì• Loading installers from Firebase...');
                db.collection('installers').get().then((snapshot) => {
                    installers = [];
                    snapshot.forEach((doc) => {
                        installers.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('‚úÖ Installers loaded from Firebase:', installers.length);
                    console.log('üìã Installers data:', installers);
                    renderInstallerCards();
                }).catch((error) => {
                    console.error('‚ùå Error loading installers:', error);
                    // Fallback to demo data
                    loadDemoInstallersFallback();
                });
            } else {
                // Fallback to demo data
                loadDemoInstallersFallback();
            }
        }

        // Fallback demo installers
        function loadDemoInstallersFallback() {
            installers = [
                {
                    id: 'installer-001',
                    name: 'John Smith',
                    email: 'john.smith@company.com',
                    phone: '(555) 123-4567',
                    crews: ['Crew A', 'Crew B'],
                    status: 'active',
                    createdAt: new Date('2024-01-15'),
                    notes: 'Senior installer, specializes in windows'
                },
                {
                    id: 'installer-002', 
                    name: 'Mike Johnson',
                    email: 'mike.johnson@company.com',
                    phone: '(555) 234-5678',
                    crews: ['Crew C'],
                    status: 'active',
                    createdAt: new Date('2024-02-20'),
                    notes: 'New hire, training in progress'
                },
                {
                    id: 'installer-003',
                    name: 'Sarah Davis',
                    email: 'sarah.davis@company.com', 
                    phone: '(555) 345-6789',
                    crews: ['Crew A'],
                    status: 'inactive',
                    createdAt: new Date('2024-01-10'),
                    notes: 'On medical leave'
                }
            ];
        }

        // Get invite status styling class
        function getInviteStatusClass(status) {
            switch (status) {
                case 'SENT':
                    return 'text-yellow-400';
                case 'ACCEPTED':
                    return 'text-green-400';
                case 'DELIVERED':
                    return 'text-cyan-400';
                case 'BOUNCED':
                    return 'text-red-400';
                case 'OPENED':
                    return 'text-blue-400';
                default:
                    return 'text-gray-400';
            }
        }

        // Simple installer list rendering
        function renderInstallerCards() {
            const listContainer = document.getElementById('simpleInstallerList');
            if (!listContainer) return;
            
            const searchTerm = document.getElementById('installerSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('installerStatusFilter')?.value || '';
            
            let filteredInstallers = installers.filter(installer => {
                const matchesSearch = installer.name && installer.email && installer.phone && 
                               (installer.name.toLowerCase().includes(searchTerm) || 
                                installer.email.toLowerCase().includes(searchTerm) ||
                                installer.phone.includes(searchTerm));
                const matchesStatus = !statusFilter || installer.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            listContainer.innerHTML = filteredInstallers.map(installer => `
                <div class="border border-green-600 rounded-lg p-6 bg-black/60 hover:bg-green-950/40 transition-all duration-200 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-terminal mb-2">${installer.name || 'Unknown'}</h4>
                            <p class="text-sm text-terminal-muted">ID: ${installer.id}</p>
                        </div>
                        <span class="px-4 py-2 text-sm font-bold ${installer.status === 'active' ? 'bg-green-900 text-green-400 border-green-500' : 'bg-red-900 text-red-400 border-red-500'} rounded-full border">
                            ${installer.status?.toUpperCase() || 'UNKNOWN'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4 text-sm">
                        <div>
                            <span class="text-terminal-muted block mb-1">EMAIL:</span>
                            <span class="text-terminal block">${installer.email || 'No email'}</span>
                        </div>
                        <div>
                            <span class="text-terminal-muted block mb-1">PHONE:</span>
                            <span class="text-terminal block">${installer.phone || 'No phone'}</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <button onclick="copyInstallerLink('${installer.id}', '${installer.name}', '${installer.email}', '${installer.phone || 'installer123'}')" 
                                class="terminal-button py-3 px-6 text-sm font-medium hover:scale-105 transition-transform">
                            üìã COPY_LINK
                        </button>
                        <button onclick="editInstaller('${installer.id}')" 
                                class="terminal-button py-3 px-6 text-sm font-medium hover:scale-105 transition-transform">
                            ‚úèÔ∏è EDIT
                        </button>
                        <button onclick="viewInstallerDetails('${installer.id}')" 
                                class="terminal-button py-3 px-6 text-sm font-medium hover:scale-105 transition-transform">
                            üìã DETAILS
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Copy installer login link function
        function copyInstallerLink(installerId, name, email, password) {
            alert('TEST: NEW CODE IS DEPLOYED!');
            console.log('üìã Copy link function called - VERSION 2.0');
            console.log('üìã Installer:', name);
            console.log('üìã Email:', email);
            console.log('üìã Password:', password);
            
            // Generate secure token with timestamp
            const timestamp = Date.now().toString();
            const tokenData = `${installerId}:${email}:${timestamp}`;
            const token = btoa(tokenData);
            
            const loginLink = window.location.origin + '/installer-login?installer=' + installerId + '&token=' + token;
            
            console.log('üìã Generated link:', loginLink);
            
            // Copy link to clipboard
            navigator.clipboard.writeText(loginLink).then(() => {
                // Show success message with all details
                const message = `‚úÖ Login Link Copied!\n\nINSTALLER: ${name}\nEMAIL: ${email}\nPASSWORD: ${password}\n\nLINK: ${loginLink}\n\nSend this link to the installer with their login details!`;
                alert(message);
                console.log('üìã Link copied to clipboard:', loginLink);
            }).catch(err => {
                console.error('‚ùå Failed to copy link:', err);
                // Fallback: show link in alert
                alert(`üìã Copy this link manually:\n\n${loginLink}\n\nInstaller: ${name}\nEmail: ${email}\nPassword: ${password}`);
            });
        }

        // Toggle installer status
        function toggleInstallerStatus(installerId) {
            const installer = installers.find(i => i.id === installerId);
            if (!installer) return;
            
            const newStatus = installer.status === 'active' ? 'inactive' : 'active';
            
            if (db) {
                db.collection('installers').doc(installerId).update({ status: newStatus })
                    .then(() => {
                        installer.status = newStatus;
                        renderInstallerCards();
                    })
                    .catch(error => {
                        console.error('‚ùå Failed to update status:', error);
                        alert('Failed to update status');
                    });
            }
        }

        // Check for installer login token on page load
        function checkInstallerLoginToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const installerId = urlParams.get('installer');
            
            console.log('üîç Checking for login token...');
            console.log('üîç Token:', token);
            console.log('üîç Installer ID:', installerId);
            console.log('üîç Current URL:', window.location.search);
            
            if (token && installerId) {
                console.log('üîë Detected installer login token');
                showInstallerLogin(token, installerId);
            } else {
                console.log('üîç No login token found, showing default installer portal');
            }
        }

        // Show installer login modal
        function showInstallerLogin(token, installerId) {
            try {
                // Decode token to verify it's valid
                const decodedToken = atob(token);
                const [tokenInstallerId, tokenEmail, tokenTimestamp] = decodedToken.split(':');
                
                console.log('üîç Token verification debug:');
                console.log('üîç Token installer ID:', tokenInstallerId);
                console.log('üîç Token email:', tokenEmail);
                console.log('üîç Expected installer ID:', installerId);
                
                // Verify token matches installer ID
                if (tokenInstallerId !== installerId) {
                    throw new Error('Token mismatch');
                }
                
                // Check if token is not too old (24 hours)
                const tokenAge = Date.now() - parseInt(tokenTimestamp);
                if (tokenAge > 24 * 60 * 60 * 1000) {
                    throw new Error('Token expired');
                }
                
                // Load installer data
                if (db) {
                    db.collection('installers').doc(installerId).get()
                        .then(doc => {
                            if (doc.exists) {
                                const installer = { id: doc.id, ...doc.data() };
                                
                                // Verify email matches
                                if (installer.email !== tokenEmail) {
                                    throw new Error('Email mismatch');
                                }
                                
                                // Show login form
                                document.getElementById('installerNameDisplay').textContent = installer.name;
                                document.getElementById('installerEmailDisplay').textContent = installer.email;
                                document.getElementById('loginTokenDisplay').textContent = token;
                                document.getElementById('installerLoginForm').classList.remove('hidden');
                                document.getElementById('installerLoginError').classList.add('hidden');
                                document.getElementById('installerLoginModal').classList.remove('hidden');
                                
                                // Store current installer data
                                window.currentInstallerLogin = { installer, token };
                                
                            } else {
                                throw new Error('Installer not found');
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Error loading installer:', error);
                            showInstallerLoginError();
                        });
                } else {
                    throw new Error('Database not available');
                }
                
            } catch (error) {
                console.error('‚ùå Invalid token:', error);
                showInstallerLoginError();
            }
        }

        // Authenticate installer
        function authenticateInstaller() {
            if (window.currentInstallerLogin) {
                const { installer, token } = window.currentInstallerLogin;
                
                // Get password from input
                const password = document.getElementById('installerPasswordInput').value;
                
                // Debug - show what we're comparing
                console.log('üîç Password check debug:');
                console.log('üîç Entered password:', password);
                console.log('üîç Installer phone:', installer.phone);
                console.log('üîç Expected password:', installer.phone || 'installer123');
                
                // Simple password check - try both possible passwords
                const cleanPhone = installer.phone ? installer.phone.replace(/\D/g, '').trim() : '';
                const possiblePasswords = [cleanPhone, 'installer123'];
                
                // Debug alert - show exact values
                alert(`üîç Password Debug:\n\nTyped: "${password}"\nPhone: "${cleanPhone}"\nTrying: ${possiblePasswords.join(' or ')}`);
                
                if (!possiblePasswords.includes(password)) {
                    alert('‚ùå Incorrect password! Try: ' + possiblePasswords.join(' or '));
                    return;
                }
                
                // Update installer login status
                const loginData = {
                    lastLogin: new Date().toISOString(),
                    loginMethod: 'EMAIL_LINK',
                    loginToken: token,
                    loginStatus: 'SUCCESS',
                    password: password // Store the password that worked
                };
                
                db.collection('installers').doc(installer.id).update(loginData)
                    .then(() => {
                        console.log('‚úÖ Installer authenticated successfully');
                        console.log('üîç About to update invite status...');
                        console.log('üîç Installer object being passed to showInstallerPortal:', installer);
                        
                        // Update invite status to ACCEPTED
                        return db.collection('installers').doc(installer.id).update({
                            inviteStatus: 'ACCEPTED'
                        });
                    })
                    .then(() => {
                        console.log('‚úÖ Invite status updated successfully');
                        console.log('üîç About to call showInstallerPortal with installer:', installer);
                        
                        // Hide login modal
                        document.getElementById('installerLoginModal').classList.add('hidden');
                        
                        // Show installer portal
                        showInstallerPortal(installer);
                    })
                    .catch(error => {
                        console.error('‚ùå Error updating installer login:', error);
                        console.error('‚ùå Full error details:', JSON.stringify(error));
                        alert('‚ùå Login failed. Please try again.');
                    });
            }
        }

        // Show installer portal
        function showInstallerPortal(installer) {
            if (!installer) {
                console.error('‚ùå showInstallerPortal called with null installer');
                return;
            }
            
            // Store installer data globally for calendar functions
            window.installerData = installer;
            
            // Hide admin login and show installer portal
            const adminLoginEl = document.getElementById('adminLogin');
            if (adminLoginEl) adminLoginEl.classList.add('hidden');
            
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.classList.add('hidden');
            
            const portalEl = document.getElementById('portal');
            if (portalEl) portalEl.classList.remove('hidden');
            
            // Update installer name display
            const installerNameEl = document.getElementById('installerName');
            if (installerNameEl) installerNameEl.textContent = installer.name;
            
            const installerInfoEl = document.getElementById('installerInfo');
            if (installerInfoEl) installerInfoEl.textContent = `${installer.name} - ${installer.email}`;
            
            const crewInfoEl = document.getElementById('crewInfo');
            if (crewInfoEl) crewInfoEl.textContent = (installer.crews || []).join(', ') || 'No crew assigned';
            
            // Load installer jobs - pass installer object to avoid auth issues
            loadInstallerJobs(installer);
            
            console.log('üîß Installer portal loaded for:', installer.name);
        }

        // Show installer login error
        function showInstallerLoginError() {
            document.getElementById('installerLoginForm').classList.add('hidden');
            document.getElementById('installerLoginError').classList.remove('hidden');
            document.getElementById('installerLoginModal').classList.remove('hidden');
        }

        // Cancel installer login
        function cancelInstallerLogin() {
            document.getElementById('installerLoginModal').classList.add('hidden');
            window.currentInstallerLogin = null;
            
            // Clear URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Load installer jobs
        function loadInstallerJobs(installer) {
            // This would load jobs specific to this installer
            // For now, show empty state
            document.getElementById('jobsList').innerHTML = `
                <div class="terminal-card p-6 text-center">
                    <div class="scanline"></div>
                    <div class="text-4xl mb-4">üìã</div>
                    <div class="text-xl font-semibold text-terminal mb-2">> LOADING_JOBS...</div>
                    <div class="text-terminal-muted">FETCHING_ASSIGNMENTS...</div>
                </div>
            `;
            
            // Simulate loading jobs
            setTimeout(() => {
                document.getElementById('jobsList').innerHTML = `
                    <div class="terminal-card p-6 text-center">
                        <div class="scanline"></div>
                        <div class="text-4xl mb-4">üìã</div>
                        <div class="text-xl font-semibold text-terminal mb-2">> NO_JOBS_SCHEDULED</div>
                        <div class="text-terminal-muted">CHECK_BACK_LATER...</div>
                    </div>
                `;
            }, 2000);
        }

        // Toggle installer status
        function toggleInstallerStatus(installerId) {
            const installer = installers.find(i => i.id === installerId);
            if (!installer) return;
            
            const newStatus = installer.status === 'active' ? 'inactive' : 'active';
            
            if (db) {
                db.collection('installers').doc(installerId).update({ status: newStatus })
                .then(() => {
                    console.log(`‚úÖ Updated ${installer.name} status to ${newStatus}`);
                    installer.status = newStatus;
                    renderInstallerCards();
                })
                .catch(error => {
                    console.error('‚ùå Failed to update status:', error);
                    alert('Failed to update status');
                });
            }
        }

        // Send installer invite
        function sendInstallerInvite(installerId) {
            const installer = installers.find(i => i.id === installerId);
            if (!installer) return;
            
            if (!installer.email) {
                alert('Installer must have an email address to send an invite.');
                return;
            }
            
            // TODO: Implement email sending logic
            alert(`üìß Invite sent to ${installer.name} at ${installer.email}\n\n(This would send an actual email with login credentials)`);
        }

        // Show bulk email edit interface
        function showBulkEmailEdit() {
            const mainElement = document.querySelector('main');
            if (!mainElement) return;
            
            mainElement.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">üìß Bulk Edit Installer Emails</h2>
                        <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ‚Üê Back to Installers
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <p class="text-sm text-gray-600 mb-4">Update email addresses for multiple installers at once:</p>
                        <div class="space-y-4">
                            ${installers.map(installer => `
                                <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">${installer.name || 'Unknown'}</label>
                                        <input type="email" id="bulk-email-${installer.id}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                               placeholder="${installer.email || 'Enter email address'}"
                                               value="${installer.email || ''}">
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ${installer.email ? 'Current: ' + installer.email : 'No email set'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button onclick="showInstallerManagement()" 
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="saveBulkEmails()" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                üíæ Save All Emails
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Save bulk email updates
        function saveBulkEmails() {
            const updates = [];
            
            installers.forEach(installer => {
                const emailInput = document.getElementById(`bulk-email-${installer.id}`);
                if (emailInput) {
                    const newEmail = emailInput.value.trim();
                    if (newEmail && newEmail !== installer.email) {
                        updates.push({
                            id: installer.id,
                            email: newEmail
                        });
                    }
                }
            });
            
            if (updates.length === 0) {
                alert('No email changes to save.');
                return;
            }
            
            console.log('üìß Updating emails:', updates);
            
            // Update in Firebase
            const promises = updates.map(update => {
                if (db) {
                    return db.collection('installers').doc(update.id).update({ email: update.email });
                }
                return Promise.resolve();
            });
            
            Promise.all(promises).then(() => {
                console.log('‚úÖ All emails updated successfully');
                alert(`‚úÖ Updated ${updates.length} email addresses successfully!`);
                
                // Reload installers
                loadDemoInstallers();
                showInstallerManagement();
            }).catch(error => {
                console.error('‚ùå Failed to update emails:', error);
                alert(`‚ùå Error updating emails: ${error.message}`);
            });
        }

        // Edit installer
        function editInstaller(installerId) {
            editingInstaller = installers.find(i => i.id === installerId);
            showInstallerForm();
        }

        // Show installer form
        function showInstallerForm() {
            const mainElement = document.querySelector('main');
            if (!mainElement) return;
            
            const installer = editingInstaller || {
                name: '',
                email: '',
                phone: '',
                crews: [],
                status: 'active',
                notes: ''
            };
            
            // Handle undefined values for editing
            if (editingInstaller) {
                installer.name = editingInstaller.name || '';
                installer.email = editingInstaller.email || '';
                installer.phone = editingInstaller.phone || '';
                installer.crews = editingInstaller.crews || [];
                installer.status = editingInstaller.status || 'active';
                installer.notes = editingInstaller.notes || '';
            }
            
            mainElement.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">
                            ${editingInstaller ? '‚úèÔ∏è Edit Installer' : '‚ûï Add New Installer'}
                        </h2>
                        <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ‚Üê Back to Installers
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <form id="installerForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Full Name *</label>
                                    <input type="text" id="installerName" required 
                                           value="${installer.name}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email *</label>
                                    <input type="email" id="installerEmail" required 
                                           value="${installer.email}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Phone *</label>
                                    <input type="tel" id="installerPhone" required 
                                           value="${installer.phone}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="installerStatus" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="active" ${installer.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${installer.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Crew Assignments</label>
                                <div class="mt-2 space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="newCrewInput" placeholder="Enter crew name..." 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <button type="button" onclick="addCrew()" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            Add Crew
                                        </button>
                                    </div>
                                    <div id="crewsList" class="flex flex-wrap gap-2">
                                        ${installer.crews.map((crew, index) => `
                                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm flex items-center">
                                                ${crew}
                                                <button type="button" onclick="removeCrew(${index})" class="ml-2 text-blue-600 hover:text-blue-800">√ó</button>
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Notes</label>
                                <textarea id="installerNotes" rows="3" 
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${installer.notes}</textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="showInstallerManagement()" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    ${editingInstaller ? 'Update Installer' : 'Create Installer'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup form submission
            const form = document.getElementById('installerForm');
            if (form) {
                form.addEventListener('submit', saveInstaller);
            }
        }

        // Add crew to list
        function addCrew() {
            const input = document.getElementById('newCrewInput');
            const crewName = input?.value.trim();
            
            if (crewName) {
                const crewsList = document.getElementById('crewsList');
                const currentCrews = Array.from(crewsList.querySelectorAll('span')).map(span => span.textContent.trim().replace('√ó', ''));
                
                if (!currentCrews.includes(crewName)) {
                    const crewSpan = document.createElement('span');
                    crewSpan.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm flex items-center';
                    crewSpan.innerHTML = `
                        ${crewName}
                        <button type="button" onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">√ó</button>
                    `;
                    crewsList.appendChild(crewSpan);
                    input.value = '';
                }
            }
        }

        // Remove crew from list
        function removeCrew(index) {
            const crewsList = document.getElementById('crewsList');
            const crewSpans = crewsList.querySelectorAll('span');
            if (crewSpans[index]) {
                crewSpans[index].remove();
            }
        }

        // Save installer
        async function saveInstaller(event) {
            event.preventDefault(); // Prevent form submission
            
            const formData = {
                name: document.getElementById('installerName').value,
                email: document.getElementById('installerEmail').value,
                phone: document.getElementById('installerPhone').value,
                crews: Array.from(document.getElementById('crewsList').querySelectorAll('span')).map(span => span.textContent.trim().replace('√ó', '')),
                status: document.getElementById('installerStatus').value,
                notes: document.getElementById('installerNotes').value
            };
            
            console.log('üíæ Saving installer data:', formData);
            
            if (editingInstaller) {
                // Update existing installer
                if (db) {
                    try {
                        await db.collection('installers').doc(editingInstaller.id).update(formData);
                        console.log('‚úÖ Installer updated in Firebase');
                        alert('‚úÖ Installer updated successfully!');
                    } catch (error) {
                        console.error('‚ùå Failed to update installer:', error);
                        alert('‚ùå Failed to update installer: ' + error.message);
                        return;
                    }
                } else {
                    const index = installers.findIndex(i => i.id === editingInstaller.id);
                    if (index !== -1) {
                        installers[index] = { ...installers[index], ...formData };
                    }
                }
            } else {
                // Create new installer
                if (db) {
                    try {
                        const docRef = await db.collection('installers').add({
                            ...formData,
                            createdAt: new Date()
                        });
                        console.log('‚úÖ New installer created in Firebase with ID:', docRef.id);
                        alert('‚úÖ New installer created successfully!');
                    } catch (error) {
                        console.error('‚ùå Failed to create installer:', error);
                        alert('‚ùå Failed to create installer: ' + error.message);
                        return;
                    }
                } else {
                    const newInstaller = {
                        id: 'installer-' + Date.now(),
                        ...formData,
                        createdAt: new Date()
                    };
                    installers.push(newInstaller);
                    
                    // Show provisioning details for new installer
                    showProvisioningDetails(newInstaller);
                    return;
                }
            }
            
            // Return to installer management
            showInstallerManagement();
        }

        // Show provisioning details
        function showProvisioningDetails(installer) {
            const tempPassword = generateTempPassword();
            const portalUrl = `${window.location.origin}/installer/${installer.id}`;
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h2 class="text-2xl font-bold text-green-800 mb-4">‚úÖ Installer Created Successfully!</h2>
                            <p class="text-green-700 mb-6">Share these access details with the installer:</p>
                            
                            <div class="bg-white rounded-lg p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Installer Name</label>
                                    <div class="text-lg font-semibold">${installer.name}</div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email</label>
                                    <div class="text-lg">${installer.email}</div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Temporary Password</label>
                                    <div class="flex items-center space-x-2">
                                        <div class="text-lg font-mono bg-gray-100 px-3 py-2 rounded">${tempPassword}</div>
                                        <button onclick="copyToClipboard('${tempPassword}')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Unique Portal URL</label>
                                    <div class="flex items-center space-x-2">
                                        <div class="text-sm font-mono bg-gray-100 px-3 py-2 rounded break-all">${portalUrl}</div>
                                        <button onclick="copyToClipboard('${portalUrl}')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="showInstallerManagement()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Back to Installers
                                </button>
                                <button onclick="showAddInstallerForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Add Another Installer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Generate temporary password
        function generateTempPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // View installer details
        function viewInstallerDetails(installerId) {
            const installer = installers.find(i => i.id === installerId);
            if (!installer) return;
            
            const portalUrl = `${window.location.origin}/installer/${installer.id}`;
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üëÅÔ∏è Installer Details</h2>
                            <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Installers
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Name</label>
                                            <div class="text-lg">${installer.name}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Email</label>
                                            <div class="text-lg">${installer.email}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                                            <div class="text-lg">${installer.phone}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <span class="px-2 py-1 text-xs rounded ${installer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${installer.status.toUpperCase()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Access Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Installer ID</label>
                                            <div class="text-lg font-mono">${installer.id}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Portal URL</label>
                                            <div class="flex items-center space-x-2">
                                                <div class="text-sm font-mono bg-gray-100 px-3 py-2 rounded break-all">${portalUrl}</div>
                                                <button onclick="copyToClipboard('${portalUrl}')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                                    üìã Copy
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Crew Assignments</label>
                                            <div class="flex flex-wrap gap-2">
                                                ${installer.crews.map(crew => `
                                                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${crew}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${installer.notes ? `
                                <div class="mt-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Notes</h3>
                                    <div class="bg-gray-50 p-3 rounded">${installer.notes}</div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="editInstaller('${installer.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    ‚úèÔ∏è Edit Installer
                                </button>
                                <button onclick="showInstallerManagement()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    Back to Installers
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Delete installer
        function deleteInstaller(installerId) {
            if (confirm('Are you sure you want to delete this installer? This action cannot be undone.')) {
                installers = installers.filter(i => i.id !== installerId);
                renderInstallerCards();
            }
        }

        // Job Assignment Functions
        let adminJobs = [];
        let editingJob = null;

        // Show job assignment interface
        function showJobAssignment() {
            console.log('Loading job assignment...');
            
            // Load demo jobs
            loadDemoJobs();
            
            // Replace main content with job assignment
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üìÖ Job Assignment</h2>
                            <div class="flex space-x-2">
                                <button onclick="manualSyncTeamUp()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    üîÑ Sync from TeamUp
                                </button>
                                <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    ‚Üê Back to Dashboard
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                            <div class="flex flex-col md:flex-row gap-4">
                                <input type="text" id="jobSearch" placeholder="Search jobs by customer or address..." 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       onkeyup="filterJobs()">
                                <select id="jobStatusFilter" onchange="filterJobs()" 
                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Status</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="jobInstallerFilter" onchange="filterJobs()" 
                                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Installers</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Jobs Table -->
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Installer</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Jobs will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Populate installer filter
                populateInstallerFilter();
                
                // Render jobs table
                renderJobsTable();
            }
        }

        // TeamUp Integration Functions
        function syncWithTeamUp() {
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                console.log('‚ö†Ô∏è TeamUp not configured - skipping sync');
                return Promise.resolve();
            }
            
            console.log('üîÑ Syncing with TeamUp...');
            
            // Calculate date range - current week + next 3 weeks
            const now = new Date();
            const currentWeekStart = getWeekStart(now);
            const threeWeeksEnd = new Date(currentWeekStart.getTime() + (28 * 24 * 60 * 60 * 1000)); // 4 weeks total
            
            // Format dates for TeamUp API
            const startDateStr = currentWeekStart.toISOString().split('T')[0];
            const endDateStr = threeWeeksEnd.toISOString().split('T')[0];
            
            console.log(`üìÖ Syncing events from ${startDateStr} to ${endDateStr} (current week + 3 weeks)`);
            
            // TeamUp API call with optimized date range
            const apiUrl = `https://api.teamup.com/${teamupConfig.calendarId}/events?startDate=${startDateStr}&endDate=${endDateStr}`;
            
            return fetch(apiUrl, {
                headers: {
                    'Teamup-Token': teamupConfig.apiKey
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ TeamUp data received:', data.events?.length || 0, 'events');
                processTeamUpEvents(data.events || []);
                teamupConfig.lastSync = new Date();
                
                // Update TeamUp events count
                const eventsCount = data.events?.length || 0;
                const teamUpEventsElement = document.getElementById('totalTeamUpEvents');
                if (teamUpEventsElement) {
                    teamUpEventsElement.textContent = eventsCount;
                }
            })
            .catch(error => {
                console.error('‚ùå TeamUp sync failed:', error);
                throw error;
            });
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function processTeamUpEvents(events) {
            // Convert TeamUp events to job format
            const teamUpJobs = events.map(event => ({
                id: event.id,
                title: event.title,
                customer: extractCustomerFromTitle(event.title),
                phone: event.location?.phone || '',
                email: event.location?.notes || '',
                address: event.location?.address || '',
                scheduledDate: new Date(event.start_dt),
                assignedInstaller: event.who?.[0]?.name || null,
                status: mapTeamUpStatus(event.status),
                notes: event.notes || '',
                estimatedDuration: formatDuration(event.end_dt - event.start_dt),
                priority: mapTeamUpPriority(event.title),
                source: 'teamup'
            }));
            
            // Save to Firebase
            if (db) {
                teamUpJobs.forEach(job => {
                    db.collection('jobs').doc(job.id).set(job, { merge: true });
                });
                console.log('‚úÖ Saved', teamUpJobs.length, 'TeamUp jobs to Firebase');
            }
        }

        function extractCustomerFromTitle(title) {
            // Extract customer name from title (customize based on your format)
            const match = title.match(/^([^-\n]+)/);
            return match ? match[1].trim() : title;
        }

        function mapTeamUpStatus(teamUpStatus) {
            const statusMap = {
                'confirmed': 'scheduled',
                'tentative': 'scheduled',
                'canceled': 'cancelled',
                'completed': 'completed'
            };
            return statusMap[teamUpStatus] || 'scheduled';
        }

        function mapTeamUpPriority(title) {
            if (title.toLowerCase().includes('urgent') || title.toLowerCase().includes('priority')) {
                return 'high';
            }
            return 'normal';
        }

        function formatDuration(milliseconds) {
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function startTeamUpSync() {
            if (teamupConfig.apiKey && teamupConfig.calendarId) {
                // Initial sync
                syncWithTeamUp();
                
                // Set up recurring sync
                setInterval(() => {
                    syncWithTeamUp();
                }, teamupConfig.syncInterval * 60 * 1000);
                
                console.log(`üîÑ TeamUp sync started - every ${teamupConfig.syncInterval} minutes`);
            }
        }

        // Load jobs from Firebase (not TeamUp)
        function loadDemoJobs() {
            if (db) {
                // Load from Firebase (not real-time - just once)
                console.log('üì• Loading jobs from Firebase...');
                db.collection('jobs').get().then((snapshot) => {
                    adminJobs = [];
                    snapshot.forEach((doc) => {
                        adminJobs.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('‚úÖ Jobs loaded from Firebase:', adminJobs.length);
                    renderJobsTable();
                }).catch((error) => {
                    console.error('‚ùå Error loading jobs:', error);
                    // Fallback to demo data
                    loadDemoJobsFallback();
                });
            } else {
                // Fallback to demo data
                loadDemoJobsFallback();
            }
        }

        // Fallback demo jobs
        function loadDemoJobsFallback() {
            adminJobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    phone: '(555) 123-4567',
                    email: 'john.smith@email.com',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    assignedInstaller: 'installer-001',
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows, remove old frames',
                    estimatedDuration: '4 hours',
                    priority: 'normal'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    phone: '(555) 234-5678',
                    email: 'mary.johnson@email.com',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    assignedInstaller: 'installer-002',
                    status: 'scheduled',
                    crew: 'Crew C',
                    notes: 'Remove old door frame, install new entry door with hardware',
                    estimatedDuration: '3 hours',
                    priority: 'high'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    phone: '(555) 345-6789',
                    email: 'robert.davis@email.com',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    assignedInstaller: 'installer-001',
                    status: 'completed',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal, replace weatherstripping',
                    estimatedDuration: '2 hours',
                    priority: 'low'
                },
                {
                    id: 'JOB004',
                    title: 'Full Window Replacement - Kitchen',
                    customer: 'Sarah Wilson',
                    phone: '(555) 456-7890',
                    email: 'sarah.wilson@email.com',
                    address: '321 Elm Street, Springfield',
                    scheduledDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    assignedInstaller: null,
                    status: 'unassigned',
                    crew: null,
                    notes: 'Replace all kitchen windows with new energy-efficient models',
                    estimatedDuration: '6 hours',
                    priority: 'high'
                }
            ];
        }

        // Populate installer filter dropdown
        function populateInstallerFilter() {
            const filter = document.getElementById('jobInstallerFilter');
            if (!filter) return;
            
            // Add active installers to filter
            const activeInstallers = installers.filter(i => i.status === 'active');
            
            filter.innerHTML = `
                <option value="">All Installers</option>
                ${activeInstallers.map(installer => `
                    <option value="${installer.id}">${installer.name}</option>
                `).join('')}
            `;
        }

        // Render jobs table
        function renderJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            if (!tbody) return;
            
            const searchTerm = document.getElementById('jobSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('jobStatusFilter')?.value || '';
            const installerFilter = document.getElementById('jobInstallerFilter')?.value || '';
            
            let filteredJobs = adminJobs.filter(job => {
                const matchesSearch = job.customer.toLowerCase().includes(searchTerm) || 
                                   job.address.toLowerCase().includes(searchTerm) ||
                                   job.title.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || job.status === statusFilter;
                const matchesInstaller = !installerFilter || job.assignedInstaller === installerFilter;
                return matchesSearch && matchesStatus && matchesInstaller;
            });
            
            // Sort by scheduled date
            filteredJobs.sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));
            
            tbody.innerHTML = filteredJobs.map(job => {
                const installer = installers.find(i => i.id === job.assignedInstaller);
                const installerName = installer ? installer.name : 'Unassigned';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${job.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${job.customer}</div>
                            <div class="text-xs text-gray-500">${job.phone}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${job.address}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${formatDate(job.scheduledDate)}</div>
                            <div class="text-xs text-gray-500">${formatTime(job.scheduledDate)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${installerName}</div>
                            ${job.crew ? `<div class="text-xs text-gray-500">${job.crew}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded ${getStatusClass(job.status)}">
                                ${job.status.replace('_', ' ').toUpperCase()}
                            </span>
                            ${job.priority === 'high' ? '<div class="text-xs text-red-600 mt-1">‚ö†Ô∏è High Priority</div>' : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewJobDetails('${job.id}')" class="text-blue-600 hover:text-blue-900">
                                    üëÅÔ∏è View
                                </button>
                                ${job.status === 'unassigned' ? `
                                    <button onclick="assignJob('${job.id}')" class="text-purple-600 hover:text-purple-900">
                                        üë• Assign
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status styling class
        function getStatusClass(status) {
            switch(status) {
                case 'scheduled': return 'bg-blue-100 text-blue-800';
                case 'in_progress': return 'bg-yellow-100 text-yellow-800';
                case 'completed': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                case 'unassigned': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Format date
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Format time
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Filter jobs
        function filterJobs() {
            renderJobsTable();
        }

        // Show add job form
        function showAddJobForm() {
            editingJob = null;
            showJobForm();
        }

        // Edit job
        function editJob(jobId) {
            editingJob = adminJobs.find(j => j.id === jobId);
            showJobForm();
        }

        // Show job form
        function showJobForm() {
            const mainElement = document.querySelector('main');
            if (!mainElement) return;
            
            const job = editingJob || {
                title: '',
                customer: '',
                phone: '',
                email: '',
                address: '',
                scheduledDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
                assignedInstaller: '',
                crew: '',
                status: 'scheduled',
                notes: '',
                estimatedDuration: '',
                priority: 'normal'
            };
            
            // Format date for input
            const dateForInput = new Date(job.scheduledDate).toISOString().slice(0, 16);
            
            mainElement.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">
                            ${editingJob ? '‚úèÔ∏è Edit Job' : '‚ûï Create New Job'}
                        </h2>
                        <button onclick="showJobAssignment()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ‚Üê Back to Jobs
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <form id="jobForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Job Title *</label>
                                    <input type="text" id="jobTitle" required 
                                           value="${job.title}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Customer Name *</label>
                                    <input type="text" id="jobCustomer" required 
                                           value="${job.customer}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Customer Phone *</label>
                                    <input type="tel" id="jobPhone" required 
                                           value="${job.phone}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Customer Email</label>
                                    <input type="email" id="jobEmail" 
                                           value="${job.email}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Service Address *</label>
                                    <input type="text" id="jobAddress" required 
                                           value="${job.address}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Scheduled Date & Time *</label>
                                    <input type="datetime-local" id="jobScheduledDate" required 
                                           value="${dateForInput}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Assign Installer</label>
                                    <select id="jobAssignedInstaller" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Installer</option>
                                        ${installers.filter(i => i.status === 'active').map(installer => `
                                            <option value="${installer.id}" ${job.assignedInstaller === installer.id ? 'selected' : ''}>
                                                ${installer.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Priority</label>
                                    <select id="jobPriority" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="low" ${job.priority === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="normal" ${job.priority === 'normal' ? 'selected' : ''}>Normal</option>
                                        <option value="high" ${job.priority === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Estimated Duration</label>
                                    <input type="text" id="jobEstimatedDuration" 
                                           value="${job.estimatedDuration}"
                                           placeholder="e.g., 4 hours"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="jobStatus" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="unassigned" ${job.status === 'unassigned' ? 'selected' : ''}>Unassigned</option>
                                        <option value="scheduled" ${job.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                        <option value="in_progress" ${job.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${job.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${job.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Job Notes</label>
                                <textarea id="jobNotes" rows="4" 
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${job.notes}</textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="showJobAssignment()" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    ${editingJob ? 'Update Job' : 'Create Job'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Setup form submission
            const form = document.getElementById('jobForm');
            if (form) {
                form.addEventListener('submit', saveJob);
            }
        }

        // Save job
        async function saveJob(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('jobTitle').value,
                customer: document.getElementById('jobCustomer').value,
                phone: document.getElementById('jobPhone').value,
                email: document.getElementById('jobEmail').value,
                address: document.getElementById('jobAddress').value,
                scheduledDate: new Date(document.getElementById('jobScheduledDate').value),
                assignedInstaller: document.getElementById('jobAssignedInstaller').value,
                priority: document.getElementById('jobPriority').value,
                estimatedDuration: document.getElementById('jobEstimatedDuration').value,
                status: document.getElementById('jobStatus').value,
                notes: document.getElementById('jobNotes').value
            };
            
            // Set crew based on installer
            if (formData.assignedInstaller) {
                const installer = installers.find(i => i.id === formData.assignedInstaller);
                formData.crew = installer ? installer.crews[0] : null;
            }
            
            if (editingJob) {
                // Update existing job
                if (db) {
                    await db.collection('jobs').doc(editingJob.id).update(formData);
                    console.log('‚úÖ Job updated in Firebase');
                } else {
                    const index = adminJobs.findIndex(j => j.id === editingJob.id);
                    if (index !== -1) {
                        adminJobs[index] = { ...adminJobs[index], ...formData };
                    }
                }
            } else {
                // Create new job
                if (db) {
                    const docRef = await db.collection('jobs').add({
                        ...formData,
                        createdAt: new Date()
                    });
                    console.log('‚úÖ New job created in Firebase with ID:', docRef.id);
                } else {
                    const newJob = {
                        id: 'JOB' + Date.now(),
                        ...formData
                    };
                    adminJobs.push(newJob);
                }
            }
            
            showJobAssignment();
        }

        // Assign job
        function assignJob(jobId) {
            const job = adminJobs.find(j => j.id === jobId);
            if (!job) return;
            
            editingJob = job;
            showJobForm();
        }

        // View job details
        function viewJobDetails(jobId) {
            const job = adminJobs.find(j => j.id === jobId);
            if (!job) return;
            
            const installer = installers.find(i => i.id === job.assignedInstaller);
            const installerName = installer ? installer.name : 'Unassigned';
            
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üëÅÔ∏è Job Details</h2>
                            <button onclick="showJobAssignment()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Jobs
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Job Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Job ID</label>
                                            <div class="text-lg font-mono">${job.id}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Title</label>
                                            <div class="text-lg">${job.title}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <span class="px-2 py-1 text-xs rounded ${getStatusClass(job.status)}">
                                                ${job.status.replace('_', ' ').toUpperCase()}
                                            </span>
                                            ${job.priority === 'high' ? '<div class="text-sm text-red-600 mt-1">‚ö†Ô∏è High Priority</div>' : ''}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Scheduled Date</label>
                                            <div class="text-lg">${formatDate(job.scheduledDate)} at ${formatTime(job.scheduledDate)}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Estimated Duration</label>
                                            <div class="text-lg">${job.estimatedDuration || 'Not specified'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Customer Name</label>
                                            <div class="text-lg">${job.customer}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                                            <div class="text-lg">${job.phone}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Email</label>
                                            <div class="text-lg">${job.email || 'Not provided'}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Service Address</label>
                                            <div class="text-lg">${job.address}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Assignment</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Assigned Installer</label>
                                            <div class="text-lg">${installerName}</div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Crew</label>
                                            <div class="text-lg">${job.crew || 'Not assigned'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${job.notes ? `
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Notes</h3>
                                        <div class="bg-gray-50 p-3 rounded">${job.notes}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="showJobAssignment()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    Back to Jobs
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Delete job
        async function deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                if (db) {
                    await db.collection('jobs').doc(jobId).delete();
                    console.log('‚úÖ Job deleted from Firebase');
                } else {
                    adminJobs = adminJobs.filter(j => j.id !== jobId);
                    renderJobsTable();
                }
            }
        }

        // System Settings Functions
        function showSystemSettings() {
            console.log('Loading system settings...');
            
            // Replace main content with system settings
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üîß System Settings</h2>
                            <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Dashboard
                            </button>
                        </div>
                        
                        <!-- TeamUp Configuration -->
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üîÑ TeamUp Integration</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">TeamUp API Key</label>
                                    <input type="password" id="teamupApiKey" 
                                           value="${teamupConfig.apiKey || ''}"
                                           placeholder="Enter your TeamUp API key"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Get this from your TeamUp account settings</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Calendar ID</label>
                                    <input type="text" id="teamupCalendarId" 
                                           value="${teamupConfig.calendarId || ''}"
                                           placeholder="Enter TeamUp calendar ID"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                    <p class="mt-1 text-xs text-gray-500">Found in TeamUp calendar URL</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Sync Interval (minutes)</label>
                                    <select id="teamupSyncInterval" 
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                                        <option value="1" ${teamupConfig.syncInterval === 1 ? 'selected' : ''}>1 minute</option>
                                        <option value="5" ${teamupConfig.syncInterval === 5 ? 'selected' : ''}>5 minutes</option>
                                        <option value="10" ${teamupConfig.syncInterval === 10 ? 'selected' : ''}>10 minutes</option>
                                        <option value="15" ${teamupConfig.syncInterval === 15 ? 'selected' : ''}>15 minutes</option>
                                        <option value="30" ${teamupConfig.syncInterval === 30 ? 'selected' : ''}>30 minutes</option>
                                        <option value="60" ${teamupConfig.syncInterval === 60 ? 'selected' : ''}>1 hour</option>
                                        <option value="120" ${teamupConfig.syncInterval === 120 ? 'selected' : ''}>2 hours</option>
                                        <option value="240" ${teamupConfig.syncInterval === 240 ? 'selected' : ''}>4 hours</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-end">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Last Sync</label>
                                        <div class="mt-1 text-sm text-gray-600">
                                            ${teamupConfig.lastSync ? teamupConfig.lastSync.toLocaleString() : 'Never synced'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex space-x-3">
                                <button onclick="testTeamUpConnection()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    üîç Test Connection
                                </button>
                                <button onclick="saveSystemSettings()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                    üíæ Save Settings
                                </button>
                                <button onclick="manualSyncTeamUp()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    üîÑ Sync Now
                                </button>
                            </div>
                        </div>
                        
                        <!-- Sync Status -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Sync Status</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="totalTeamUpEvents">-</div>
                                    <div class="text-sm text-gray-600">TeamUp Events</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600" id="firebaseJobsCount">-</div>
                                    <div class="text-sm text-gray-600">Firebase Jobs</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="syncStatus">Not Configured</div>
                                    <div class="text-sm text-gray-600">Sync Status</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load current sync status
                updateSyncStatus();
            }
        }

        function testTeamUpConnection() {
            const apiKey = document.getElementById('teamupApiKey').value;
            const calendarId = document.getElementById('teamupCalendarId').value;
            
            if (!apiKey || !calendarId) {
                alert('Please enter both API Key and Calendar ID');
                return;
            }
            
            console.log('üîç Testing TeamUp connection...');
            
            fetch(`https://api.teamup.com/${calendarId}/events`, {
                headers: {
                    'Teamup-Token': apiKey
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                const eventCount = data.events?.length || 0;
                alert(`‚úÖ Connection successful! Found ${eventCount} events in TeamUp calendar.`);
                document.getElementById('totalTeamUpEvents').textContent = eventCount;
            })
            .catch(error => {
                console.error('‚ùå TeamUp connection test failed:', error);
                alert(`‚ùå Connection failed: ${error.message}`);
            });
        }

        function saveSystemSettings() {
            const apiKey = document.getElementById('teamupApiKey').value;
            const calendarId = document.getElementById('teamupCalendarId').value;
            const syncInterval = parseInt(document.getElementById('teamupSyncInterval').value);
            
            // Update config
            teamupConfig = {
                apiKey: apiKey,
                calendarId: calendarId,
                syncInterval: syncInterval,
                lastSync: teamupConfig.lastSync
            };
            
            // Save to localStorage for persistence
            localStorage.setItem('teamupConfig', JSON.stringify(teamupConfig));
            
            console.log('‚úÖ System settings saved:', teamupConfig);
            
            // Restart sync with new settings
            if (apiKey && calendarId) {
                startTeamUpSync();
                document.getElementById('syncStatus').textContent = 'Active';
            }
            
            alert('‚úÖ Settings saved successfully!');
        }

        function manualSyncTeamUp() {
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                alert('Please configure TeamUp settings first');
                return;
            }
            
            console.log('üîÑ Manual TeamUp sync triggered...');
            
            // Show loading state
            const syncButton = event.target;
            const originalText = syncButton.innerHTML;
            syncButton.innerHTML = 'üîÑ Syncing...';
            syncButton.disabled = true;
            
            syncWithTeamUp().then(() => {
                // Update status after sync completes
                updateSyncStatus();
                syncButton.innerHTML = '‚úÖ Sync Complete';
                setTimeout(() => {
                    syncButton.innerHTML = originalText;
                    syncButton.disabled = false;
                }, 2000);
            }).catch(error => {
                console.error('‚ùå Sync failed:', error);
                alert(`Sync failed: ${error.message}`);
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
            });
        }

        function updateSyncStatus() {
            // Update Firebase jobs count
            if (db) {
                db.collection('jobs').get().then(snapshot => {
                    document.getElementById('firebaseJobsCount').textContent = snapshot.size;
                });
            }
            
            // Update sync status
            if (teamupConfig.apiKey && teamupConfig.calendarId) {
                document.getElementById('syncStatus').textContent = 
                    teamupConfig.lastSync ? 'Active' : 'Ready';
            } else {
                document.getElementById('syncStatus').textContent = 'Not Configured';
            }
        }

        // Load saved settings on startup
        function loadSavedSettings() {
            const saved = localStorage.getItem('teamupConfig');
            if (saved) {
                try {
                    teamupConfig = JSON.parse(saved);
                    console.log('‚úÖ Loaded saved TeamUp config:', teamupConfig);
                } catch (error) {
                    console.error('‚ùå Failed to load saved settings:', error);
                }
            }
        }

        // New Installer Provisioning Functions
        function showNewInstallerProvisioning() {
            console.log('Loading new installer provisioning...');
            
            // Replace main content with provisioning interface
            const mainElement = document.querySelector('main');
            if (mainElement) {
                mainElement.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">üë• New Installer Provisioning</h2>
                            <button onclick="renderAdminDashboard()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                ‚Üê Back to Dashboard
                            </button>
                        </div>
                        
                        <!-- Installers Needing Accounts -->
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üîç Installers Found in TeamUp</h3>
                            <p class="text-sm text-gray-600 mb-4">Installers found in TeamUp who need accounts created</p>
                            
                            <!-- Debug Controls -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">üîß Debug Controls</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">API Endpoint Test</label>
                                        <select id="debugEndpoint" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="/events" selected>/events (Working - 149 events found)</option>
                                            <option value="/subcalendars">/subcalendars (Alternative)</option>
                                            <option value="/calendars">/calendars (Not Working - 404)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Debug Mode</label>
                                        <select id="debugMode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="normal">Normal</option>
                                            <option value="verbose">Verbose</option>
                                            <option value="minimal">Minimal</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex space-x-3 mt-3">
                                    <button onclick="testTeamUpEndpoints()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                        üß™ Test Endpoints
                                    </button>
                                    <button onclick="loadTeamUpInstallers()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        üîÑ Load Installers
                                    </button>
                                </div>
                            </div>
                            
                            <div id="teamUpInstallersList" class="space-y-4">
                                <!-- TeamUp installers will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Provisioning Actions -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">üöÄ Bulk Provisioning</h3>
                            <div class="flex space-x-3 mb-4">
                                <button onclick="provisionSelectedInstallers()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    ‚úÖ Create Selected Accounts
                                </button>
                                <button onclick="selectAllInstallers()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    ‚òëÔ∏è Select All
                                </button>
                                <button onclick="deselectAllInstallers()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                    ‚¨ú Deselect All
                                </button>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">üìã Provisioning Summary</h4>
                                <div id="provisioningSummary" class="text-sm text-blue-700">
                                    Select installers to create accounts for
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Auto-load installers after UI is ready
            setTimeout(() => {
                loadTeamUpInstallers();
            }, 100);
        }

        function loadTeamUpInstallers() {
            if (!teamupConfig.apiKey || !teamupConfig.calendarId) {
                document.getElementById('teamUpInstallersList').innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <p class="text-yellow-800">‚ö†Ô∏è TeamUp not configured. Please configure TeamUp settings first.</p>
                    </div>
                `;
                return;
            }
            
            // Get debug settings
            const debugEndpoint = document.getElementById('debugEndpoint')?.value || '/events';
            const debugMode = document.getElementById('debugMode')?.value || 'normal';
            
            console.log('üîç Loading installers from TeamUp calendars...');
            console.log('üîë API Key:', teamupConfig.apiKey ? 'Present' : 'Missing');
            console.log('üìÖ Calendar ID:', teamupConfig.calendarId);
            console.log('üîß Debug Endpoint:', debugEndpoint);
            console.log('üîß Debug Mode:', debugMode);
            
            // Try different API endpoints
            const calendarsApiUrl = `https://api.teamup.com/${teamupConfig.calendarId}${debugEndpoint}`;
            console.log('üåê API URL:', calendarsApiUrl);
            
            fetch(calendarsApiUrl, {
                headers: {
                    'Teamup-Token': teamupConfig.apiKey
                }
            })
            .then(response => {
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('üìä Full response:', data);
                
                let installers = [];
                
                if (debugEndpoint === '/events') {
                    // Extract installers from events
                    const events = data.events || [];
                    const installersMap = new Map();
                    
                    events.forEach((event, index) => {
                        if (debugMode === 'verbose') {
                            console.log(`üìã Event ${index}:`, event);
                        }
                        
                        if (event.who && event.who.length > 0) {
                            const installerName = event.who[0].name;
                            if (installerName && !installersMap.has(installerName)) {
                                installersMap.set(installerName, {
                                    name: installerName,
                                    calendarId: event.calendar_id || 'unknown',
                                    active: true,
                                    color: '#3B82F6',
                                    phone: event.location?.phone || '',
                                    email: event.location?.notes || ''
                                });
                            }
                        }
                    });
                    
                    installers = Array.from(installersMap.values());
                    console.log(`üë• Found ${installers.length} installers from events`);
                    
                } else {
                    // Extract from calendars/subcalendars
                    const calendars = data.calendars || data.subcalendars || [];
                    
                    calendars.forEach((calendar, index) => {
                        if (debugMode === 'verbose') {
                            console.log(`üìã Calendar ${index}:`, calendar);
                        }
                        
                        const installerName = calendar.name;
                        if (installerName) {
                            installers.push({
                                name: installerName,
                                calendarId: calendar.id,
                                active: calendar.active !== false,
                                color: calendar.color || '#3B82F6',
                                phone: '',
                                email: ''
                            });
                        }
                    });
                    
                    console.log(`üë• Found ${installers.length} installers from calendars`);
                }
                
                console.log('üë• Final installers list:', installers);
                
                // Get existing installers from Firebase to check who's already provisioned
                if (db) {
                    db.collection('installers').get().then(snapshot => {
                        const existingInstallers = new Set();
                        snapshot.forEach(doc => {
                            existingInstallers.add(doc.data().name);
                        });
                        
                        console.log(`üìã ${existingInstallers.size} installers already provisioned:`, Array.from(existingInstallers));
                        
                        // Mark which installers need provisioning
                        const installersList = installers.map(installer => ({
                            ...installer,
                            needsProvisioning: !existingInstallers.has(installer.name)
                        }));
                        
                        console.log('üéØ Final installers list:', installersList);
                        displayTeamUpInstallers(installersList);
                    });
                } else {
                    // Fallback - just show all installers
                    console.log('‚ö†Ô∏è No Firebase DB - showing all installers');
                    displayTeamUpInstallers(installers);
                }
            })
            .catch(error => {
                console.error('‚ùå Failed to load TeamUp data:', error);
                console.error('‚ùå Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                
                document.getElementById('teamUpInstallersList').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <p class="text-red-800">‚ùå Failed to load TeamUp data: ${error.message}</p>
                        <p class="text-red-600 text-sm mt-2">Check console for detailed error information</p>
                        <p class="text-red-600 text-sm mt-2">Try different endpoint from debug controls above</p>
                    </div>
                `;
            });
        }

        function testTeamUpEndpoints() {
            const endpoints = ['/calendars', '/subcalendars', '/events'];
            const debugMode = document.getElementById('debugMode')?.value || 'normal';
            
            console.log('üß™ Testing all TeamUp endpoints...');
            
            endpoints.forEach(endpoint => {
                const apiUrl = `https://api.teamup.com/${teamupConfig.calendarId}${endpoint}`;
                console.log(`üß™ Testing ${apiUrl}...`);
                
                fetch(apiUrl, {
                    headers: {
                        'Teamup-Token': teamupConfig.apiKey
                    }
                })
                .then(response => {
                    console.log(`‚úÖ ${endpoint}: Status ${response.status}`);
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .then(data => {
                    console.log(`‚úÖ ${endpoint}: Success - ${JSON.stringify(data).substring(0, 100)}...`);
                })
                .catch(error => {
                    console.log(`‚ùå ${endpoint}: ${error.message}`);
                });
            });
        }

        function displayTeamUpInstallers(installers) {
            const listElement = document.getElementById('teamUpInstallersList');
            if (!listElement) return;
            
            if (installers.length === 0) {
                listElement.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-gray-600">No installers found in TeamUp calendars.</p>
                    </div>
                `;
                return;
            }
            
            listElement.innerHTML = installers.map((installer, index) => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 ${installer.needsProvisioning ? 'border-l-4 border-orange-500' : 'border-l-4 border-green-500'}">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" id="installer-${index}" value="${installer.name}" 
                               class="mt-1 h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                               ${!installer.needsProvisioning ? 'disabled' : ''}>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${installer.name}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${installer.needsProvisioning ? 'Needs account created' : 'Already provisioned'}
                                        ${installer.calendarId ? `‚Ä¢ Calendar ID: ${installer.calendarId}` : ''}
                                    </p>
                                </div>
                                <div class="text-right">
                                    ${installer.needsProvisioning ? 
                                        `<span class="px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded">‚ö†Ô∏è Needs Account</span>` :
                                        `<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">‚úÖ Provisioned</span>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            updateProvisioningSummary();
        }

        function selectAllInstallers() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = true);
            updateProvisioningSummary();
        }

        function deselectAllInstallers() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateProvisioningSummary();
        }

        function updateProvisioningSummary() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]:checked');
            const selectedCount = checkboxes.length;
            const summaryElement = document.getElementById('provisioningSummary');
            
            if (selectedCount === 0) {
                summaryElement.innerHTML = 'Select installers to create accounts for';
            } else {
                summaryElement.innerHTML = `
                    <strong>${selectedCount}</strong> installer(s) selected for account creation
                `;
            }
        }

        function provisionSelectedInstallers() {
            const checkboxes = document.querySelectorAll('#teamUpInstallersList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one installer to provision.');
                return;
            }
            
            const selectedInstallers = Array.from(checkboxes).map(cb => cb.value);
            
            console.log('üöÄ Provisioning installers:', selectedInstallers);
            
            // Show email collection dialog
            const emailDialog = document.createElement('div');
            emailDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            emailDialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üìß Enter Email Addresses</h3>
                    <p class="text-sm text-gray-600 mb-4">Please enter email addresses for each installer:</p>
                    <div class="space-y-3">
                        ${selectedInstallers.map(installerName => `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">${installerName}</label>
                                <input type="email" id="email-${installerName.replace(/\s+/g, '-')}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="${installerName.toLowerCase().replace(/\s+/g, '.')}@company.com"
                                       required>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="provisionInstallersWithEmails()" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            ‚úÖ Create Accounts
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(emailDialog);
            
            // Store selected installers for the provisioning function
            window.selectedInstallersForProvisioning = selectedInstallers;
        }

        function provisionInstallersWithEmails() {
            const selectedInstallers = window.selectedInstallersForProvisioning;
            const installerData = [];
            
            // Collect email data
            for (const installerName of selectedInstallers) {
                const emailInput = document.getElementById(`email-${installerName.replace(/\s+/g, '-')}`);
                const email = emailInput.value.trim();
                
                if (!email) {
                    alert(`Please enter an email address for ${installerName}`);
                    return;
                }
                
                installerData.push({
                    name: installerName,
                    email: email,
                    phone: '(555) 000-0000',
                    crews: ['Default Crew'],
                    status: 'active',
                    notes: `Auto-provisioned from TeamUp calendar on ${new Date().toLocaleDateString()}`,
                    createdAt: new Date()
                });
            }
            
            console.log('üìß Creating installer accounts with emails:', installerData);
            
            // Create installer accounts for selected installers
            const promises = installerData.map(data => {
                if (db) {
                    return db.collection('installers').add(data);
                }
                return Promise.resolve();
            });
            
            Promise.all(promises).then(results => {
                console.log('‚úÖ All installer accounts created successfully');
                alert(`‚úÖ Provisioning complete! Accounts created for ${installerData.length} installer(s).`);
                
                // Close dialog
                document.querySelector('.fixed.inset-0').remove();
                
                // Refresh list to show updated provisioning status
                loadTeamUpInstallers();
                
                // Reload installers in management view
                loadDemoInstallers();
            }).catch(error => {
                console.error('‚ùå Failed to create some installer accounts:', error);
                alert(`‚ùå Error creating accounts: ${error.message}`);
            });
        }

        // Render installer dashboard
        function renderInstallerDashboard() {
            // Show the regular installer dashboard
            renderInstallerJobs();
            updateWeekRange();
        }

        // Demo login (replace with real auth)
        async function demoLogin() {
            // Use demo mode when Firebase config is not set
            console.log('Using demo mode - Firebase config not set');
            
            const demoUser = {
                uid: 'demo-user-123',
                email: 'john@company.com',
                displayName: 'John Smith'
            };
            
            // Create demo data without Firebase
            installerData = {
                uid: demoUser.uid,
                name: demoUser.displayName || 'John Smith',
                email: demoUser.email,
                crews: ['Crew A', 'Crew B'],
                active: true
            };
            
            // Create demo jobs (realistic data)
            jobs = [
                {
                    id: 'JOB001',
                    title: 'Window Installation - Living Room',
                    customer: 'John Smith',
                    address: '123 Main Street, Springfield',
                    scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
                    status: 'scheduled',
                    crew: 'Crew A',
                    notes: 'Install new double-hung windows'
                },
                {
                    id: 'JOB002',
                    title: 'Door Replacement - Front Entry',
                    customer: 'Mary Johnson',
                    address: '456 Oak Avenue, Springfield',
                    scheduledDate: new Date(Date.now() + 6 * 60 * 60 * 1000),
                    status: 'in-progress',
                    crew: 'Crew B',
                    notes: 'Remove old door frame, install new entry door'
                },
                {
                    id: 'JOB003',
                    title: 'Window Repair - Bedroom',
                    customer: 'Robert Davis',
                    address: '789 Pine Street, Springfield',
                    scheduledDate: new Date(Date.now() - 4 * 60 * 60 * 1000),
                    status: 'completed',
                    crew: 'Crew A',
                    notes: 'Fix broken window seal'
                }
            ];
            
            // Update UI
            document.getElementById('installerName').textContent = installerData.name;
            document.getElementById('installerInfo').textContent = installerData.name;
            document.getElementById('crewInfo').textContent = installerData.crews.join(', ');
            
            renderInstallerJobs();
            updateWeekRange();
            showPortal();
        }

        // Load installer data from Firestore
        async function loadInstallerData(user) {
            try {
                // Get installer document
                const installerDoc = await db.collection('installers').doc(user.uid).get();
                
                if (installerDoc.exists) {
                    installerData = installerDoc.data();
                } else {
                    // Create demo installer
                    installerData = {
                        uid: user.uid,
                        name: user.displayName || 'John Smith',
                        email: user.email,
                        crews: ['Crew A', 'Crew B'],
                        active: true
                    };
                    
                    // Save to Firestore
                    await db.collection('installers').doc(user.uid).set(installerData);
                }

                // Update UI
                document.getElementById('installerName').textContent = installerData.name;
                document.getElementById('installerInfo').textContent = installerData.name;
                document.getElementById('crewInfo').textContent = installerData.crews.join(', ');
                
                console.log('Installer data loaded:', installerData);
            } catch (error) {
                console.error('Failed to load installer data:', error);
                showError('Failed to load installer data');
            }
        }

        // Load jobs from Firestore with real-time updates
        async function loadJobs() {
            try {
                // Unsubscribe previous listener
                if (jobsUnsubscribe) {
                    jobsUnsubscribe();
                }

                // Query jobs for this installer
                const jobsQuery = db.collection('jobs')
                    .where('installerId', '==', installerData.uid)
                    .where('scheduledDate', '>=', new Date(Date.now() - (14 * 24 * 60 * 60 * 1000)))
                    .where('scheduledDate', '<=', new Date(Date.now() + (14 * 24 * 60 * 60 * 1000)))
                    .orderBy('scheduledDate');

                // Real-time listener
                jobsUnsubscribe = jobsQuery.onSnapshot((snapshot) => {
                    jobs = [];
                    snapshot.forEach((doc) => {
                        jobs.push({ id: doc.id, ...doc.data() });
                    });
                    renderJobs();
                    updateWeekRange();
                });

                console.log('Jobs listener established');
            } catch (error) {
                console.error('Failed to load jobs:', error);
                showError('Failed to load jobs');
            }
        }

        // Render jobs
        function renderInstallerJobs() {
            const jobsList = document.getElementById('jobsList');
            const noJobs = document.getElementById('noJobs');

            if (jobs.length === 0) {
                jobsList.classList.add('hidden');
                noJobs.classList.remove('hidden');
                return;
            }

            jobsList.classList.remove('hidden');
            noJobs.classList.add('hidden');

            jobsList.innerHTML = jobs.map(job => `
                <div class="job-card bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md" onclick="showJobDetails('${job.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 text-lg">${job.title}</h3>
                            <div class="text-sm text-gray-600 mt-1">
                                <div><i class="fas fa-user mr-1"></i>${job.customer}</div>
                                <div><i class="fas fa-map-marker-alt mr-1"></i>${job.address}</div>
                                <div><i class="fas fa-clock mr-1"></i>${new Date(job.scheduledDate).toLocaleString()}</div>
                            </div>
                        </div>
                        <span class="px-3 py-1 text-xs font-medium rounded-full ${
                            job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                            job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${job.status.replace('-', ' ').toUpperCase()}
                        </span>
                    </div>
                    ${job.notes ? `<div class="text-sm text-gray-500 mt-2"><i class="fas fa-sticky-note mr-1"></i>${job.notes}</div>` : ''}
                    <div class="job-actions">
                        ${job.status === 'scheduled' ? `
                            <button onclick="event.stopPropagation(); updateJobStatus('${job.id}', 'in-progress')" class="bg-green-600 text-white rounded-lg hover:bg-green-700">
                                üöÄ Start Work
                            </button>
                        ` : ''}
                        ${job.status === 'in-progress' ? `
                            <button onclick="event.stopPropagation(); updateJobStatus('${job.id}', 'completed')" class="bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                ‚úÖ Complete
                            </button>
                        ` : ''}
                        <button onclick="event.stopPropagation(); showJobDetails('${job.id}')" class="bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            üìã Details
                        </button>
                        <button onclick="event.stopPropagation(); capturePhotoForJob('${job.id}', 'before')" class="bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üì∏ Before
                        </button>
                        <button onclick="event.stopPropagation(); capturePhotoForJob('${job.id}', 'after')" class="bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            üì∏ After
                        </button>
                        <button onclick="event.stopPropagation(); capturePhotoForJob('${job.id}', 'defect')" class="bg-red-600 text-white rounded-lg hover:bg-red-700">
                            ‚ö†Ô∏è Defect
                        </button>
                        <button onclick="event.stopPropagation(); reportIssueForJob('${job.id}')" class="bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            üö® Issue
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update job status in Firestore
        async function updateJobStatus(jobId, newStatus) {
            try {
                const jobRef = db.collection('jobs').doc(jobId);
                
                await jobRef.update({
                    status: newStatus,
                    statusUpdatedAt: new Date(),
                    statusUpdatedBy: installerData.uid
                });

                console.log(`Job ${jobId} status updated to: ${newStatus}`);
            } catch (error) {
                console.error('Failed to update job status:', error);
                showError('Failed to update job status');
            }
        }

        // Camera capture for specific job (mobile-first)
        function capturePhotoForJob(jobId, type) {
            console.log('Capturing photo for job:', jobId, 'type:', type);
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            // Force camera on mobile devices
            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone')) {
                input.capture = 'environment'; // Use rear camera
                input.setAttribute('capture', 'environment');
            }
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log(`Captured ${type} photo for job ${jobId}:`, file.name);
                    await uploadPhotoToFirebase(file, type, jobId);
                }
            };
            
            input.click();
        }

        // Upload photo to Firebase Storage
        async function uploadPhotoToFirebase(file, type, jobId) {
            try {
                const fileName = `${jobId}/${type}_${Date.now()}_${file.name}`;
                
                console.log(`Uploading ${type} photo:`, {
                    fileName: fileName,
                    fileSize: file.size,
                    fileType: file.type
                });
                
                // Demo mode - simulate upload
                if (firebaseConfig.apiKey === "YOUR_ACTUAL_API_KEY") {
                    // Demo mode
                    alert(`${type} photo captured successfully for job ${jobId}!\nFile: ${file.name}\nSize: ${(file.size / 1024).toFixed(1)} KB\n\n(Demo mode - not actually uploaded)`);
                    return;
                }
                
                // Real Firebase upload
                const storageRef = storage.ref();
                const photoRef = storageRef.child(`job-photos/${fileName}`);
                
                // Upload file
                const snapshot = await photoRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                // Save photo metadata to Firestore
                const photoData = {
                    type: type,
                    fileName: fileName,
                    downloadURL: downloadURL,
                    fileSize: file.size,
                    capturedAt: new Date().toISOString(),
                    jobId: jobId,
                    installerId: installerData.uid,
                    installerName: installerData.name,
                    metadata: {
                        device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
                        location: 'job_site',
                        category: type === 'defect' ? 'issue' : 'documentation'
                    }
                };
                
                await db.collection('photos').add(photoData);
                
                console.log('Photo uploaded successfully:', photoData);
                alert(`${type} photo uploaded successfully for job ${jobId}!`);
                
            } catch (error) {
                console.error('Failed to upload photo:', error);
                showError('Failed to upload photo');
            }
        }

        // Get current job ID (context)
        function getCurrentJobId() {
            // In real app, this would come from current job context
            return jobs.length > 0 ? jobs[0].id : 'CURRENT_JOB';
        }

        // Report issue to Firestore
        async function submitIssue(event) {
            event.preventDefault();
            
            try {
                const issueData = {
                    jobId: document.getElementById('issueJobId').value,
                    category: document.getElementById('issueCategory').value,
                    description: document.getElementById('issueDescription').value,
                    reportedAt: new Date(),
                    installerId: installerData.uid,
                    installerName: installerData.name,
                    status: 'open',
                    photos: []
                };
                
                // Handle photo uploads
                const photoFiles = document.getElementById('issuePhotos').files;
                for (let i = 0; i < photoFiles.length; i++) {
                    const file = photoFiles[i];
                    const fileName = `issues/${issueData.jobId}_${Date.now()}_${file.name}`;
                    
                    const storageRef = storage.ref();
                    const photoRef = storageRef.child(fileName);
                    
                    await photoRef.put(file);
                    const downloadURL = await photoRef.getDownloadURL();
                    
                    issueData.photos.push({
                        fileName: fileName,
                        downloadURL: downloadURL,
                        fileSize: file.size
                    });
                }
                
                // Save issue to Firestore
                await db.collection('issues').add(issueData);
                
                console.log('Issue reported:', issueData);
                alert('Issue reported successfully');
                closeIssueModal();
                
            } catch (error) {
                console.error('Failed to submit issue:', error);
                showError('Failed to submit issue');
            }
        }

        // UI Functions
        function showPortal() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('portal').classList.remove('hidden');
        }

        function showJobDetails(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            const modal = document.getElementById('jobModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Title</label>
                        <div class="mt-1 text-gray-900">${job.title}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Customer</label>
                        <div class="mt-1 text-gray-900">${job.customer}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address</label>
                        <div class="mt-1 text-gray-900">${job.address}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Scheduled</label>
                        <div class="mt-1 text-gray-900">${new Date(job.scheduledDate).toLocaleString()}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status</label>
                        <div class="mt-1">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${
                                job.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                job.status === 'in-progress' ? 'bg-green-100 text-green-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${job.status.replace('-', ' ').toUpperCase()}
                            </span>
                        </div>
                    </div>
                    ${job.notes ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                        <div class="mt-1 text-gray-900">${job.notes}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeJobModal() {
            document.getElementById('jobModal').classList.add('hidden');
        }

        // Report issue for specific job
        function reportIssueForJob(jobId) {
            const modal = document.getElementById('issueModal');
            const jobIdSelect = document.getElementById('issueJobId');
            
            // Set the specific job
            jobIdSelect.innerHTML = `<option value="${jobId}">${jobs.find(j => j.id === jobId)?.title || jobId}</option>`;
            jobIdSelect.value = jobId;
            
            modal.classList.remove('hidden');
        }

        function closeIssueModal() {
            document.getElementById('issueModal').classList.add('hidden');
            // Reset form
            document.getElementById('issueJobId').value = '';
            document.getElementById('issueCategory').value = 'manufacturer';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issuePhotos').value = '';
        }

        function previousWeek() {
            currentWeekOffset--;
            // loadJobs(); // Disabled - causing null uid error
            console.log('üìÖ Previous week navigation disabled');
        }

        function nextWeek() {
            currentWeekOffset++;
            // loadJobs(); // Disabled - causing null uid error
            console.log('üìÖ Next week navigation disabled');
        }

        function updateWeekRange() {
            const today = new Date();
            const weekStart = new Date(today.getTime() + (currentWeekOffset * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + (6 * 24 * 60 * 60 * 1000));
            
            document.getElementById('weekRange').textContent = 
                `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
        }

        function showError(message) {
            alert(`Error: ${message}`);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }
    </script>
</body>
</html>
